<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Pro Workspace - TV App</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <style>
        :root {
            --bg-base: #0f172a;
            --bg-surface: #1e293b;
            --bg-surface-hover: #334155;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --success: #10b981;
            --warning: #f59e0b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --radius-md: 8px;
            --radius-lg: 12px;
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-base);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header h1 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-menu {
            padding: 15px 10px;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .nav-item {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.95rem;
            font-weight: 500;
            padding: 12px 15px;
            border-radius: var(--radius-md);
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
        .nav-item.active { background: rgba(59, 130, 246, 0.15); color: var(--primary); border-right: 3px solid var(--primary); border-radius: 8px 0 0 8px;}

        /* --- Main Content --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .topbar {
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .view-section { display: none; animation: fadeIn 0.4s ease; max-width: 1000px; margin: 0 auto; }
        .view-section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Cards & Grid --- */
        .grid-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .stat-value { font-size: 2rem; font-weight: 700; color: var(--text-main); margin: 10px 0 5px 0; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;}

        /* --- Forms & Inputs --- */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; color: var(--text-main); }
        .form-group .hint { display: block; font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }
        
        .input-control {
            width: 100%; padding: 10px 15px; border-radius: var(--radius-md);
            border: 1px solid var(--border); background: var(--bg-base);
            color: var(--text-main); font-family: inherit; font-size: 0.95rem;
            outline: none; transition: border-color 0.2s;
        }
        .input-control:focus { border-color: var(--primary); }

        .row-flex { display: flex; gap: 15px; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.05);}
        .row-flex:last-child { border-bottom: none; }

        /* --- Toggles & Colors --- */
        input[type="color"] { -webkit-appearance: none; border: none; width: 45px; height: 45px; border-radius: var(--radius-md); cursor: pointer; background: none; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 2px solid var(--border); border-radius: var(--radius-md); }

        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-base); border: 1px solid var(--border); transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: var(--text-muted); transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: rgba(59, 130, 246, 0.2); border-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); background-color: var(--primary); }

        /* --- Buttons --- */
        .btn {
            padding: 10px 20px; border-radius: var(--radius-md); font-weight: 600; font-size: 0.9rem;
            cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.2s; border: 1px solid transparent; font-family: inherit;
        }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: var(--bg-surface-hover); border-color: var(--border); color: var(--text-main); }
        .btn-secondary:hover { background: #475569; }
        .btn-danger { background: rgba(239, 68, 68, 0.1); border-color: var(--danger); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-warning { background: rgba(245, 158, 11, 0.1); border-color: var(--warning); color: var(--warning); }
        .btn-warning:hover { background: var(--warning); color: black; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-block { width: 100%; }

        /* --- Tables --- */
        .table-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: var(--radius-md); background: var(--bg-base); }
        table { width: 100%; border-collapse: collapse; text-align: left; font-size: 0.85rem; }
        th { background: rgba(255,255,255,0.02); padding: 12px 15px; color: var(--text-muted); font-weight: 600; border-bottom: 1px solid var(--border); white-space: nowrap; }
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); vertical-align: middle; color: var(--text-main); }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.02); }
        .mono { font-family: 'Fira Code', monospace; font-size: 0.8rem; }
        .badge { background: var(--bg-surface-hover); padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; border: 1px solid var(--border); }

        /* --- Code Editor --- */
        .code-editor {
            width: 100%; height: 300px; background: #000; border: 1px solid var(--border);
            color: #32d74b; padding: 15px; border-radius: var(--radius-md);
            font-family: 'Fira Code', monospace; font-size: 0.85rem;
            resize: vertical; outline: none; line-height: 1.5; tab-size: 4;
        }
        .code-editor:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

        /* --- Progress Bar --- */
        .progress-container { width: 100%; background: var(--bg-base); border-radius: 10px; height: 10px; border: 1px solid var(--border); overflow: hidden; margin-top: 10px; }
        .progress-bar { height: 100%; background: var(--primary); transition: width 0.4s ease; }

        /* --- Utils --- */
        .search-box { display: flex; gap: 10px; margin-bottom: 15px; }
        .section-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 20px; color: white; display: flex; justify-content: space-between; align-items: center;}
        
        #qr-container { background: white; padding: 20px; border-radius: var(--radius-lg); display: none; margin: 20px auto; width: fit-content; text-align: center; }
        #reader { width: 100%; border-radius: var(--radius-lg); overflow: hidden; display: none; margin-bottom: 15px; border: 2px solid var(--primary); }
        
        /* Toast */
        .toast-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 9999; }
        .toast {
            background: var(--bg-surface); border: 1px solid var(--border); color: white;
            padding: 12px 20px; border-radius: var(--radius-md); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 10px; font-size: 0.9rem;
            transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .toast.show { transform: translateX(0); }

        /* Mobile Adjustments */
        .menu-toggle { display: none; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -100%; height: 100%; z-index: 1000; box-shadow: 10px 0 15px rgba(0,0,0,0.5); }
            .sidebar.open { left: 0; }
            .menu-toggle { display: block; }
            .grid-cards { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>‚öôÔ∏è Admin Pro</h1>
            <button class="menu-toggle" onclick="toggleSidebar()" style="font-size: 1rem;">‚úñ</button>
        </div>
        <nav class="nav-menu">
            <button class="nav-item active" onclick="switchView('dashboard')">üìä Dashboard</button>
            <button class="nav-item" onclick="switchView('ui')">üé® Interfaz y Tema</button>
            <button class="nav-item" onclick="switchView('events')">üóìÔ∏è Visor de Eventos</button>
            <button class="nav-item" onclick="switchView('links')">üîó Gestor AceStream</button>
            <button class="nav-item" onclick="switchView('rating')">‚≠ê Motor de Reputaci√≥n</button>
            <button class="nav-item" onclick="switchView('sessions')">‚è±Ô∏è Sesiones e Historial</button>
            <button class="nav-item" onclick="switchView('data')">üíæ Almacenamiento Local</button>
            <button class="nav-item" onclick="switchView('sync')">üîÑ Sincronizaci√≥n</button>
            <button class="nav-item" onclick="switchView('dev')" style="color: var(--warning);">üõ†Ô∏è Dev Tools (Raw)</button>
        </nav>
        <div style="padding: 20px; border-top: 1px solid var(--border);">
            <button class="btn btn-secondary btn-block" onclick="window.location.href='index.html'">‚óÄ Volver a la App</button>
        </div>
    </aside>

    <main class="main-content">
        <header class="topbar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                <h2 id="view-title" style="font-size: 1.1rem; font-weight: 600;">Dashboard General</h2>
            </div>
            <span class="badge mono" id="app-version">Index v2 Core</span>
        </header>

        <div class="content-area">
            
            <section id="view-dashboard" class="view-section active">
                <div class="grid-cards">
                    <div class="card">
                        <div class="stat-label">Eventos en Cach√©</div>
                        <div class="stat-value" id="dash-events">0</div>
                        <div class="stat-label" style="font-size: 0.7rem;">En event_data_cache</div>
                    </div>
                    <div class="card">
                        <div class="stat-label">Enlaces AceStream</div>
                        <div class="stat-value" id="dash-links">0</div>
                        <div class="stat-label" style="font-size: 0.7rem;">IDs √∫nicos cacheados</div>
                    </div>
                    <div class="card">
                        <div class="stat-label">Registros de Reputaci√≥n</div>
                        <div class="stat-value" id="dash-ratings">0</div>
                        <div class="stat-label" style="font-size: 0.7rem;">Canales evaluados</div>
                    </div>
                    <div class="card">
                        <div class="stat-label">Uso de LocalStorage</div>
                        <div class="stat-value" id="dash-storage">0 KB</div>
                        <div class="progress-container"><div class="progress-bar" id="dash-storage-bar" style="width: 0%"></div></div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 style="margin-bottom: 15px;">Acciones R√°pidas</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="switchView('sync')">Exportar Configuraci√≥n</button>
                        <button class="btn btn-danger" onclick="CacheMgr.clearTempSessions()">Limpiar Variables Temporales</button>
                        <button class="btn btn-secondary" onclick="location.reload()">Refrescar Admin</button>
                    </div>
                </div>
            </section>

            <section id="view-ui" class="view-section">
                <div class="card">
                    <h3 class="section-title">Personalizaci√≥n Visual</h3>
                    
                    <div class="row-flex">
                        <div>
                            <label style="font-weight: 600;">Color de Acento Principal</label>
                            <span class="form-group hint">Color para botones, iconos de carga y bordes activos.</span>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="colorHex" class="input-control mono" style="width: 100px; text-align: center;" readonly>
                            <input type="color" id="accentColorPicker" onchange="UIMgr.updateAccent(this.value)">
                        </div>
                    </div>

                    <div class="row-flex">
                        <div>
                            <label style="font-weight: 600;">Mostrar Logos de Canales</label>
                            <span class="form-group hint">Variable 'settings_show_logos' (Requiere soporte en index.html).</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="showLogosToggle" onchange="UIMgr.updateLogoToggle(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                        <button class="btn btn-secondary" onclick="UIMgr.resetTheme()">‚Ü∫ Restaurar Valores por Defecto</button>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h3 class="section-title">Inyecci√≥n de CSS <span class="badge">Avanzado</span></h3>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 15px;">Guarda CSS personalizado en `admin_custom_css`. Puedes programar tu index.html para leer esta llave y aplicarla al vuelo.</p>
                    <textarea id="customCssInput" class="code-editor" placeholder="/* Escribe tu CSS aqu√≠ */&#10;.event-card { border-radius: 15px; }"></textarea>
                    <button class="btn btn-primary btn-block" style="margin-top: 15px;" onclick="UIMgr.saveCustomCSS()">üíæ Guardar CSS Injectado</button>
                </div>
            </section>

            <section id="view-events" class="view-section">
                <div class="card">
                    <h3 class="section-title">Eventos Cacheados <span class="badge" id="event-count">0</span></h3>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 15px;">Datos parseados extra√≠dos de la fuente y listos para mostrar.</p>
                    
                    <div class="search-box">
                        <input type="text" id="searchEvents" class="input-control" placeholder="Buscar por competici√≥n o equipo..." onkeyup="EventsMgr.filter()">
                    </div>

                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha y Hora</th>
                                    <th>Competici√≥n</th>
                                    <th>Detalles (InfoHtml crudo)</th>
                                    <th>Canales (Array)</th>
                                </tr>
                            </thead>
                            <tbody id="eventsTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="view-links" class="view-section">
                <div class="card">
                    <h3 class="section-title">Base de Datos de Enlaces <button class="btn btn-danger btn-sm" onclick="LinksMgr.clearAll()">üóëÔ∏è Borrar Cach√©</button></h3>
                    <div class="search-box">
                        <input type="text" id="searchLinks" class="input-control" placeholder="Buscar canal..." onkeyup="LinksMgr.filter()">
                    </div>

                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nombre del Canal</th>
                                    <th>ID AceStream</th>
                                    <th>Fuente</th>
                                    <th>Test</th>
                                </tr>
                            </thead>
                            <tbody id="linksTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="view-rating" class="view-section">
                <div class="card">
                    <h3 class="section-title">Inteligencia de Canales (Reputaci√≥n) <button class="btn btn-danger btn-sm" onclick="RatingMgr.resetAll()">‚ôªÔ∏è Reiniciar Todo</button></h3>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 15px;">Ajusta manualmente la reputaci√≥n que la app ha aprendido sobre cada ID.</p>
                    
                    <div class="search-box">
                        <input type="text" id="searchRatings" class="input-control" placeholder="Buscar canal por nombre..." onkeyup="RatingMgr.filter()">
                    </div>
                    
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Canal / ID</th>
                                    <th style="text-align: center;">Puntuaci√≥n (1-5)</th>
                                    <th style="text-align: right;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="ratingsTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="view-sessions" class="view-section">
                <div class="card">
                    <h3 class="section-title">Historial de Reproducci√≥n <button class="btn btn-warning btn-sm" onclick="SessionMgr.clearAll()">üßπ Limpiar Todo</button></h3>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 15px;">La app recuerda qu√© canal probaste por √∫ltima vez (last_idx_) y cu√°ndo (last_ts_) para la funci√≥n "Siguiente mejor enlace".</p>
                    
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Canal Normalizado</th>
                                    <th>√öltimo √çndice Probado</th>
                                    <th>Hace cu√°nto tiempo</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="sessionsTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="view-data" class="view-section">
                <div class="card">
                    <h3 class="section-title">Gestor de Memoria (LocalStorage)</h3>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 15px;">Desglose exacto de lo que ocupa la aplicaci√≥n en la memoria del navegador.</p>
                    
                    <div id="cacheListContainer">
                        </div>

                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px dashed var(--danger);">
                        <h4 style="color: var(--danger); margin-bottom: 10px;">Zona de Riesgo Extremo</h4>
                        <button class="btn btn-danger btn-block" onclick="CacheMgr.factoryReset()">‚ö†Ô∏è FACTORY RESET (Eliminar Toda la Base de Datos)</button>
                    </div>
                </div>
            </section>

            <section id="view-sync" class="view-section">
                <div class="grid-cards">
                    <div class="card">
                        <h3 style="margin-bottom: 15px; color: var(--primary);">üì≤ Sincronizaci√≥n QR Ligeras</h3>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px;">Transfiere ajustes visuales y la base de reputaci√≥n entre m√≥viles escaneando este c√≥digo.</p>
                        
                        <div id="reader"></div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" style="flex: 1;" onclick="SyncMgr.generateQR()">Generar QR</button>
                            <button class="btn btn-success" style="flex: 1;" onclick="SyncMgr.startScanner()">Escanear QR</button>
                        </div>
                        <div id="qr-container">
                            <div id="qrcode"></div>
                            <p style="color: black; font-size: 0.8rem; font-weight: bold; margin-top: 10px;">Apunta tu c√°mara aqu√≠</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom: 15px; color: var(--success);">üíæ Backup F√≠sico Completo</h3>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px;">Descarga un archivo JSON con el 100% de la configuraci√≥n, historiales y cach√©s para guardarlo de forma segura.</p>
                        
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-secondary" onclick="SyncMgr.exportJSON()">Descargar Archivo (.json)</button>
                            <label class="btn btn-primary" style="margin: 0; text-align: center; cursor: pointer;">
                                Importar Archivo
                                <input type="file" accept=".json" style="display: none;" onchange="SyncMgr.importJSON(event)">
                            </label>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-dev" class="view-section">
                <div class="card" style="border-color: var(--warning);">
                    <div class="section-title" style="color: var(--warning);">
                        Editor JSON Crudo (Modo Dios)
                        <button class="btn btn-secondary btn-sm" onclick="DevMgr.loadRaw()">‚Üª Recargar</button>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 15px;">Modifica cualquier variable de la aplicaci√≥n en formato JSON puro. Un error de sintaxis corromper√° la app.</p>
                    
                    <textarea id="rawStorageEditor" class="code-editor" style="height: 450px;"></textarea>
                    
                    <button class="btn btn-warning btn-block" style="margin-top: 15px; color: black;" onclick="DevMgr.saveRaw()">‚ö†Ô∏è Sobrescribir Base de Datos Completa</button>
                </div>
            </section>

        </div>
    </main>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // --- Core Utilities ---
        const Utils = {
            toast: (msg, type = 'success') => {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = 'toast';
                const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è';
                if (type === 'error') toast.style.borderLeft = '4px solid var(--danger)';
                if (type === 'warning') toast.style.borderLeft = '4px solid var(--warning)';
                if (type === 'success') toast.style.borderLeft = '4px solid var(--success)';
                
                toast.innerHTML = `<span>${icon}</span> <span>${msg}</span>`;
                container.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },
            getSize: (str) => new Blob([str]).size,
            formatSize: (bytes) => {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / 1048576).toFixed(2) + ' MB';
            },
            escapeHTML: (str) => {
                return str.replace(/[&<>'"]/g, tag => ({
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
                }[tag]));
            },
            timeAgo: (ts) => {
                const seconds = Math.floor((Date.now() - ts) / 1000);
                if (seconds < 60) return seconds + " segs";
                if (seconds < 3600) return Math.floor(seconds/60) + " mins";
                if (seconds < 86400) return Math.floor(seconds/3600) + " horas";
                return Math.floor(seconds/86400) + " d√≠as";
            }
        };

        // --- Navigation ---
        const titles = {
            'dashboard': 'Dashboard General', 'ui': 'Interfaz y Tema', 'events': 'Visor de Eventos',
            'links': 'Gestor AceStream', 'rating': 'Motor de Reputaci√≥n', 'sessions': 'Historial de Sesiones',
            'data': 'Almacenamiento Local', 'sync': 'Sincronizaci√≥n', 'dev': 'Herramientas de Desarrollador'
        };

        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`view-${viewId}`).classList.add('active');
            document.querySelector(`.nav-item[onclick="switchView('${viewId}')"]`).classList.add('active');
            document.getElementById('view-title').textContent = titles[viewId] || 'Workspace';

            if(window.innerWidth <= 768) toggleSidebar(); // auto-close on mobile

            // Initialize specific managers
            if(viewId === 'dashboard') DashboardMgr.init();
            if(viewId === 'ui') UIMgr.init();
            if(viewId === 'events') EventsMgr.render();
            if(viewId === 'links') LinksMgr.render();
            if(viewId === 'rating') RatingMgr.render();
            if(viewId === 'sessions') SessionMgr.render();
            if(viewId === 'data') CacheMgr.render();
            if(viewId === 'dev') DevMgr.loadRaw();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // --- Modules ---

        const DashboardMgr = {
            init: () => {
                const events = JSON.parse(localStorage.getItem('event_data_cache')) || [];
                document.getElementById('dash-events').textContent = events.length;

                const ace = JSON.parse(localStorage.getItem('ace_ids_cache')) || { data: [] };
                const linksCount = Array.isArray(ace) ? ace.length : (ace.data ? ace.data.length : 0);
                document.getElementById('dash-links').textContent = linksCount;

                const ratings = JSON.parse(localStorage.getItem('ace_autorating_v1')) || {};
                document.getElementById('dash-ratings').textContent = Object.keys(ratings).length;

                let totalBytes = 0;
                for(let key in localStorage) {
                    if(localStorage.hasOwnProperty(key)) totalBytes += Utils.getSize(localStorage[key]);
                }
                document.getElementById('dash-storage').textContent = Utils.formatSize(totalBytes);
                
                // Chrome max localstorage is typically 5MB
                const percent = Math.min(100, (totalBytes / (5 * 1024 * 1024)) * 100);
                const bar = document.getElementById('dash-storage-bar');
                bar.style.width = percent + '%';
                bar.style.backgroundColor = percent > 80 ? 'var(--danger)' : percent > 50 ? 'var(--warning)' : 'var(--primary)';
            }
        };

        const UIMgr = {
            init: () => {
                const savedColor = localStorage.getItem('custom_accent_color') || '#3b82f6';
                document.getElementById('accentColorPicker').value = savedColor;
                document.getElementById('colorHex').value = savedColor.toUpperCase();
                
                const showLogos = localStorage.getItem('settings_show_logos') !== 'false';
                document.getElementById('showLogosToggle').checked = showLogos;

                const customCSS = localStorage.getItem('admin_custom_css') || '';
                document.getElementById('customCssInput').value = customCSS;
            },
            updateAccent: (color) => {
                localStorage.setItem('custom_accent_color', color);
                document.getElementById('colorHex').value = color.toUpperCase();
                Utils.toast('Color primario guardado');
            },
            updateLogoToggle: (checked) => {
                localStorage.setItem('settings_show_logos', checked);
                Utils.toast(checked ? 'Logos habilitados' : 'Logos ocultados');
            },
            saveCustomCSS: () => {
                const css = document.getElementById('customCssInput').value;
                localStorage.setItem('admin_custom_css', css);
                Utils.toast('CSS Inyectado con √©xito');
            },
            resetTheme: () => {
                localStorage.removeItem('custom_accent_color');
                localStorage.removeItem('settings_show_logos');
                localStorage.removeItem('admin_custom_css');
                UIMgr.init();
                Utils.toast('Tema reiniciado');
            }
        };

        const EventsMgr = {
            render: () => {
                const data = JSON.parse(localStorage.getItem('event_data_cache')) || [];
                document.getElementById('event-count').textContent = data.length;
                const tbody = document.getElementById('eventsTableBody');
                tbody.innerHTML = '';

                if(data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:var(--text-muted);">No hay eventos en cach√©</td></tr>`;
                    return;
                }

                data.forEach(item => {
                    const cleanHtml = item.infoHtml ? item.infoHtml.replace(/<[^>]*>?/gm, ' ') : 'N/A';
                    tbody.innerHTML += `
                        <tr class="searchable-row" data-search="${(item.competition + ' ' + cleanHtml).toLowerCase()}">
                            <td><span class="badge">${item.fecha}</span><br><b>${item.hora}</b></td>
                            <td style="color: var(--primary); font-weight: 500;">${item.competition}</td>
                            <td style="font-size: 0.75rem; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${Utils.escapeHTML(item.infoHtml)}">${Utils.escapeHTML(cleanHtml)}</td>
                            <td><span class="badge" style="background:var(--bg-surface);">${item.canales ? item.canales.length : 0} refs</span></td>
                        </tr>
                    `;
                });
            },
            filter: () => {
                const term = document.getElementById('searchEvents').value.toLowerCase();
                document.querySelectorAll('#eventsTableBody .searchable-row').forEach(row => {
                    row.style.display = row.dataset.search.includes(term) ? '' : 'none';
                });
            }
        };

        const LinksMgr = {
            render: () => {
                const cacheObj = JSON.parse(localStorage.getItem('ace_ids_cache')) || { data: [] };
                const data = Array.isArray(cacheObj) ? cacheObj : (cacheObj.data || []);
                const tbody = document.getElementById('linksTableBody');
                tbody.innerHTML = '';

                if(data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:var(--text-muted);">Sin enlaces cacheados</td></tr>`;
                    return;
                }

                data.forEach(item => {
                    tbody.innerHTML += `
                        <tr class="searchable-row" data-search="${(item.name).toLowerCase()}">
                            <td style="font-weight: 600;">${item.name}</td>
                            <td class="mono" style="color: var(--text-muted);">${item.id}</td>
                            <td><span class="badge">${item.source || 'Desconocido'}</span></td>
                            <td><a href="acestream://${item.id}" class="btn btn-primary btn-sm" style="text-decoration:none;">Probar</a></td>
                        </tr>
                    `;
                });
            },
            filter: () => {
                const term = document.getElementById('searchLinks').value.toLowerCase();
                document.querySelectorAll('#linksTableBody .searchable-row').forEach(row => {
                    row.style.display = row.dataset.search.includes(term) ? '' : 'none';
                });
            },
            clearAll: () => {
                if(confirm("¬øEliminar todos los enlaces? La app los descargar√° nuevamente en el pr√≥ximo inicio.")) {
                    localStorage.removeItem('ace_ids_cache');
                    LinksMgr.render();
                    Utils.toast('Cach√© de enlaces eliminada');
                }
            }
        };

        const RatingMgr = {
            db: {},
            render: () => {
                RatingMgr.db = JSON.parse(localStorage.getItem('ace_autorating_v1')) || {};
                const tbody = document.getElementById('ratingsTableBody');
                tbody.innerHTML = '';
                
                const entries = Object.entries(RatingMgr.db);
                if(entries.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:var(--text-muted);">El motor a√∫n no tiene datos de aprendizaje.</td></tr>`;
                    return;
                }

                // Sort by score descending
                entries.sort((a, b) => {
                    const scoreA = typeof a[1] === 'object' ? a[1].score : a[1];
                    const scoreB = typeof b[1] === 'object' ? b[1].score : b[1];
                    return scoreB - scoreA;
                });

                entries.forEach(([id, data]) => {
                    const name = typeof data === 'object' ? (data.name || 'Desconocido') : 'Desconocido';
                    const score = typeof data === 'object' ? data.score : data;
                    const safeName = name.replace(/'/g, "&apos;");
                    
                    let color = score >= 4 ? 'var(--success)' : score <= 2 ? 'var(--danger)' : 'var(--warning)';

                    tbody.innerHTML += `
                        <tr class="searchable-row" data-search="${name.toLowerCase()}">
                            <td>
                                <b>${name}</b><br>
                                <span class="mono" style="font-size:0.7rem; color:var(--text-muted);">${id.substring(0,18)}...</span>
                            </td>
                            <td style="text-align:center;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                                    <input type="number" step="0.1" min="1" max="5" value="${parseFloat(score).toFixed(1)}" 
                                        class="input-control mono" id="score_${id}" style="width: 70px; text-align: center; color: ${color}; font-weight: bold; padding: 5px;">
                                    <span style="color: ${color}">‚òÖ</span>
                                </div>
                            </td>
                            <td style="text-align:right;">
                                <button class="btn btn-secondary btn-sm" onclick="RatingMgr.save('${id}', '${safeName}')">üíæ Guardar</button>
                                <button class="btn btn-danger btn-sm" onclick="RatingMgr.delete('${id}')">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            },
            filter: () => {
                const term = document.getElementById('searchRatings').value.toLowerCase();
                document.querySelectorAll('#ratingsTableBody .searchable-row').forEach(row => {
                    row.style.display = row.dataset.search.includes(term) ? '' : 'none';
                });
            },
            save: (id, name) => {
                const newScore = parseFloat(document.getElementById('score_' + id).value);
                if(isNaN(newScore) || newScore < 1 || newScore > 5) return Utils.toast('Valor debe ser entre 1.0 y 5.0', 'error');
                RatingMgr.db[id] = { name: name, score: newScore };
                localStorage.setItem('ace_autorating_v1', JSON.stringify(RatingMgr.db));
                RatingMgr.render(); // Re-render for color update
                Utils.toast('Puntuaci√≥n ajustada');
            },
            delete: (id) => {
                if(confirm('¬øOlvidar lo aprendido para este ID?')) {
                    delete RatingMgr.db[id];
                    localStorage.setItem('ace_autorating_v1', JSON.stringify(RatingMgr.db));
                    RatingMgr.render();
                    Utils.toast('Registro eliminado');
                }
            },
            resetAll: () => {
                if(confirm('¬°ATENCI√ìN! Esto borrar√° TODO el historial de aprendizaje del motor. ¬øEst√°s seguro?')) {
                    localStorage.removeItem('ace_autorating_v1');
                    RatingMgr.render();
                    Utils.toast('Motor de reputaci√≥n reseteado', 'warning');
                }
            }
        };

        const SessionMgr = {
            render: () => {
                const tbody = document.getElementById('sessionsTableBody');
                tbody.innerHTML = '';
                let hasData = false;

                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('last_idx_')) {
                        hasData = true;
                        const channelName = key.replace('last_idx_', '');
                        const idx = localStorage.getItem(key);
                        const ts = localStorage.getItem('last_ts_' + channelName);
                        const timeStr = ts ? Utils.timeAgo(parseInt(ts)) : 'Desconocido';

                        tbody.innerHTML += `
                            <tr>
                                <td style="font-weight: 500; color: var(--primary);">${channelName.toUpperCase()}</td>
                                <td><span class="badge" style="background:var(--bg-surface); font-size: 1rem;">${idx}</span></td>
                                <td>${timeStr}</td>
                                <td><button class="btn btn-danger btn-sm" onclick="SessionMgr.delete('${channelName}')">Borrar Historial</button></td>
                            </tr>
                        `;
                    }
                });

                if (!hasData) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:var(--text-muted);">No hay sesiones guardadas.</td></tr>`;
                }
            },
            delete: (channelName) => {
                localStorage.removeItem('last_idx_' + channelName);
                localStorage.removeItem('last_ts_' + channelName);
                SessionMgr.render();
                Utils.toast(`Historial de ${channelName} eliminado`);
            },
            clearAll: () => {
                if(confirm("¬øLimpiar todo el historial de reproducci√≥n r√°pido?")) {
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('last_idx_') || key.startsWith('last_ts_')) {
                            localStorage.removeItem(key);
                        }
                    });
                    SessionMgr.render();
                    Utils.toast('Sesiones limpiadas');
                }
            }
        };

        const CacheMgr = {
            render: () => {
                const container = document.getElementById('cacheListContainer');
                container.innerHTML = '';
                
                const knownKeys = {
                    'event_data_cache': { name: 'Eventos TV', desc: 'JSON de la programaci√≥n extra√≠da' },
                    'ace_ids_cache': { name: 'Enlaces AceStream', desc: 'IDs crudos cacheados' },
                    'logo_cache': { name: 'Cach√© de Logos', desc: 'Mapeo de nombres a URLs de GitHub' },
                    'ace_autorating_v1': { name: 'Base de Datos Rating', desc: 'Puntuaciones de inteligencia' }
                };

                let otherKeysCount = 0;
                let otherKeysSize = 0;

                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const val = localStorage.getItem(key);
                    const size = Utils.getSize(val);
                    const fSize = Utils.formatSize(size);

                    if (knownKeys[key]) {
                        container.innerHTML += `
                            <div class="row-flex" style="background: var(--bg-surface-hover); padding: 15px; border-radius: var(--radius-md); margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: 600; color: white;">${knownKeys[key].name} <span class="badge mono" style="margin-left:5px;">${key}</span></div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">${knownKeys[key].desc} | Peso: <b>${fSize}</b></div>
                                </div>
                                <button class="btn btn-danger btn-sm" onclick="CacheMgr.deleteKey('${key}')">Eliminar</button>
                            </div>
                        `;
                    } else {
                        otherKeysCount++;
                        otherKeysSize += size;
                    }
                }

                if (otherKeysCount > 0) {
                    container.innerHTML += `
                        <div class="row-flex" style="margin-top: 20px;">
                            <div>
                                <div style="font-weight: 600;">Otras variables menores</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">${otherKeysCount} items (sesiones, colores, busquedas) | Peso: ${Utils.formatSize(otherKeysSize)}</div>
                            </div>
                        </div>
                    `;
                }
            },
            deleteKey: (key) => {
                if(confirm(`¬øBorrar la llave ${key}?`)) {
                    localStorage.removeItem(key);
                    CacheMgr.render();
                    Utils.toast('Llave eliminada');
                }
            },
            clearTempSessions: () => {
                Object.keys(localStorage).forEach(k => {
                    if(k.startsWith('last_idx_') || k.startsWith('last_ts_') || k === 'search_query' || k === 'ace_current_session') {
                        localStorage.removeItem(k);
                    }
                });
                Utils.toast('Sesiones y b√∫squedas temporales limpiadas');
            },
            factoryReset: () => {
                if(confirm("¬°ATENCI√ìN! Vas a vaciar el LocalStorage por completo. La app volver√° al estado de instalaci√≥n limpia. ¬øContinuar?")) {
                    localStorage.clear();
                    Utils.toast('FACTORY RESET COMPLETADO', 'warning');
                    setTimeout(() => location.reload(), 1500);
                }
            }
        };

        let html5QrCode;
        const SyncMgr = {
            generateQR: () => {
                const qrContainer = document.getElementById('qr-container');
                const qrDiv = document.getElementById('qrcode');
                qrDiv.innerHTML = "";
                qrContainer.style.display = 'block';
                document.getElementById('reader').style.display = 'none';

                // Solo sincronizamos lo esencial (Config visual y Rating)
                const config = {
                    ui_accent: localStorage.getItem('custom_accent_color'),
                    ui_logos: localStorage.getItem('settings_show_logos'),
                    ratings: JSON.parse(localStorage.getItem('ace_autorating_v1')) || {}
                };

                const dataString = JSON.stringify(config);
                if (dataString.length > 2500) {
                    Utils.toast('Tu base de Rating es muy grande para un QR. Usa el Backup f√≠sico.', 'error');
                    qrContainer.style.display = 'none';
                    return;
                }

                new QRCode(qrDiv, { text: dataString, width: 220, height: 220, correctLevel : QRCode.CorrectLevel.L });
            },
            startScanner: () => {
                const readerDiv = document.getElementById('reader');
                readerDiv.style.display = 'block';
                document.getElementById('qr-container').style.display = 'none';
                
                if(html5QrCode) {
                    html5QrCode.clear();
                }

                html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, 
                    (decodedText) => {
                        html5QrCode.stop().then(() => {
                            readerDiv.style.display = 'none';
                            try {
                                const data = JSON.parse(decodedText);
                                if (data.ui_accent || data.ratings) {
                                    if(confirm("Se detect√≥ configuraci√≥n v√°lida. ¬øSobrescribir los ajustes actuales?")) {
                                        if (data.ui_accent) localStorage.setItem('custom_accent_color', data.ui_accent);
                                        if (data.ui_logos !== undefined) localStorage.setItem('settings_show_logos', data.ui_logos);
                                        if (data.ratings) localStorage.setItem('ace_autorating_v1', JSON.stringify(data.ratings));
                                        Utils.toast("Configuraci√≥n aplicada con √©xito");
                                    }
                                } else throw new Error();
                            } catch (e) {
                                Utils.toast("El QR no contiene datos de esta app", 'error');
                            }
                        });
                    }
                ).catch(err => Utils.toast("Error al abrir c√°mara: " + err, 'error'));
            },
            exportJSON: () => {
                const dump = JSON.stringify(localStorage, null, 2);
                const blob = new Blob([dump], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `TV_Index_Backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                Utils.toast('Backup JSON exportado');
            },
            importJSON: (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if(confirm(`¬øEst√°s seguro de restaurar este backup? Sobrescribir√° TODOS los datos actuales.`)) {
                            localStorage.clear();
                            Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
                            Utils.toast('Restauraci√≥n completa. Recargando...', 'success');
                            setTimeout(() => location.reload(), 1500);
                        }
                    } catch (error) {
                        Utils.toast('El archivo no es un JSON v√°lido', 'error');
                    }
                    event.target.value = '';
                };
                reader.readAsText(file);
            }
        };

        const DevMgr = {
            loadRaw: () => {
                document.getElementById('rawStorageEditor').value = JSON.stringify(localStorage, null, 4);
            },
            saveRaw: () => {
                try {
                    const rawStr = document.getElementById('rawStorageEditor').value;
                    const parsed = JSON.parse(rawStr); 
                    
                    if(confirm("CUIDADO: Est√°s sobrescribiendo la base de datos cruda. ¬øEst√°s seguro de que el formato es correcto?")) {
                        localStorage.clear();
                        Object.keys(parsed).forEach(k => {
                            let val = typeof parsed[k] === 'object' ? JSON.stringify(parsed[k]) : String(parsed[k]);
                            localStorage.setItem(k, val);
                        });
                        Utils.toast('¬°Base de datos inyectada con √©xito!', 'warning');
                    }
                } catch (e) {
                    Utils.toast('Error de sintaxis JSON. Revisa el c√≥digo.', 'error');
                }
            }
        };

        // Initialize default view
        document.addEventListener('DOMContentLoaded', () => {
            switchView('dashboard');
        });
    </script>
</body>
</html>
