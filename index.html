<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width,initial-scale=1.0,maximum-scale=1.6,user-scalable=no">
    <title>TV</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.8em%22 font-size=%2285%22>游닠</text></svg>">
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: rgba(37, 99, 235, 0.1);
            --primary-dark: #1e50c7;
            --bg-light: #f1f5f9;
            --card-bg: #ffffff;
            --text: #1e293b;
            --border-color: #e2e8f0;
            --white: #ffffff;
            --radius-md: 5px; /* Reducido a la mitad: 10px -> 5px */
            --radius-sm: 3px; /* Reducido a la mitad: 6px -> 3px */
            --shadow-sm: 0 0.5px 1.5px rgba(0, 0, 0, 0.1); /* Reducido a la mitad */
            --primary-rgb: 37, 99, 235;
            --secondary: #000000;
            --success: #4cc9f0;
            --warning: #f8961e;
            --info: #4895ef;
            --movistar-blue: #0085C1;
            --eurosport-blue: #5e17eb;
            --dazn-black: #000000;
            --f1-red: #ff3535;
            --action-red: #ff544d;
            --cinema-red: #fa3732;
            --sports-green: #11a45b;
            --vamos-green: #1fc23d;
            --copadelrey-green: #449653;
            --champions-teal: #52c29c;
            --liga-teal: #21ffb8;
            --hypermotion-cyan: #04d2d7;
            --golf-teal: #4ee1b0;
            --eurosport-number-red: #ff3535;
            --plus-blue: #3399ff;
            --western-red: #e60000;
            --documentary-purple: #a06cf5;
            --originals-blue: #3985b0;
            --ellas-green: #35fd9b;
            --series-orange: #ff8c1f;
            --gist-source-color: #2d077d;
            --elcano-source-color: #7d070e;
            --special-gist-color: #9c27b0;
            --events-source-color: #074f7d;
            --shickat-badge: #077b3b;
            --era-source-color: #f55d3e;
            --channel-name-color: #888888;
            --player-bg: black;
            --channel-number-color: #4b5563;
            /* NUEVOS ESTILOS PARA EL STAGE */
            --stage-bg: #1e1e1e; /* Fondo por defecto para el stage */
            --stage-overlay-color: rgba(0, 0, 0, 0.4);
            --stage-channel-name-color: #ffffff;
            --stage-text-color: #cccccc;
            --stage-live-color: #dc2626;
            --stage-upcoming-color: #3b82f6;
            --stage-finished-color: #888888;
        }

        body.dark-mode {
            --bg-light: #131313;
            --card-bg: #282828;
            --text: #f8fafc;
            --border-color: #555555;
            --shadow-sm: 0 0.5px 1.5px rgba(0, 0, 0, 0.3); /* Reducido a la mitad */
            --primary-light: rgba(var(--primary-rgb), 0.2);
            --channel-name-color: #e2e2ff;
            --player-bg: #1e1e1e;
            --channel-number-color: #b0b0b0;
            /* NUEVOS ESTILOS PARA EL STAGE (Modo Oscuro) */
            --stage-bg: #1e1e1e;
            --stage-overlay-color: rgba(0, 0, 0, 0.5);
        }

        body {
            /* Aplicamos los estilos de TV Mode al cuerpo por defecto */
            background: #151515 !important;
            color: #e0e0e0 !important;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            transition: all .3s
        }

        /* Eliminamos las clases de la interfaz normal (main-container, search-filters, filter-buttons, etc.) */

        .channel-card {
            /* No se usa en TV Mode, se mantiene por si se usa en alg칰n renderizado de prueba */
            min-width: 140px; /* Reducido a la mitad: 280px -> 140px */
            max-width: 140px; /* Reducido a la mitad: 280px -> 140px */
            flex: 0 0 auto;
            scroll-snap-align: start;
            background: var(--card-bg);
            border: 0.5px solid var(--border-color); /* Reducido a la mitad */
            border-radius: var(--radius-md);
            padding: 0.25rem 0.5rem 0.5rem 0.5rem; /* Reducido a la mitad */
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: all .2s;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center
        }

        /* ESTILOS DE NOTIFICACIONES (RESTAURADOS Y AJUSTADOS AL MODO TV) */
        .status-message {
            text-align: center;
            padding: 0.25rem; /* Reducido a la mitad: .5rem -> .25rem */
            font-size: .425rem; /* Reducido a la mitad: .85rem -> .425rem */
            background-color: rgba(76, 201, 240, .1);
            border-radius: var(--radius-sm);
            margin-bottom: 0.25rem; /* Reducido a la mitad: .5rem -> .25rem */
            opacity: 1;
            transition: all .5s ease-in-out, margin .5s ease-in-out;
            /* Estilos de centrado para Modo TV */
            margin-left: auto;
            margin-right: auto;
            max-width: 400px; /* Reducido a la mitad: 800px -> 400px */
            width: 90%;
            box-shadow: var(--shadow-sm);
            z-index: 50;
        }

        .status-message.hide {
            opacity: 0;
            transform: translateY(-10px); /* Reducido a la mitad: -20px -> -10px */
            pointer-events: none;
            margin-bottom: 0
        }

        .status-message.success {
            color: var(--primary);
            background-color: var(--primary-light)
        }

        .status-message.info {
            color: var(--primary);
            background-color: var(--primary-light)
        }

        .status-message.error {
            color: var(--text);
            background-color: rgba(247, 37, 133, .2);
        }

        .status-message.warning {
            color: var(--warning);
            background-color: rgba(248, 150, 30, .1)
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, .5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001
        }

        .modal--active {
            display: flex
        }

        .modal__content {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 0.6rem; /* Reducido a la mitad: 1.2rem -> 0.6rem */
            width: 90%;
            max-width: 175px; /* Reducido a la mitad: 350px -> 175px */
            box-shadow: var(--shadow-sm)
        }

        .modal__title {
            margin-bottom: 0.4rem; /* Reducido a la mitad: .8rem -> .4rem */
            color: var(--text);
            font-size: 0.55rem; /* Reducido a la mitad: 1.1rem -> 0.55rem */
            display: flex;
            align-items: center;
            gap: 4px; /* Reducido a la mitad: 8px -> 4px */
        }

        .modal__actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.3rem; /* Reducido a la mitad: .6rem -> .3rem */
            margin-top: 0.5rem; /* Reducido a la mitad: 1rem -> .5rem */
        }

        .modal__btn {
            padding: 0.25rem 0.4rem; /* Reducido a la mitad: .5rem .8rem -> .25rem .4rem */
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.45rem; /* Reducido a la mitad: .9rem -> .45rem */
            transition: all .2s
        }

        .modal__btn--primary {
            background: var(--primary);
            color: #fff
        }

        .modal__btn--primary:hover {
            background: var(--primary-dark)
        }

        .settings-section {
            margin-bottom: 0.6rem; /* Reducido a la mitad: 1.2rem -> 0.6rem */
            padding-bottom: 0.5rem; /* Reducido a la mitad: 1rem -> 0.5rem */
            border-bottom: 0.5px solid var(--border-color); /* Reducido a la mitad */
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0
        }

        .settings-section__title {
            font-size: 0.45rem; /* Reducido a la mitad: .9rem -> .45rem */
            color: var(--primary);
            margin-bottom: 0.4rem; /* Reducido a la mitad: .8rem -> .4rem */
            display: flex;
            align-items: center;
            gap: 4px; /* Reducido a la mitad: 8px -> 4px */
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem; /* Reducido a la mitad: .8rem -> .4rem */
            padding: 0.25rem; /* Reducido a la mitad: .5rem -> .25rem */
            border-radius: var(--radius-sm);
            transition: background .2s
        }

        .settings-item:hover {
            background: var(--primary-light)
        }

        .settings-item__info {
            display: flex;
            align-items: center;
            gap: 6px; /* Reducido a la mitad: 12px -> 6px */
            flex: 1
        }

        .settings-icon {
            font-size: 0.6rem; /* Reducido a la mitad: 1.2rem -> 0.6rem */
        }

        .settings-label {
            font-size: 0.45rem; /* Reducido a la mitad: .9rem -> .45rem */
            color: var(--text);
            font-weight: 500;
            display: block
        }

        .settings-description {
            font-size: 0.375rem; /* Reducido a la mitad: .75rem -> .375rem */
            color: var(--text);
            opacity: .7;
            display: block;
            margin-top: 1px; /* Reducido a la mitad: 2px -> 1px */
        }

        .settings-switch {
            position: relative;
            display: inline-block;
            width: 25px; /* Reducido a la mitad: 50px -> 25px */
            height: 12px; /* Reducido a la mitad: 24px -> 12px */
        }

        .settings-switch input {
            opacity: 0;
            width: 0;
            height: 0
        }

        .settings-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 12px; /* Reducido a la mitad: 24px -> 12px */
        }

        body.dark-mode .settings-slider {
            /* Nuevo: Color del slider inactivo en modo oscuro */
            background-color: #555555;
        }

        .settings-slider:before {
            position: absolute;
            content: "";
            height: 8px; /* Reducido a la mitad: 16px -> 8px */
            /* CORRECCI칍N: Se fija el ancho y alto del c칤rculo interior */
            width: 8px; /* Reducido a la mitad: 16px -> 8px */
            left: 2px; /* Reducido a la mitad: 4px -> 2px */
            bottom: 2px; /* Reducido a la mitad: 4px -> 2px */
            background-color: #fff;
            transition: .4s;
            border-radius: 50%
        }

        input:checked+.settings-slider {
            background-color: var(--primary)
        }

        input:checked+.settings-slider:before {
            transform: translateX(13px); /* Reducido a la mitad: 26px -> 13px */
        }
        
        .color-picker {
            display: flex;
            gap: 3px; /* Reducido a la mitad: 6px -> 3px */
        }

        .color-option {
            width: 12px; /* Reducido a la mitad: 24px -> 12px */
            height: 12px; /* Reducido a la mitad: 24px -> 12px */
            border-radius: 50%;
            border: 1px solid transparent; /* Reducido a la mitad: 2px -> 1px */
            cursor: pointer;
            transition: transform .2s
        }

        .color-option:hover {
            transform: scale(1.1)
        }

        .color-option.active {
            border-color: var(--text);
            transform: scale(1.1)
        }

        /* Mantenemos el ajuste de color de texto en modal para que se vea en modo oscuro */
        .modal__title, .channel-option-name, .settings-label {
            color: var(--text) !important;
        }
        .settings-description {
            color: var(--text) !important;
            opacity: .7 !important;
        }
        .settings-section__title {
            color: var(--primary) !important;
        }
        
        .degradado-comedia {
            background-image: linear-gradient(to right, #ff3c3c, orange);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700
        }

        .copy-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            border: 0.5px solid var(--border-color); /* Reducido a la mitad */
            border-radius: var(--radius-md);
            padding: 0.75rem; /* Reducido a la mitad: 1.5rem -> 0.75rem */
            box-shadow: 0 2px 6px rgba(0, 0, 0, .2); /* Reducido a la mitad */
            z-index: 2000;
            width: 90%;
            max-width: 160px; /* Reducido a la mitad: 320px -> 160px */
            display: none;
            flex-direction: column;
            align-items: center;
            text-align: center;
            animation: fadeIn .3s ease-out
        }

        .copy-modal.active {
            display: flex
        }

        .copy-modal-icon {
            font-size: 1.25rem; /* Reducido a la mitad: 2.5rem -> 1.25rem */
            margin-bottom: 0.4rem; /* Reducido a la mitad: .8rem -> .4rem */
        }

        .copy-modal-text {
            font-size: 0.475rem; /* Reducido a la mitad: .95rem -> .475rem */
            color: var(--text);
            margin-bottom: 0.5rem; /* Reducido a la mitad: 1rem -> .5rem */
        }

        .copy-modal-button {
            padding: 0.3rem 0.6rem; /* Reducido a la mitad: .6rem 1.2rem -> .3rem .6rem */
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.45rem; /* Reducido a la mitad: .9rem -> .45rem */
            font-weight: 600;
            transition: background .2s;
            margin-bottom: 0.25rem; /* Reducido a la mitad: .5rem -> .25rem */
        }

        .copy-modal-button:hover {
            background: var(--primary-dark)
        }

        .copy-modal-url {
            background-color: var(--bg-light);
            color: var(--text);
            padding: 0.25rem; /* Reducido a la mitad: .5rem -> .25rem */
            margin-bottom: 0.5rem; /* Reducido a la mitad: 1rem -> .5rem */
            border-radius: var(--radius-sm);
            font-family: monospace;
            word-break: break-all;
            font-size: 0.425rem; /* Reducido a la mitad: .85rem -> .425rem */
            display: block
        }

        body.dark-mode .copy-modal-url {
            background-color: var(--border-color)
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%)
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%)
            }
        }

        .copy-message {
            position: fixed;
            bottom: 10px; /* Reducido a la mitad: 20px -> 10px */
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: #fff;
            padding: 0.3rem 0.6rem; /* Reducido a la mitad: .6rem 1.2rem -> .3rem .6rem */
            border-radius: var(--radius-sm);
            font-size: 0.45rem; /* Reducido a la mitad: .9rem -> .45rem */
            z-index: 2001;
            opacity: 0;
            transition: opacity .4s ease-in-out
        }

        .copy-message.show {
            opacity: 1
        }
        
        .floating-save-button {
            display: none !important;
        }

        .live-time-blink {
            color: var(--primary) !important;
            animation: soft-blink 1.5s infinite ease-in-out;
            font-weight: 700
        }

        @keyframes soft-blink {
            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .5
            }
        }

        .live-separator {
            display: none;
        }

        .subgroup-title, .subgroup-content {
            display: none !important;
        }

        /* La clase tv-mode-active ya no es necesaria, ya que es el modo por defecto */
        .tv-mode-active {
            background: #151515 !important;
            color: #e0e0e0 !important;
        }

        /* INICIO DE LOS CAMBIOS (Modo TV) */

        #tvSidebar {
            background: #111111;
            color: #e0e0e0;
            padding: 0.75rem 0.25rem; /* Reducido a la mitad: 1.5rem 0.5rem -> 0.75rem 0.25rem */
            position: fixed;
            left: 0;
            top: 0;
            width: 50px; /* Reducido a la mitad: 100px -> 50px */
            height: 100vh;
            overflow-y: auto;
            border-right: 0.5px solid #383838; /* Reducido a la mitad */
            z-index: 100;
            display: flex;
            flex-direction: column;
            /* CAMBIO CLAVE: Centrar verticalmente el contenido */
            justify-content: center;
        }

        #tvSidebar .sidebar-logo {
            font-size: 0.5rem; /* Reducido a la mitad: 1rem -> 0.5rem */
            font-weight: 800;
            color: white;
            margin-bottom: 1rem; /* Reducido a la mitad: 2rem -> 1rem */
            padding-left: 2.5px; /* Reducido a la mitad: 5px -> 2.5px */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #tvSidebar input#tvSearch {
            width: 100%;
            padding: 4px 2.5px; /* Reducido a la mitad: 8px 5px -> 4px 2.5px */
            border-radius: 3px; /* Reducido a la mitad: 6px -> 3px */
            font-size: 0.4rem; /* Reducido a la mitad: 0.8rem -> 0.4rem */
            box-sizing: border-box;
            background-color: #383838;
            color: #ffffff;
            border: 0.5px solid #555555; /* Reducido a la mitad */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.4); /* Reducido a la mitad */
        }
        
        #tvSidebar input#tvSearch:focus {
            outline: none;
            border-color: var(--primary);
        }

        #tvSidebar .tv-nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 0; /* Reducido a la mitad: 8px 0 -> 4px 0 */
            border-radius: 3px; /* Reducido a la mitad: 6px -> 3px */
            color: #e0e0e0;
            text-decoration: none;
            font-weight: 600;
            transition: background-color 0.2s;
            text-align: center;
            font-size: 0.375rem; /* Reducido a la mitad: 0.75rem -> 0.375rem */
            line-height: 1.1;
        }

        #tvSidebar .tv-nav-link.brand-filter {
            padding: 2.5px 0; /* Reducido a la mitad: 5px 0 -> 2.5px 0 */
            margin: 2.5px auto; /* Reducido a la mitad: 5px auto -> 2.5px auto */
            justify-content: center;
            width: 100%; 
            height: auto; 
        }

        #tvSidebar .tv-nav-link.dazn-filter {
            width: 40px; /* Reducido a la mitad: 80px -> 40px */
            height: 24px; /* Reducido a la mitad: 48px -> 24px */
        }

        #tvSidebar .tv-nav-link.movistar-filter {
            width: 40px; /* Reducido a la mitad: 70px -> 35px */
            height: 16.5px; /* Reducido a la mitad: 33px -> 16.5px */
        }

        #tvSidebar .tv-nav-link.eurosport-filter {
            width: 40px; /* Reducido a la mitad: 80px -> 40px */
            height: 24px; /* Reducido a la mitad: 38px -> 19px */
        }

        #tvSidebar .tv-nav-link.brand-filter img {
            max-width: 90%;
            max-height: 90%;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        #tvSidebar .tv-nav-link.sport-filter {
            font-size: 0.6rem; /* Reducido a la mitad: 1.2rem -> 0.6rem */
            padding: 5px 0; /* Reducido a la mitad: 10px 0 -> 5px 0 */
            height: 10px; /* Reducido a la mitad: 20px -> 10px */
            width: 20px; /* Reducido a la mitad: 40px -> 20px */
            border-radius: 50%;
            margin: 0 2.5px; /* Reducido a la mitad: 0 5px -> 0 2.5px */
        }

        #tvSportFilters {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2.5px; /* Reducido a la mitad: 5px -> 2.5px */
            padding: 2.5px 0; /* Reducido a la mitad: 5px 0 -> 2.5px 0 */
            margin-bottom: 0.25rem; /* Reducido a la mitad: 0.5rem -> 0.25rem */
            border-bottom: 0.5px solid #383838; /* Reducido a la mitad */
            border-top: 0.5px solid #383838; /* Reducido a la mitad */
        }

        #tvSidebar .tv-nav-link span {
            margin-right: 0 !important;
            margin-bottom: 1.5px; /* Reducido a la mitad: 3px -> 1.5px */
            font-size: 0.55rem !important; /* Reducido a la mitad: 1.1rem -> 0.55rem */
        }

        #tvSidebar .tv-nav-link:hover,
        #tvSidebar .tv-nav-link.focused-link {
            background-color: #2d2d2d;
        }

        .tv-sidebar-link-focused {
            background-color: var(--primary) !important;
            border: 1px solid white; /* Reducido a la mitad: 2px -> 1px */
            outline-offset: 1px; /* Reducido a la mitad: 2px -> 1px */
            transform: scale(1.02);
        }

        #tvMainContent {
            margin-left: 50px; /* Reducido a la mitad: 100px -> 50px */
            padding: 0 1.25rem; /* AJUSTE: Quitamos el padding top para que Stage use el espacio */
            min-height: 100vh;
            background: #151515;
            display: flex; /* Nuevo: Habilitar flexbox */
            flex-direction: column; /* Nuevo: Apilar elementos */
        }

        #tvSidebar button#settingsModeBtn {
            width: 20px; /* Reducido a la mitad: 40px -> 20px */
            height: 20px; /* Reducido a la mitad: 40px -> 20px */
            padding: 0;
            font-size: 0.6rem; /* Reducido a la mitad: 1.2rem -> 0.6rem */
            background-color: #383838;
            color: #e0e0e0;
            border: none;
            border-radius: 50%;
            margin: 0.25rem auto; /* Reducido a la mitad: 0.5rem auto -> 0.25rem auto */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #tvSidebar button#settingsModeBtn:hover,
        #tvSidebar button#settingsModeBtn.tv-sidebar-link-focused {
            background-color: var(--primary) !important;
            border: 1px solid white; /* Reducido a la mitad: 2px -> 1px */
            outline-offset: 1px; /* Reducido a la mitad: 2px -> 1px */
            transform: scale(1.1);
        }
        
        #tvBottomNav {
            padding: 0 2.5px; /* Reducido a la mitad: 0 5px -> 0 2.5px */
            margin-top: 0.5rem; /* Reducido a la mitad: 1rem -> 0.5rem */
        }
        
        .tv-card {
            min-width: 150px; /* Reducido a la mitad: 300px -> 150px */
            max-width: 150px; /* Reducido a la mitad: 300px -> 150px */
            height: 84.5px; /* Reducido a la mitad: 169px -> 84.5px */
            border-radius: 6px; /* Reducido a la mitad: 12px -> 6px */
            background: #2d2d2d;
            border: 1px solid transparent; /* Reducido a la mitad: 2px -> 1px */
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: flex-start;
            padding: 5px 0; /* Reducido a la mitad: 10px 0 -> 5px 0 */
            cursor: pointer;
            transition: transform 0.3s ease-in-out, border-color 0.3s ease-in-out;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            box-shadow: 0 2px 7.5px rgba(0, 0, 0, 0.4); /* Reducido a la mitad */
        }

        .channel-card--logo-img {
            background-size: 80% !important;
            background-position: center !important;
            background-color: #222222 !important;
        }

        .tv-card-focused {
            transform: scale(1.05);
            border-color: var(--primary) !important;
            box-shadow: 0 4px 10px rgba(var(--primary-rgb), 0.5); /* Reducido a la mitad */
        }

        .tv-channels-grid {
            padding-top: 0.75rem; /* A침adido: Restaurar el padding que se elimin칩 en #tvMainContent para dejar espacio al Stage */
            flex-grow: 1; /* Nuevo: Asegura que la cuadr칤cula ocupe el espacio restante */
            min-height: 0; /* Fix para flex-grow en algunos navegadores */
            justify-content: flex-start; /* Por defecto, alinear arriba */
        }

        .tv-group {
            padding: 0;
            margin-bottom: 0;
        }

        .tv-group-header {
            padding: 0 0 0.4rem 0; /* Reducido a la mitad: 0.8rem -> 0.4rem */
            display: flex;
            align-items: center;
            /* Estilo para que se vea clickable en TV Mode */
            cursor: pointer; 
            transition: background-color 0.2s;
            border-radius: var(--radius-sm);
        }
        
        /* Nuevo: Estilo de foco para el encabezado */
        .tv-group-header:focus, .tv-group-header:hover {
            outline: none;
            background-color: rgba(255, 255, 255, 0.05);
        }

        .tv-group-title {
            font-size: 0.75rem; /* Reducido a la mitad: 1.5rem -> 0.75rem */
            font-weight: 700;
            color: #e0e0e0;
            border-left: 2px solid var(--primary); /* Reducido a la mitad: 4px -> 2px */
            padding-left: 7.5px; /* Reducido a la mitad: 15px -> 7.5px */
            width: 100%;
            margin-top: 0; 
        }

        .tv-date-header {
            font-size: 0.9rem; /* Reducido a la mitad: 1.8rem -> 0.9rem */
            font-weight: 800;
            color: #e0e0e0;
            margin-top: 1rem; /* Reducido a la mitad: 2rem -> 1rem */
            margin-bottom: 0.25rem; /* Reducido a la mitad: 0.5rem -> 0.25rem */
            padding-left: 0;
            width: 100%;
        }
        
        .tv-date-header:first-of-type {
            margin-top: 0;
        }


        .tv-subgroup-content {
            display: flex;
            gap: 0.75rem; /* Reducido a la mitad: 1.5rem -> 0.75rem */
            padding: 0.25rem 0; /* Reducido a la mitad: 0.5rem 0 -> 0.25rem 0 */
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            scroll-snap-type: x mandatory;
        }

        .tv-subgroup-content::-webkit-scrollbar {
            height: 0;
            display: none;
        }

        .modal__content {
            max-width: 225px; /* Reducido a la mitad: 450px -> 225px */
        }

        .channel-option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px; /* Reducido a la mitad: 10px -> 5px */
            margin-bottom: 2.5px; /* Reducido a la mitad: 5px -> 2.5px */
            border-radius: var(--radius-sm);
            background: #343434; 
            cursor: pointer;
            transition: background-color 0.2s;
            border: 0.5px solid #444444; /* Reducido a la mitad */
        }

        .channel-option-item:hover {
            background: #333333;
            border-color: var(--primary);
        }

        .channel-option-name {
            font-weight: 600;
            color: var(--text);
            flex-grow: 1;
            margin-left: 5px; /* Reducido a la mitad: 10px -> 5px */
            font-size: 0.45rem; /* A침adido: Se reduce el tama침o de fuente */
        }
        
        .channel-option-name-container {
            display: flex;
            align-items: center;
            flex-grow: 1;
            font-weight: 600;
            color: var(--text);
        }

        .last-viewed-indicator {
            margin-left: 2.5px; /* Reducido a la mitad: 5px -> 2.5px */
            margin-right: 5px; /* Reducido a la mitad: 10px -> 5px */
            font-size: 0.55rem; /* Reducido a la mitad: 1.1rem -> 0.55rem */
            color: var(--primary);
            font-weight: 700;
        }
        
        .channel-option-details {
            font-size: 0.4rem; /* A침adido: Se reduce el tama침o de fuente */
            display: flex;
            align-items: center;
            gap: 3px; /* A침adido: Espacio reducido */
        }

        .tv-link-button {
            position: absolute;
            bottom: 2.5px; /* Reducido a la mitad: 5px -> 2.5px */
            right: 2.5px; /* Reducido a la mitad: 5px -> 2.5px */
            width: 15px; /* Reducido a la mitad: 30px -> 15px */
            height: 15px; /* Reducido a la mitad: 30px -> 15px */
            border-radius: 50%;
            background-color: rgba(120, 120, 120, 0.15);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.45rem; /* Reducido a la mitad: 0.9rem -> 0.45rem */
            box-shadow: 0 0.5px 2px rgba(0, 0, 0, 0.4); /* Reducido a la mitad */
            z-index: 50;
            transition: transform 0.2s, background-color 0.2s;
        }

        .tv-link-button:hover,
        .tv-link-button-focused {
            background-color: var(--primary);
            transform: scale(1.05);
        }
        
        .favorite-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-right: 2.5px; /* Reducido a la mitad: 5px -> 2.5px */
            font-size: 0.6rem; /* Reducido a la mitad: 1.2rem -> 0.6rem */
            color: #FFD700;
            transition: transform 0.1s ease;
            display: flex;
            align-items: center;
        }
        
        .favorite-toggle-btn:hover {
            transform: scale(1.1);
        }
        
        .favorite-toggle-btn.is-not-favorite {
            color: var(--channel-name-color);
            opacity: 0.7;
            font-weight: 400;
        }
        
        /* ESTILOS PARA EL MENSAJE DE NO RESULTADOS */
        .no-results-container { /* Nuevo contenedor para centrar */
            display: flex;
            justify-content: center; /* Centrar horizontalmente */
            align-items: center; /* Centrar verticalmente */
            flex-grow: 1;
            width: 100%;
            height: 100%; /* Ocupar el espacio disponible */
        }
        
        .no-results {
            text-align: center;
            padding: 1rem; /* Reducido a la mitad: 2rem -> 1rem */
            background: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            margin: auto; /* Centrado dentro del no-results-container */
            max-width: 400px; /* Reducido a la mitad: 800px -> 400px */
            width: 90%;
        }

        .no-results-icon {
            font-size: 1.5rem; /* Reducido a la mitad: 3rem -> 1.5rem */
            margin-bottom: 0.5rem; /* Reducido a la mitad: 1rem -> 0.5rem */
            opacity: .5;
            color: #666;
        }

        .no-results-text {
            font-size: 0.55rem; /* Reducido a la mitad: 1.1rem -> 0.55rem */
            color: var(--text);
            margin-bottom: 0.25rem; /* Reducido a la mitad: .5rem -> .25rem */
            font-weight: 600;
        }

        .no-results-hint {
            font-size: 0.45rem; /* Reducido a la mitad: .9rem -> .45rem */
            color: var(--text);
            opacity: .7;
        }

        /* Para modo oscuro */
        body.dark-mode .no-results {
            background: #222222;
            border: 0.5px solid #383838; /* Reducido a la mitad */
            box-shadow: none; /* Mantener sin shadow espec칤fico de card en modo oscuro TV */
        }

        body.dark-mode .no-results-icon {
            color: #666;
            opacity: 1;
        }

        body.dark-mode .no-results-text {
            color: #e0e0e0;
        }

        body.dark-mode .no-results-hint {
            color: #aaa;
        }
        
        /* ESTILO NUEVO: Ocultar bot칩n '+' en modo "Ocultar bot칩n opciones" */
        body.hide-options-button-active .tv-card .tv-link-button {
            visibility: hidden;
            /* Usamos visibility: hidden en lugar de display: none para que el bot칩n siga siendo accesible por eventos del rat칩n/teclado si es necesario, 
            aunque en este caso la l칩gica principal de la card manejar치 el clic. */
        }
        
        /* Ajuste para que tvChannelsGrid ocupe todo el espacio disponible en TVMainContent */
        #tvChannelsGrid.no-channels {
             display: flex;
             flex-direction: column;
             justify-content: center;
             align-items: center;
             height: 100%;
             min-height: 50vh; /* Para que al menos se centre en una parte visible de la pantalla */
             gap: 0;
        }
        
        /* ############################# */
        /* ### ESTILOS STAGE INMERSIVO ### */
        /* ############################# */
        #tvStage {
            position: relative;
            /* CAMBIO CLAVE: Eliminar altura variable (20vh) y usar aspect-ratio */
            height: auto; 
            min-height: 150px;
            aspect-ratio: 16 / 9; /* NUEVO: Relaci칩n de aspecto 16:9 forzada */
            width: 100%;
            
            margin-bottom: 0.75rem; /* Espacio con la cuadr칤cula de abajo */
            border-radius: var(--radius-md);
            /* ELIMINAR background-color: var(--stage-bg); */
            overflow: hidden;
            display: flex;
            align-items: center;
            color: var(--stage-text-color);
            transition: background-color 0.5s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        /* ELIMINAR: #tvStage::before { ... } */
        #tvStage::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 15vh; /* Emoji grande centrado */
            opacity: 0.1;
            filter: grayscale(100%);
            pointer-events: none;
            transition: all 0.5s ease;
            /* Ocultado para que el fondo CSS lo reemplace */
            display: none; 
        }

        #tvStage .stage-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--stage-overlay-color);
            z-index: 1;
        }

        #tvStage .stage-content {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            padding: 1rem 0.5rem; /* Reducido de 1.5rem 1rem */
            width: 100%;
            height: 100%;
            transform: scale(0.9); /* <--- APLICACI칍N DE LA REDUCCI칍N DEL 10% */
            transform-origin: center center;
            transition: transform 0.3s ease; /* Para que la escala sea suave */
        }
        
        #tvStage .stage-icon-container {
            width: 10vh; 
            height: 10vh;
            min-width: 60px;
            min-height: 60px;
            border-radius: var(--radius-sm);
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.1);
            margin-right: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        #tvStage .stage-icon {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.5));
        }

        #tvStage .stage-text-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }
        
        #tvStage .stage-channel-name {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--stage-channel-name-color);
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #tvStage .stage-main-info {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--white);
            margin-bottom: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #tvStage .stage-secondary-info {
            font-size: 0.6rem;
            color: var(--stage-text-color);
            margin-bottom: 0.5rem;
        }

        #tvStage .stage-progress-bar-container {
            width: 100%;
            height: 6px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.25rem;
        }

        #tvStage .stage-progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--stage-live-color);
            transition: width 0.5s ease, background-color 0.3s;
        }
        
        #tvStage .stage-status {
            font-size: 0.6rem;
            font-weight: 700;
            margin-right: 10px;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        #tvStage .status-live {
            background-color: var(--stage-live-color);
            color: white;
            animation: soft-blink 1.5s infinite ease-in-out;
        }
        
        #tvStage .status-upcoming {
            background-color: var(--stage-upcoming-color);
            color: white;
        }

        #tvStage .status-finished {
            background-color: var(--stage-finished-color);
            color: white;
        }
        
        #tvStage .status-none {
            background-color: rgba(255, 255, 255, 0.2);
            color: var(--stage-text-color);
        }
        
        #tvStage .stage-no-event {
            font-size: 0.8rem;
            color: var(--stage-text-color);
            font-style: italic;
        }

        /* Carrusel para modo no-foco */
        #tvStage.carousel-mode {
            cursor: pointer;
        }
        
        .carousel-indicator {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 3px;
        }
        
        .carousel-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            transition: background-color 0.3s;
        }
        
        .carousel-dot.active {
            background-color: var(--primary);
        }
        
        /* ############################# */
        /* ### ESTILOS DE CAMPO CSS ### */
        /* ############################# */
        
        /* ESTILOS BASE DE CAMPO (DIMENSIONES UNIFORMES 16:9) */
        .campo-base {
            border: 3px solid #ccc;
            position: absolute; /* Para que ocupe todo el #tvStage */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            overflow: hidden;
            border-radius: var(--radius-md);
        }


        /* --- 1. F칔TBOL --- */

        .campo-futbol {
            background-color: #1a5e37;
            border-color: #ffffff;
            border-width: 5px; /* RESTAURADO a 5px */
        }

        /* L칤neas y 츼reas de F칰tbol (Ajustadas para 150px de alto y 267px de ancho) */
        .campo-futbol::before { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); height: 100%; width: 3px; background-color: #ffffff; } /* RESTAURADO a 3px */
        
        /* MODIFICACI칍N: C칤rculo central de f칰tbol ajustado a las dimensiones del c칤rculo de baloncesto (40px de ancho/alto y 2px de borde) */
        .campo-futbol::after { 
            content: ''; 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 40px; /* ANTES: 60px */
            height: 40px; /* ANTES: 60px */
            border-radius: 50%; 
            border: 2px solid #ffffff; /* ANTES: 3px */
            /* ELIMINADO: box-shadow: 0 0 0 3px #ffffff inset; */
        } 
        
        /* 츼reas de penalti y meta restauradas */
        .area-penalti-izq { position: absolute; top: 50%; left: 0; transform: translateY(-50%); width: 40px; height: 90px; border: 3px solid #ffffff; border-left: none; box-sizing: border-box; } /* RESTAURADO a 3px */
        .area-meta-izq { position: absolute; top: 50%; left: 0; transform: translateY(-50%); width: 15px; height: 40px; border: 3px solid #ffffff; border-left: none; box-sizing: border-box; } /* RESTAURADO a 3px */
        .punto-penalti-izq { position: absolute; top: 50%; left: 30px; transform: translateY(-50%); width: 4px; height: 4px; border-radius: 50%; background-color: #ffffff; } /* RESTAURADO a 4px */
        .porteria-izq { position: absolute; top: 50%; left: -5px; transform: translateY(-50%); width: 5px; height: 25px; background-color: #ffffff; z-index: 20; } /* RESTAURADO a 5px */

        .area-penalti-der { position: absolute; top: 50%; right: 0; transform: translateY(-50%); width: 40px; height: 90px; border: 3px solid #ffffff; border-right: none; box-sizing: border-box; } /* RESTAURADO a 3px */
        .area-meta-der { position: absolute; top: 50%; right: 0; transform: translateY(-50%); width: 15px; height: 40px; border: 3px solid #ffffff; border-right: none; box-sizing: border-box; } /* RESTAURADO a 3px */
        .punto-penalti-der { position: absolute; top: 50%; right: 30px; transform: translateY(-50%); width: 4px; height: 4px; border-radius: 50%; background-color: #ffffff; } /* RESTAURADO a 4px */
        .porteria-der { position: absolute; top: 50%; right: -5px; transform: translateY(-50%); width: 5px; height: 25px; background-color: #ffffff; z-index: 20; } /* RESTAURADO a 5px */


        /* --- 2. BALONCESTO (RESTAURADO) --- */
        .campo-baloncesto { background-color: #ff8608; border-color: #ffffff; }
        .campo-baloncesto::before { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); height: 100%; width: 2px; background-color: #ffffff; } /* RESTAURADO a 2px */
        .campo-baloncesto::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; border-radius: 50%; border: 2px solid #ffffff; } /* ESTE es el c칤rculo de referencia (40px/40px, 2px de borde) */
        
        /* Zonas de 3 y canastas restauradas */
        .zona-3-izq { position: absolute; top: 50%; left: 0; transform: translateY(-50%); width: 50px; height: 110px; border: 2px solid #ffffff; border-left: none; border-radius: 0 50% 50% 0 / 0 70% 70% 0; box-sizing: border-box; } /* RESTAURADO a 2px */
        .canasta-izq { position: absolute; top: 50%; left: -1px; transform: translateY(-50%); width: 10px; height: 2px; background-color: #ffffff; } /* RESTAURADO a 2px */
        .zona-3-der { position: absolute; top: 50%; right: 0; transform: translateY(-50%); width: 50px; height: 110px; border: 2px solid #ffffff; border-right: none; border-radius: 50% 0 0 50% / 70% 0 0 70%; box-sizing: border-box; } /* RESTAURADO a 2px */
        .canasta-der { position: absolute; top: 50%; right: -1px; transform: translateY(-50%); width: 10px; height: 2px; background-color: #ffffff; } /* RESTAURADO a 2px */

        /* --- 3. TENIS (MODIFICADO: AHORA ES IGUAL QUE P츼DEL AZUL Y SE CAMBIA A VERDE) --- */
        .campo-tenis {
            /* INICIO DE MODIFICACI칍N PARA COLOR VERDE */
            background-color: #4c9e5e; /* Fondo de Tenis Verde */
            /* Borde exterior de 2px blanco para que coincida con las l칤neas de servicio. */
            border: 2px solid #ffffff; 
            /* FIN DE MODIFICACI칍N */
        }
        
        /* Red Central (antes ::before) */
        .campo-tenis::before {
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 50%; 
            transform: translateX(-50%); 
            height: 100%; 
            width: 5px; /* Red de P치del */
            background-color: #ffffff; 
            z-index: 10;
        } 
        
        /* Se eliminan los estilos ::after y las l칤neas de servicio originales de tenis.
           Las l칤neas de servicio se definen ahora como clases del p치del: */
           
        /* L칤nea de Servicio Transversal IZQUIERDA (Estilo de Padel) */
        .campo-tenis .linea-padel-servicio-izq { /* Uso de .campo-tenis para seleccionar solo las l칤neas dentro de esta cancha */
            position: absolute; 
            top: 0; 
            left: calc(15% - 1px); 
            height: 100%; 
            width: 2px; 
            background-color: #ffffff; 
            z-index: 10; 
        }

        /* L칤nea de Servicio Transversal DERECHA (Estilo de Padel) */
        .campo-tenis .linea-padel-servicio-der { /* Uso de .campo-tenis para seleccionar solo las l칤neas dentro de esta cancha */
            position: absolute; 
            top: 0; 
            right: calc(15% - 1px); 
            height: 100%; 
            width: 2px; 
            background-color: #ffffff; 
            z-index: 10; 
        }
        
        /* L칤nea Central de Servicio (Estilo de Padel) */
        .campo-tenis .linea-padel-central-servicio-corregida { /* Uso de .campo-tenis para seleccionar solo las l칤neas dentro de esta cancha */
            position: absolute;
            top: 50%; 
            transform: translateY(-50%);
            left: 15%; 
            width: 70%; 
            height: 2px; 
            background-color: #ffffff;
            z-index: 12;
        }

        /* --- NUEVAS L칈NEAS DE DOBLES HORIZONTALES (Superior e Inferior) --- */
        .campo-tenis .linea-dobles-sup {
            position: absolute;
            top: 5px; /* Distancia del borde superior */
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #ffffff;
            z-index: 15;
        }

        .campo-tenis .linea-dobles-inf {
            position: absolute;
            bottom: 5px; /* Distancia del borde inferior */
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #ffffff;
            z-index: 15;
        }
        /* FIN DE MODIFICACI칍N DE .campo-tenis */

        /* --- 5. RUGBY (RESTAURADO) --- */
        .campo-rugby { 
            background-color: #2e7a3f; 
            border-color: #ffffff; 
            border-width: 8px; /* RESTAURADO a 8px */ 
            border-radius: 0; 
            overflow: hidden; 
        } 
        
        /* L칤nea central */
        .campo-rugby::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 50%; 
            transform: translateX(-50%); 
            height: 100%; 
            width: 2px; 
            background-color: #ffffff; 
        } /* RESTAURADO a 2px */
        
        /* L칤nea de 10 y 22 metros */
        .linea-10-izq { position: absolute; top: 0; left: 40%; height: 100%; width: 2px; background-color: #ffffff; } /* RESTAURADO a 2px */
        .linea-10-der { position: absolute; top: 0; right: 40%; height: 100%; width: 2px; background-color: #ffffff; } /* RESTAURADO a 2px */
        .linea-22-izq { position: absolute; top: 0; left: 20%; height: 100%; width: 2px; background-color: #ffffff; } /* RESTAURADO a 2px */
        .linea-22-der { position: absolute; top: 0; right: 20%; height: 100%; width: 2px; background-color: #ffffff; } /* RESTAURADO a 2px */

        /* L칤neas discontinuas de 5m */
        .linea-5m-izq { 
            position: absolute; 
            top: 0; 
            left: 5%; 
            width: 2px; /* RESTAURADO a 2px */
            height: 100%; 
            background-image: linear-gradient(to bottom, #ffffff 50%, transparent 50%); 
            background-size: 100% 10px; 
        }
        .linea-5m-der { 
            position: absolute; 
            top: 0; 
            right: 5%; 
            width: 2px; /* RESTAURADO a 2px */
            height: 100%; 
            background-image: linear-gradient(to bottom, #ffffff 50%, transparent 50%); 
            background-size: 100% 10px; 
        }


        /* --- 6. BALONMANO (RESTAURADO) --- */
        .campo-balonmano { background-color: #cccccc; border-color: #333; overflow: hidden; }
        .campo-balonmano::before { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); height: 100%; width: 2px; background-color: #ffffff; } /* RESTAURADO a 2px */
        /* 츼reas de arco restauradas */
        .arco-6-izq { position: absolute; top: 50%; left: 0; transform: translateY(-50%); width: 35px; height: 110px; border: 2px solid #ffffff; border-left: none; border-radius: 0 50% 50% 0 / 0 90% 90% 0; box-sizing: border-box; } /* RESTAURADO a 2px */
        .arco-9-izq { position: absolute; top: 50%; left: 0; transform: translateY(-50%); width: 55px; height: 130px; border: 2px dashed #ffffff; border-left: none; border-radius: 0 50% 50% 0 / 0 110% 110% 0; box-sizing: border-box; } /* RESTAURADO a 2px */
        .arco-6-der { position: absolute; top: 50%; right: 0; transform: translateY(-50%); width: 35px; height: 110px; border: 2px solid #ffffff; border-right: none; border-radius: 50% 0 0 50% / 90% 0 0 90%; box-sizing: border-box; } /* RESTAURADO a 2px */
        .arco-9-der { position: absolute; top: 50%; right: 0; transform: translateY(-50%); width: 55px; height: 130px; border: 2px dashed #ffffff; border-right: none; border-radius: 50% 0 0 50% / 110% 0 0 110%; box-sizing: border-box; } /* RESTAURADO a 2px */

        /* --- 7. NATACI칍N (PISCINA - RESTAURADA) --- */

        .piscina {
            background-color: #3f7b9e; 
            border-color: #000000;
            overflow: hidden;
        }

        /* L칤neas de Carril */
        .carril-1, .carril-2, .carril-3 {
            position: absolute;
            width: 100%;
            height: 4px; /* RESTAURADO a 4px */
            
            /* Patr칩n de puntos blancos y rojos */
            background-image: repeating-linear-gradient(90deg, #ffffff, #ffffff 5px, #ff0000 5px, #ff0000 10px);
            background-size: 10px 100%; 
            background-repeat: repeat-x;
        }

        .carril-1 { top: 25%; }
        .carril-2 { top: 50%; } 
        .carril-3 { top: 75%; }
        
        /* L칤nea de inicio/final */
        .piscina::before {
            content: '';
            position: absolute;
            left: 5px;
            top: 0;
            height: 100%;
            width: 2px; /* RESTAURADO a 2px */
            background-color: yellow;
        }

        /* ------------------------------------------- */
        /* --- 8. ATLETISMO (PISTA DE 400M) - MODIFICADO A SEMIC칈RCULOS M츼S PRONUNCIADOS --- */
        /* ------------------------------------------- */
        /* Conversi칩n: 267px ancho, 150px alto */

        .pista-atletismo {
            background-color: #9e4b3f; 
            border: none;
            /* Mantiene el radio en p칤xeles, la mitad de la altura de la pista base (150px / 2 = 75px) */
            border-radius: 75px / 75px; 
            overflow: hidden; /* Cambiado de 'visible' a 'hidden' para contener mejor la forma */
        }

        /* C칠sped Interior */
        .pista-atletismo::before {
            content: '';
            position: absolute;
            /* Conversi칩n: top: 20px -> 13.33% (20/150) | left: 20px -> 7.49% (20/267) */
            top: 13.33%; 
            left: 7.49%; 
            /* Conversi칩n: width: 227px -> 85.02% (227/267) | height: 110px -> 73.33% (110/150) */
            width: 85.02%; 
            height: 73.33%; 
            background-color: #2e7a3f; 
            /* Mantiene el radio en p칤xeles, la mitad de la altura del c칠sped (110px / 2 = 55px) */
            border-radius: 55px / 55px; 
            z-index: 1;
        }
        
        /* L칤nea del primer carril (el m치s exterior) */
        .pista-atletismo::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            border: 1px solid #ffffff; 
            /* Mantiene el radio en p칤xeles */
            border-radius: 75px / 75px; 
            z-index: 2;
        }
        
        /* Carriles Interiores (L칤nea de inicio/fin) */
        .pista-atletismo .carriles-interiores {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            border-left: 3px solid #ffffff; 
            /* Mantiene el radio en p칤xeles */
            border-radius: 75px / 75px; 
            box-sizing: border-box;
            z-index: 5;
        }
        
        /* Simulaci칩n de los 4 carriles interiores (del 4 al 1) */
        .pista-atletismo .carriles-interiores::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            /* Mantiene el radio en p칤xeles */
            border-radius: 75px / 75px; 
            box-sizing: border-box;
            /* El sombreado interior crea las l칤neas de carril, se mantiene el grosor de 8px */
            box-shadow: 
                0 0 0 1px #ffffff inset, 
                0 0 0 8px #9e4b3f inset, 
                0 0 0 9px #ffffff inset, 
                0 0 0 16px #9e4b3f inset, 
                0 0 0 17px #ffffff inset, 
                0 0 0 24px #9e4b3f inset, 
                0 0 0 25px #ffffff inset; 
            z-index: 10;
        }

        /* --- 9. CICLISMO (SKILINE MONTA칌A - RESTAURADO A ORIGINAL) --- */
        
        .skyline-montana {
            background-image: linear-gradient(to bottom, #87ceeb, #ffffff 80%); /* RESTAURADO: Cielo azul */
            border: 3px solid #ccc; 
            overflow: hidden;
        }

        /* Monta침a de primer plano y fondo (RESTURADO) */
        .skyline-montana::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 70%; 
            background-color: #587950; /* RESTAURADO: Tono verde oscuro */
            clip-path: polygon(0% 100%, 10% 30%, 25% 65%, 40% 10%, 60% 75%, 85% 40%, 100% 70%, 100% 100%); /* RESTAURADO: Picos angulares */
            z-index: 10;
        }
        
        .skyline-montana::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -10%; 
            width: 120%;
            height: 50%;
            background-color: #8db587; /* RESTAURADO: Tono verde claro */
            clip-path: polygon(0% 100%, 15% 45%, 30% 20%, 50% 60%, 70% 35%, 90% 55%, 100% 40%, 100% 100%); /* RESTAURADO: Picos angulares */
            z-index: 5;
        }


        /* --- 10. MOTORSPORT (CIRCUITO SINUOSO - MODIFICADO CON %) --- */
        /* Conversi칩n: 267px ancho, 150px alto */
        .circuito-motorsport { background-color: #8c8c8c; border-color: #f0f0f0; overflow: hidden; }
        
        /* Trazado (::before) */
        .circuito-motorsport::before { 
            content: ''; 
            position: absolute; 
            /* Conversi칩n: top: 10px -> 6.67% | left: 10px -> 3.75% */
            top: 6.67%; 
            left: 3.75%; 
            /* Conversi칩n: width: 247px -> 92.51% | height: 130px -> 86.67% */
            width: 92.51%; 
            height: 86.67%;
            background-color: transparent; 
            border: 15px solid #636363; /* Mantenido en px */
            border-radius: 80% 30% 90% 20% / 40% 70% 30% 60%; 
            box-sizing: border-box; 
            z-index: 1;
        }
        
        /* C칠sped Interior (::after) */
        .circuito-motorsport::after { 
            content: ''; 
            position: absolute; 
            /* Conversi칩n: top: 30px -> 20% | left: 30px -> 11.24% */
            top: 20%; 
            left: 11.24%; 
            /* Conversi칩n: width: 207px -> 77.53% | height: 90px -> 60% */
            width: 77.53%; 
            height: 60%;
            background-color: #2e7a3f; 
            border-radius: 80% 30% 90% 20% / 40% 70% 30% 60%; 
            box-sizing: border-box; 
            z-index: 2;
        }
        
        /* Bandera a cuadros (meta-salida) */
        .meta-salida { 
            position: absolute; 
            /* MODIFICADO: Centrado con translateY(-50%) */
            top: 50%; 
            transform: translateY(-50%);
            left: 5px; 
            width: 30px; 
            height: 10px; 
            z-index: 30; 
            background-color: white; 
            background-image: 
                linear-gradient(45deg, #000 25%, transparent 25%), 
                linear-gradient(-45deg, #000 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #000 75%), 
                linear-gradient(-45deg, transparent 75%, #000 75%);
            background-size: 10px 10px; 
            background-position: 0 0, 0 5px, 5px -5px, -5px 0px; 
        }


        /* --- 11. P츼DEL AZUL (RESTAURADO) --- */
        .campo-padel-azul {
            background-color: #0b4e8e; 
            border: 3px solid #000000; /* RESTAURADO a 3px */
            box-shadow: 
                0 0 0 5px rgba(255, 255, 255, 0.4) inset, 
                0 0 0 8px rgba(0, 0, 0, 0.2) inset; 
        }
        
        /* Red Central */
        .campo-padel-azul::before {
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 50%; 
            transform: translateX(-50%); 
            height: 100%; 
            width: 5px; /* RESTAURADO a 5px */
            background-color: #ffffff; 
            z-index: 10;
        }
        
        /* L칤nea de Servicio Transversal IZQUIERDA */
        .linea-padel-servicio-izq { 
            position: absolute; 
            top: 0; 
            left: calc(15% - 1px); 
            height: 100%; 
            width: 2px; /* RESTAURADO a 2px */
            background-color: #ffffff; 
            z-index: 10; 
        }

        /* L칤nea de Servicio Transversal DERECHA */
        .linea-padel-servicio-der { 
            position: absolute; 
            top: 0; 
            right: calc(15% - 1px); 
            height: 100%; 
            width: 2px; /* RESTAURADO a 2px */
            background-color: #ffffff; 
            z-index: 10; 
        }
        
        /* L칤nea Central de Servicio */
        .linea-padel-central-servicio-corregida {
            position: absolute;
            top: 50%; 
            transform: translateY(-50%);
            left: 15%; 
            width: 70%; 
            height: 2px; /* RESTAURADO a 2px */
            background-color: #ffffff;
            z-index: 12;
        }


        /* --- 12. CIRCUITO COMPLEJO (칍VALO - MODIFICADO CON %) --- */
        /* Conversi칩n: 267px ancho, 150px alto */
        .circuito-complejo {
            background-color: #8c8c8c; 
            border: 3px solid #f0f0f0; /* RESTAURADO a 3px */
            border-radius: 20px;
            overflow: hidden;
        }

        /* Trazado (::before) */
        .circuito-complejo::before {
            content: '';
            position: absolute;
            /* Conversi칩n: top: 15px -> 10% | left: 15px -> 5.62% */
            top: 10%;
            left: 5.62%;
            /* Conversi칩n: width: 237px -> 88.76% | height: 120px -> 80% */
            width: 88.76%; 
            height: 80%;
            background-color: transparent;
            border: 15px solid #636363; /* Mantenido en px */
            box-sizing: border-box;
            border-radius: 50% / 40%;
            z-index: 1;
        }

        /* C칠sped Interior (::after) */
        .circuito-complejo::after {
            content: '';
            position: absolute;
            /* Conversi칩n: top: 35px -> 23.33% | left: 35px -> 13.11% */
            top: 23.33%;
            left: 13.11%;
            /* Conversi칩n: width: 197px -> 73.78% | height: 80px -> 53.33% */
            width: 73.78%; 
            height: 53.33%;
            background-color: #2e7a3f; 
            box-sizing: border-box;
            border-radius: 50% / 40%; 
            z-index: 2;
        }
        
        /* Bandera a cuadros (meta-salida) */
        .circuito-complejo .meta-salida { 
            position: absolute; 
            top: 50%; 
            left: 10px; 
            transform: translateY(-50%);
            width: 30px; 
            height: 10px; 
            z-index: 30; 
            /* Se reutiliza la clase .meta-salida con el patr칩n de cuadros */
        }

        /* --- 13. RALLY / DAKAR (MODIFICADO: DUNAS DEL DESIERTO) --- */

        .campo-rally {
            /* CAMBIO: Fondo c치lido para el cielo del desierto (reemplaza el color arena) */
            background-image: linear-gradient(to bottom, #ffdb58, #ffffff 80%); 
            border: 4px solid #9e7b4e; 
            border-radius: 10px;
            overflow: hidden;
        }
        
        /* ELIMINADO: Trazado Punteado (Ruta Off-Road) */
        .campo-rally::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 70%; 
            background-color: #c2b280; /* Duna de primer plano: Tono arena oscuro */
            /* Patr칩n de dunas suaves */
            clip-path: polygon(0% 100%, 10% 70%, 25% 45%, 40% 60%, 60% 30%, 85% 55%, 100% 40%, 100% 100%);
            z-index: 10;
        }
        
        .campo-rally::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -10%; 
            width: 120%;
            height: 50%;
            background-color: #e3d8b5; /* Duna de fondo: Tono beige/arena claro */
            /* Patr칩n de dunas suaves */
            clip-path: polygon(0% 100%, 15% 55%, 30% 35%, 50% 45%, 70% 20%, 90% 40%, 100% 30%, 100% 100%);
            z-index: 5;
        }


        /* ############################# */
        /* ### FIN ESTILOS DE CAMPO CSS ### */
        /* ############################# */
        
    </style>
</head>

<body class="tv-mode-active dark-mode">
    <aside id="tvSidebar">
        <div>
            <div style="margin-bottom: 0.5rem; padding: 0 2.5px;">
                <input type="text" id="tvSearch" placeholder="Buscar canal..." tabindex="0">
            </div>
            <nav>
                <ul style="list-style: none; padding: 0; margin: 0;">
                    <li style="margin-bottom: 0.25rem;"><a href="#" class="tv-nav-link" data-filter="all" tabindex="0">
                            <span>游깷</span> Todos </a></li>
                    <li style="margin-bottom: 0.25rem;"><a href="#" class="tv-nav-link" data-filter="live" tabindex="0">
                            <span>游댮</span> Directo </a></li>
                    <li style="margin-bottom: 0.25rem;"><a href="#" class="tv-nav-link" data-filter="favorites"
                            tabindex="0"> <span>救</span>Favoritos </a></li>

                    <li style="margin: 0.25rem 0; border-top: 0.5px solid #383838;"></li> <li style="margin-top: 0.25rem;"><a href="#" class="tv-nav-link brand-filter dazn-filter" data-filter="dazn" tabindex="0"> <img src="https://images.weserv.nl/?url=https%3A%2F%2Fstatic.wikia.nocookie.net%2Flogopedia%2Fimages%2F7%2F7c%2FDAZN.svg%2Frevision%2Flatest%3Fcb%3D20210824163814" alt="DAZN Logo"> </a></li>
                        <li><a href="#" class="tv-nav-link brand-filter movistar-filter" data-filter="m+" tabindex="0">
                        <img src="https://images.weserv.nl/?url=https://static.wikia.nocookie.net/logopedia/images/a/af/Movistar_2025.svg/revision/latest?cb=20251005163444" alt="Movistar+ Logo"> </a></li>
                    <li style="margin-bottom: 0.25rem;"><a href="#" class="tv-nav-link brand-filter eurosport-filter" data-filter="eurosport" tabindex="0"> <img src="https://images.weserv.nl/?url=https://static.wikia.nocookie.net/logopedia/images/9/99/Eurosport_Mobile_Logo.png/revision/latest?cb=20180407080639"> </a></li>

                    <div id="tvSportFilters">
                        <a href="#" class="tv-nav-link sport-filter" data-sport-key="futbol" tabindex="0" title="F칰tbol">丘</a>
                        <a href="#" class="tv-nav-link sport-filter" data-sport-key="baloncesto" tabindex="0" title="Baloncesto">游</a>
                        <a href="#" class="tv-nav-link sport-filter" data-sport-key="tenis" tabindex="0" title="Tenis">游</a>
                        <a href="#" class="tv-nav-link sport-filter" data-sport-key="motorsport" tabindex="0" title="Motorsport">游끠</a>
                        <a href="#" class="tv-nav-link sport-filter" data-sport-key="f1" tabindex="0" title="F1">游끭勇</a>
                    </div>
                    </ul>
            </nav>
        </div>
        <div id="tvBottomNav">
            <button id="settingsModeBtn" tabindex="0"> 丘뙖잺 </button>
        </div>
    </aside>
    <main id="tvMainContent">
        <div id="tvStage"> 
            <div id="tvStageBackground" class="campo-base pista-atletismo"> 
                <div class="area-penalti-izq"></div>
                <div class="area-meta-izq"></div>
                <div class="punto-penalti-izq"></div>
                <div class="porteria-izq"></div>
                <div class="area-penalti-der"></div>
                <div class="area-meta-der"></div>
                <div class="punto-penalti-der"></div>
                <div class="porteria-der"></div>
                </div>

            <div class="stage-overlay"></div>
            <div class="stage-content">
                <div class="stage-icon-container">
                    <img id="stageChannelIcon" class="stage-icon" src="" alt="Icono del Canal" style="display: none;">
                </div>
                <div class="stage-text-area">
                    <div id="stageStatusAndSecondary" style="display: flex; align-items: center; margin-bottom: 0.25rem;">
                        <span id="stageStatus" class="stage-status status-none">CARGANDO...</span>
                        <span id="stageSecondaryInfo" class="stage-secondary-info" style="margin-bottom: 0; margin-left: 5px;">Cargando lista de canales y eventos.</span>
                    </div>
                    <h3 id="stageChannelName" class="stage-channel-name">Bienvenido a la Gu칤a TV.</h3>
                    <h2 id="stageMainInfo" class="stage-main-info">Selecciona un canal para ver los detalles.</h2>
                    <div id="stageProgressBarContainer" class="stage-progress-bar-container">
                        <div id="stageProgressBar" class="stage-progress-bar"></div>
                    </div>
                </div>
            </div>
            <div class="carousel-indicator" id="stageCarouselIndicator"></div>
        </div>
        <div id="tvStatusMessageContainer"></div>
        <h1 style="color: white; margin-top: 0; display: none;"></h1>
        <div class="tv-channels-grid" id="tvChannelsGrid"></div>
    </main>


    <div class="modal" id="settingsModal">
        <div class="modal__content">
            <h3 class="modal__title">丘뙖잺 Ajustes</h3>
            <div class="settings-section">
                <h4 class="settings-section__title">游닠 Opciones de Interfaz</h4>
                <div class="settings-item">
                    <div class="settings-item__info"><span class="settings-icon">游둰勇</span>
                        <div><span class="settings-label">Pantalla Completa al Clic</span><span class="settings-description">Activa el modo de pantalla completa al hacer clic en cualquier parte de la interfaz.</span></div>
                    </div><label class="settings-switch"><input type="checkbox" id="fullScreenOnClickCheckbox"><span class="settings-slider"></span></label>
                </div>
                <div class="settings-item">
                    <div class="settings-item__info"><span class="settings-icon">俱</span>
                        <div><span class="settings-label">Ocultar Bot칩n de Opciones</span><span class="settings-description">Mantiene la funcionalidad del bot칩n '+' pero lo hace invisible.</span></div>
                    </div><label class="settings-switch"><input type="checkbox" id="hideOptionsButtonCheckbox"><span class="settings-slider"></span></label>
                </div>
                <p class="settings-description" style="color: var(--text); opacity: 0.7; margin-bottom: 0.5rem;">
                    Esta interfaz est치 optimizada para TV/Mandos. Para escritorio, usa la versi칩n normal.</p>
            </div>
            <div class="settings-section">
                <h4 class="settings-section__title">游꿛 Apariencia</h4>
                <div class="settings-item">
                    <div class="settings-item__info"><span class="settings-icon">游깹</span>
                        <div><span class="settings-label">Modo oscuro</span><span class="settings-description">Cambia
                                entre tema claro y oscuro (Solo afecta a los modales).</span></div>
                    </div><label class="settings-switch"><input type="checkbox" id="darkModeCheckbox"><span
                            class="settings-slider"></span></label>
                </div>
                <div class="settings-item">
                    <div class="settings-item__info"><span class="settings-icon">游꿛</span>
                        <div><span class="settings-label">Color principal</span><span class="settings-description">Elige
                                un color para la interfaz</span></div>
                    </div>
                    <div class="color-picker"><button class="color-option" data-color="#2563eb"
                            style="background:#2563eb"></button><button class="color-option" data-color="#dc2626"
                            style="background:#dc2626"></button><button class="color-option" data-color="#16a34a"
                            style="background:#16a34a"></button><button class="color-option" data-color="#79006f"
                            style="background:#79006f"></button></div>
                </div>
            </div>
            <div class="settings-section">
                <h4 class="settings-section__title">游댢 Datos</h4>
                <div class="settings-item">
                    <div class="settings-item__info"><span class="settings-icon">游늰</span>
                        <div><span class="settings-label">Ocultar detalles de evento</span><span
                                class="settings-description">Oculta fecha, hora y deporte de los grupos.</span></div>
                    </div><label class="settings-switch"><input type="checkbox" id="hideEventDetailsCheckbox"><span
                            class="settings-slider"></span></label>
                </div>
                <div class="settings-item">
                    <div class="settings-item__info"><span class="settings-icon">救</span>
                        <div><span class="settings-label">Restablecer puntuaciones</span><span
                                class="settings-description">Borra la puntuaci칩n de estabilidad de todos los
                                canales</span></div>
                    </div><button class="modal__btn" onclick="resetRatings()">Reiniciar</button>
                </div>
            </div>
            <div class="modal__actions"><button class="modal__btn modal__btn--primary"
                    id="closeSettingsBtn">Cerrar</button></div>
        </div>
    </div>
    
    <div class="copy-modal" id="copyModal">
        <div class="copy-modal-icon">游댕</div>
        <div class="copy-modal-text">Enlace AceStream a copiar:</div>
        <p id="copyUrlDisplayAceStream" class="copy-modal-url"></p><button class="copy-modal-button"
            id="copyAceStreamBtn" data-format="acestream">Copiar AceStream</button><button
            class="modal__btn modal__btn--cancel" id="cancelCopyBtn">Cancelar</button>
    </div>
    <div class="copy-message" id="copyMessage">URL copiada con 칠xito!</div>
    
    <div class="modal" id="tvChannelOptionsModal">
        <div class="modal__content" style="max-width: 225px;">
            <h3 class="modal__title">游닠 Opciones de Canal <span id="tvModalChannelName"></span></h3>
            <div id="tvModalChannelList" style="max-height: 350px; overflow-y: auto;"></div>
            <div class="modal__actions"><button class="modal__btn modal__btn--primary"
                    id="closeTvOptionsBtn">Cerrar</button></div>
        </div>
    </div>

    <script>
        const state = {
            allChannels: [],
            channelsData: [],
            favorites: JSON.parse(localStorage.getItem('favorites')) || [],
            channelHistory: JSON.parse(localStorage.getItem('channelHistory')) || {},
            currentChannel: null,
            clearButtonClickCount: 0, 
            lastClearButtonClickTime: 0,
            elcanoRetries: 0,
            eventsRetries: 0,
            darkMode: localStorage.getItem('darkMode') !== 'false',
            primaryColor: localStorage.getItem('primaryColor') || '#2563eb',
            channelRatings: JSON.parse(localStorage.getItem('channelRatings')) || {},
            lastChannelPlay: JSON.parse(localStorage.getItem('lastChannelPlay')) || null,
            firstSeen: JSON.parse(localStorage.getItem('firstSeen')) || {},
            hideEventDetails: localStorage.getItem('hideEventDetails') === 'true',
            tvCurrentFilter: localStorage.getItem('tvCurrentFilter') || 'all',
            tvSportFilter: localStorage.getItem('tvSportFilter') || 'all', 
            tvSearchTerm: '',
            tvFocusManager: null,
            playerActive: false,
            lastPlayedByChannel: JSON.parse(localStorage.getItem('lastPlayedByChannel')) || {},
            // NUEVO ESTADO: Controla si la pantalla completa al hacer clic est치 activa
            fullScreenOnClick: localStorage.getItem('fullScreenOnClick') === 'true',
            // NUEVO ESTADO: Ocultar bot칩n de opciones
            hideOptionsButton: localStorage.getItem('hideOptionsButton') === 'true',
            // ESTADO STAGE
            carouselChannels: [],
            carouselIndex: 0,
            carouselTimer: null,
            isStageFocused: false,
        };
        const LOGOPEDIA_BASE_URL = "https://static.wikia.nocookie.net/logopedia/images/";
        const IMAGE_PROXY_URL = "https://images.weserv.nl/?url=";
        const ERA_URL = "https://ipfs.io/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/listaplana.txt";
        const championsLeagueImages = {
            'M+ LIGA DE CAMPEONES': '0/05/Liga_de_Campeones_por_Movistar_Plus%2B.svg/revision/latest?cb=20220128151054',
            'M+ COMEDIA': '2/27/Comedia_por_Movistar_Plus%2B_2023.svg/revision/latest?cb=20230721191930',
            'M+ LIGA DE CAMPEONES 2': '3/33/Liga_de_Campeones_2_por_Movistar_Plus%2B.png/revision/latest?cb=20230708171922',
            'M+ LIGA DE CAMPEONES 3': 'f/f8/Liga_de_Campeones_3_por_Movistar_Plus%2B.png/revision/latest?cb=20230708171923',
            'M+ LIGA DE CAMPEONES 4': '0/0a/Liga_de_Campeones_4_por_Movistar_Plus%2B.png/revision/latest?cb=20230708171811',
            'M+ LIGA DE CAMPEONES 5': 'b/b3/Liga_de_Campeones_5_por_Movistar_Plus%2B.png/revision/latest?cb=20230708171812',
            'M+ LIGA DE CAMPEONES 6': 'd/d8/Liga_de_Campeones_6_por_Movistar_Plus%2B.png/revision/latest?cb=20230708171813',
            'M+ LIGA DE CAMPEONES 7': 'b/bf/Liga_de_Campeones_7_por_Movistar_Plus%2B.png/revision/latest?cb=20230708171814',
            'M+ LIGA DE CAMPEONES 8': '3/3f/Liga_de_Campeones_8_por_Movistar_Plus%2B.png/revision/latest?cb=20230708171815',
            'M+ DEPORTES': 'd/d7/Deportes_por_Movistar_Plus%2B_2023.svg/revision/latest?cb=20230721194319',
            'M+ DEPORTES 2': '7/7c/Deportes_2_por_Movistar_Plus%2B_2023.png/revision/latest?cb=20230721201028',
            'M+ DEPORTES 3': '4/40/Deportes_3_por_Movistar_Plus%2B_2023.png/revision/latest?cb=20230721201007',
            'M+ DEPORTES 4': 'e/eb/Deportes_4_por_Movistar_Plus%2B_2023.png/revision/latest?cb=20230721201006',
            'M+ DEPORTES 5': '8/88/Deportes_5_por_Movistar_Plus%2B_2023.png/revision/latest?cb=20230721201005',
            'M+ DEPORTES 6': 'd/d1/Deportes_6_por_Movistar_Plus%2B_2023.png/revision/latest?cb=20230721201004',
            'M+ LA LIGA': 'c/cd/LaLigaTV_por_Movistar_Plus%2B_2023.svg/revision/latest?cb=20230704125929',
            'M+ LA LIGA 2': '4/4c/LaLigaTV_2_por_Movistar_Plus%2B_2023.png/revision/latest?cb=20230708175335',
            'M+ LA LIGA 3': '0/0e/LaLigaTV_3_por_Movistar_Plus%2B_2023.png/revision/latest?cb=20230708175336',
            'M+ LA LIGA 4': 'a/a2/LaLigaTV_4_por_Movistar_Plus%2B_2023.png/revision/latest?cb=20230708175337',
            'M+ LA LIGA 5': 'b/ba/LaLigaTV_5_por_Movistar_Plus%2B_2023.png/revision/latest?cb=20230708175338',
            'M+ LIGA DE CAMPEONES 9': '5/5b/Liga_de_Campeones_9_por_Movistar_Plus%2B.png/revision/latest?cb=20230708171816',
            'M+ LIGA DE CAMPEONES 10': 'a/ad/Liga_de_Campeones_10_por_Movistar_Plus%2B.png/revision/latest?cb=20230708171816',
            'M+ LIGA DE CAMPEONES 11': 'e/e5/Liga_de_Campeones_11_por_Movistar_Plus%2B.png/revision/latest?cb=20230708171817',
            'M+ LIGA DE CAMPEONES 12': '1/1e/Liga_de_Campeones_12_por_Movistar_Plus%2B.png/revision/latest?cb=20230708171818',
            'M+ LIGA DE CAMPEONES 13': '0/02/Liga_de_Campeones_13_por_Movistar_Plus%2B.png/revision/latest?cb=20230708171819',
            'M+ LIGA DE CAMPEONES 14': '1/10/Liga_de_Campeones_14_por_Movistar_Plus%2B.png/revision/latest?cb=20230708172106',
            'M+ LIGA DE CAMPEONES 15': '0/0c/Liga_de_Campeones_15_por_Movistar_Plus%2B.png/revision/latest?cb=20230708172107',
            'M+ LIGA DE CAMPEONES 16': '2/23/Liga_de_Campeones_16_por_Movistar_Plus%2B.png/revision/latest?cb=20230708172108',
            'M+ LIGA DE CAMPEONES 17': '7/7b/Liga_de_Campeones_17_por_Movistar_Plus%2B.png/revision/latest?cb=20230708172109',
            'LA 1': '1/19/Logo_TVE-1.svg/revision/latest?cb=20220319071348',            '驕EUROSPORT 1': 'c/c8/Eurosport_1.svg/revision/latest?cb=20210911124742',
            'M+ PLUS': '0/07/Movistar_Plus%2B.svg/revision/latest?cb=20240116071854',
            'M+ FESTIVAL DE SAN SEBASTI츼N': '3/38/M%C3%BAsica_por_Movistar_Plus%2B_2023.svg/revision/latest?cb=20230801070424',
            'M+ ROMANCE': '4/4d/Suspense_por_Movistar_Plus%2B_2023.svg/revision/latest?cb=20230801070149',
            'M+ PLUS 2': '1/1f/Movistar_Plus%2B_2_2023.svg/revision/latest/scale-to-width-down/250?cb=20240116072142',
            'LA LIGA HYPERMOTION 3': '2/23/La_Liga_Hypermotion_3.svg/revision/latest/scale-to-width-down/250?cb=20240921160145',
            'M+ ACCI칍N': 'b/b6/Acci%C3%B3n_por_Movistar_Plus%2B_2023.svg/revision/latest?cb=20230721192021',
            'M+ CINE ESPA칌OL': 'd/d2/Cine_Espa%C3%B1ol_por_Movistar_Plus%2B_2023.svg/revision/latest?cb=20230722062235',
            'M+ CL츼SICOS': '2/2f/Cl%C3%A1sicos_por_Movistar_Plus%2B_2023.svg/revision/latest?cb=20230721192128',
            'M+ DOCUMENTALES': '7/7c/Documentales_por_Movistar_Plus%2B_2023.svg/revision/latest?cb=20230801070305',
            'M+ DRAMA': '0/0d/Drama_por_Movistar_Plus%2B_2023.svg/revision/latest?cb=20230721191847',
            'M+ ESTRENOS': '8/88/Estrenos_por_Movistar_Plus%2B_2025.svg/revision/latest?cb=20250128104456',
            'M+ ELLAS': '1/1d/Ellas_Vamos_por_Movistar_Plus%2B.svg/revision/latest?cb=20230728171815',
            'M+ HITS': '3/3c/Hits_por_M%2B.svg/revision/latest?cb=20250128110338', 
            'M+ INDIE': '2/22/Indie_por_Movistar_Plus%2B_2023.svg/revision/latest?cb=20230801070038',
            'M+ ORIGINALES': '0/09/Originales_por_Movistar_Plus%2B_2023.svg/revision/latest?cb=20230801070235',
            'DAZN 1 BAR': '8/83/DAZN_2019_logo.svg/revision/latest?cb=20210824002335',
            'DAZN PVV': '2/29/DAZN_PPV.png/revision/latest/scale-to-width-down/250?cb=20230708104557',
            '驕EUROSPORT 2': '0/0d/Eurosport_2_%282015%29.svg/revision/latest?cb=20171209134527',
            'M+ VAMOS': 'b/be/Vamos_por_Movistar_Plus%2B_2023.svg/revision/latest?cb=20230728170813',
            'LA LIGA HYPERMOTION': 'b/b5/LaLiga_TV_Hypermotion.svg/revision/latest?cb=20230704141115',
            'LA LIGA HYPERMOTION 2': '6/6f/La_Liga_Hypermotion_2.svg/revision/latest/scale-to-width-down/250?cb=20240921151926',
            'M+ GOLF': '2/21/Golf_por_Movistar_Plus%2B_2023.svg/revision/latest?cb=20230721202544',
            'M+ GOLF 2': '5/57/Golf_2_por_Movistar_Plus%2B_2023.png/revision/latest?cb=20230721202546',
            'DAZN F1': 'c/cc/DAZN_F1.svg/revision/latest?cb=20221210225344',
            'DAZN LA LIGA': '1/18/DAZN_LALIGA_2024.svg/revision/latest?cb=20240910115205',
            'DAZN LA LIGA 2': 'f/fa/DAZN_LaLiga_2_2024.svg/revision/latest/scale-to-width-down/250?cb=20240910121150',
            'DAZN 1': '1/18/DAZN_1_2024.svg/revision/latest?cb=20240713213358',
            'DAZN 2': '8/82/DAZN_2_2024.svg/revision/latest?cb=20240713212845',
            'DAZN 3': '0/0f/DAZN_3_2024.svg/revision/latest?cb=20240713212252',
            'DAZN 4': 'f/f7/DAZN_4_2024.svg/revision/latest?cb=20240713211915',
        };
        const SPORT_EMOJIS = {
            'futbol': '丘', 'baloncesto': '游', 'tenis': '游', 'motorsport': '游끠', 'f1': '游끭勇',
            'handball': '游쮝꽥뗵勇', 'paddle': '游볥', 'triatlon': '游끩游뛊游끢', 'motor': '游뚱', 'boxeo': '游볡',
            'ciclismo': '游뛊', 'beisbol': '丘', 'golf': '久', 'voleibol': '游끯', 'hockey': '游끰',
            'rugby': '游끨', 'natacion': '游끩', 'atletismo': '游끢', 'gimnasia': '游뱢', 'esqui': '久勇',
            'surf': '游끣', 'e-sports': '游꿡', 'ajedrez': '鮫勇', 'dardos': '游꿢', 'billares': '游꿤',
            'patinaje': '久젎잺', 'criquet': '游끮', 'default': '游닠'
        };
        const SPORT_COLORS = {
            'futbol': '#1a5e37', 
            'baloncesto': '#e0974b', 
            'tenis': '#5d9f3f', 
            'paddle': '#0d8f5d', 
            'padel': '#0b4e8e', 
            'motorsport': '#8c8c8c', 
            'f1': '#8c8c8c', 
            'golf': '#4ee1b0', 
            'rugby': '#2e7a3f',
            'handball': '#cccccc',
            'natacion': '#3f7b9e',
            'atletismo': '#9e4b3f',
            'ciclismo': '#6a5a4a',
            'motor': '#8c8c8c', // RALLY / DAKAR
            'default': '#9e4b3f', // PISTA DE ATLETISMO (TART츼N)
        };
        const SPORT_FIELD_CLASSES = {
            'futbol': { class: 'campo-futbol', elements: '<div class="area-penalti-izq"></div><div class="area-meta-izq"></div><div class="punto-penalti-izq"></div><div class="porteria-izq"></div><div class="area-penalti-der"></div><div class="area-meta-der"></div><div class="punto-penalti-der"></div><div class="porteria-der"></div>' },
            'baloncesto': { class: 'campo-baloncesto', elements: '<div class="zona-3-izq"></div><div class="canasta-izq"></div><div class="zona-3-der"></div><div class="canasta-der"></div>' },
            'tenis': { class: 'campo-tenis', elements: '<div class="linea-padel-servicio-izq"></div><div class="linea-padel-servicio-der"></div><div class="linea-padel-central-servicio-corregida"></div><div class="linea-dobles-sup"></div><div class="linea-dobles-inf"></div>' },
            'paddle': { class: 'campo-padel-azul', elements: '<div class="linea-padel-servicio-izq"></div><div class="linea-padel-servicio-der"></div><div class="linea-padel-central-servicio-corregida"></div>' }, // Usar el azul mejorado para p치del por defecto
            'padel': { class: 'campo-padel-azul', elements: '<div class="linea-padel-servicio-izq"></div><div class="linea-padel-servicio-der"></div><div class="linea-padel-central-servicio-corregida"></div>' },
            'rugby': { class: 'campo-rugby', elements: '<div class="linea-22-izq"></div><div class="linea-22-der"></div><div class="linea-10-izq"></div><div class="linea-10-der"></div><div class="linea-5m-izq"></div><div class="linea-5m-der"></div>' },
            'handball': { class: 'campo-balonmano', elements: '<div class="arco-9-izq"></div><div class="arco-6-izq"></div><div class="arco-9-der"></div><div class="arco-6-der"></div>' },
            'natacion': { class: 'piscina', elements: '<div class="carril-1"></div><div class="carril-2"></div><div class="carril-3"></div>' },
            'atletismo': { class: 'pista-atletismo', elements: '<div class="carriles-interiores"></div>' },
            'ciclismo': { class: 'skyline-montana', elements: '' }, // Usamos skyline-montana como 'ciclismo'
            'f1': { class: 'circuito-motorsport', elements: '<div class="meta-salida"></div>' },
            'motor': { class: 'campo-rally', elements: '' }, // RALLY/DAKAR
            'motorsport': { class: 'circuito-motorsport', elements: '<div class="meta-salida"></div>' },
            'default': { class: 'pista-atletismo', elements: '<div class="carriles-interiores"></div>' }, // PISTA DE ATLETISMO como fallback
        };

        function getPlaceholderInfo(channelName) {
            const name = channelName.toUpperCase().trim();
            if (championsLeagueImages[name]) {
                let url = championsLeagueImages[name];

                const baseUrl = LOGOPEDIA_BASE_URL;
                if (url.startsWith('https:')) {
                     url = url.substring(baseUrl.length);
                }

                return {
                    url: url,
                    class: 'channel-card--logo-img'
                };
            }
            return null;
        }

        function proxyImage(url) {
            return IMAGE_PROXY_URL + encodeURIComponent(url);
        }
        const PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://cors-anywhere.herokuapp.com/',
            'https://api.codetabs.com/v1/proxy/?quest=',
            'https://proxy-cors-simple.vercel.app/api?url=',
            'https://yacdn.org/proxy/',
            'https://cors-proxy.fringe.co.kr/?'
        ];
        const GIST_URL = "https://gist.githubusercontent.com/Ciento20/f7847e86d06e5011706fa76f2dab90be/raw";
        const ELCANO_URL = 'https://ipfs.io/ipns/elcano.top';
        const EVENTS_URL = 'https://eventos-eight-dun.vercel.app/';
        const SHICKAT_URL = 'https://shickat.me/';
        const BACKUP_KEYS = {
            gist: 'gist_channels_backup',
            elcano: 'elcano_channels_backup',
            events: 'events_channels_backup',
            shickat: 'shickat_channels_backup',
            era: 'era_channels_backup'
        };
        const MAX_RETRIES = 3;
        const BACKUP_EXPIRY_HOURS = 480;
        const HISTORY_EXPIRY_HOURS = 168;

        const TV_BRAND_FILTER_KEYS = ['all', 'live', 'favorites', 'dazn', 'm+', 'eurosport'];
        const TV_SPORT_FILTER_KEYS = ['futbol', 'baloncesto', 'tenis', 'motorsport', 'f1'];

        const OTHER_SUBGROUPS = [
            'LIGA ENDESA',
            'CANAL DE TENIS',
            'SUPERTENNIS',
            'BUNDESLIGA',
            'PRIMERA FEDERACI칍N',
            '1RFEF',
            'ARAGON TV',
            'BEIN',
            'BT SPORT',
            'CANAL+SPORT',
            'ESPN',
            'ESSPN',
            'SKY',
            'ESPORT 3',
            'FOX',
            'GOL PLAY',
            'REAL MADRID TV',
            'ORANGE TV',
            'RALLY TV',
            'MOTOR',
            'NBA',
            'NFL',
            'PREMIER SPORTS',
            'DISCOVERY CHANNEL',
            'DARK',
            'AMC',
            'LA 1',
            'LA 2',
            'ANTENA 3',
            'Cuatro',
            'Telecinco',
            'LA SEXTA',
            '24 HORAS',
            'TELEDEPORTE',
            'CAZA Y PESCA',
            'CANAL COCINA',
            'DECASA',
            'ONETORO',
            'ZIGGO',
            'XTRM',
            'MIXED TV',
            'DAZN',
            '(DE)',
            '(PL)',
            '(RU)'
        ];

        function normalizeText(text) {
            if (!text) return '';
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        function extractPID(enlace) {
            if (!enlace) return '';
            return enlace.replace('acestream://', '').trim();
        }

        async function hashContent(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        function trackFirstSeen(channelId) {
            if (!state.firstSeen[channelId]) {
                state.firstSeen[channelId] = new Date().getTime();
                localStorage.setItem('firstSeen', JSON.stringify(state.firstSeen));
            }
        }

        function isChannelNew(channelId) {
            const firstSeenTime = state.firstSeen[channelId];
            if (!firstSeenTime) {
                return false;
            }
            const tenMinutesInMs = 10 * 60 * 1000;
            return (new Date().getTime() - firstSeenTime) < tenMinutesInMs;
        }

        function cleanupOldFirstSeenRecords() {
            const oneWeekInMs = 7 * 24 * 60 * 60 * 1000;
            const now = new Date().getTime();
            for (const channelId in state.firstSeen) {
                if ((now - state.firstSeen[channelId]) > oneWeekInMs) {
                    delete state.firstSeen[channelId];
                }
            }
            localStorage.setItem('firstSeen', JSON.stringify(state.firstSeen));
        }

        function toggleFavorite(channelId) {
            const index = state.favorites.indexOf(channelId);
            if (index > -1) {
                state.favorites.splice(index, 1);
            } else {
                state.favorites.push(channelId);
            }
            localStorage.setItem('favorites', JSON.stringify(state.favorites));
            renderTVChannels();
        }

        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            localStorage.setItem('darkMode', state.darkMode);
            document.body.classList.toggle('dark-mode', state.darkMode);
            document.getElementById('darkModeCheckbox').checked = state.darkMode;
            updatePrimaryLightColor();
        }

        function toggleHideEventDetails() {
            state.hideEventDetails = !state.hideEventDetails;
            localStorage.setItem('hideEventDetails', state.hideEventDetails);
            document.getElementById('hideEventDetailsCheckbox').checked = state.hideEventDetails;
            document.body.classList.toggle('hide-event-details', state.hideEventDetails);
            renderTVChannels();
        }

        // NUEVA FUNCI칍N: Alterna el estado de Pantalla Completa al Clic
        function toggleFullScreenOnClick() {
            state.fullScreenOnClick = !state.fullScreenOnClick;
            localStorage.setItem('fullScreenOnClick', state.fullScreenOnClick);
            document.getElementById('fullScreenOnClickCheckbox').checked = state.fullScreenOnClick;
        }
        
        // NUEVA FUNCI칍N: Alterna el estado de Ocultar Bot칩n de Opciones
        function toggleHideOptionsButton() {
            state.hideOptionsButton = !state.hideOptionsButton;
            localStorage.setItem('hideOptionsButton', state.hideOptionsButton);
            document.getElementById('hideOptionsButtonCheckbox').checked = state.hideOptionsButton;
            // Aplicar/eliminar la clase CSS al body
            document.body.classList.toggle('hide-options-button-active', state.hideOptionsButton);
            renderTVChannels(); // Llama a render para asegurar que se actualicen las tarjetas si fuera necesario.
        }

        // NUEVA FUNCI칍N: Solicita el modo de pantalla completa
        function requestFullScreen() {
            if (document.fullscreenElement) {
                // Si ya est치 en pantalla completa, no hacer nada o salir (depende del comportamiento deseado)
                return;
            }
            const element = document.documentElement; // Todo el documento
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.mozRequestFullScreen) { // Firefox
                element.mozRequestFullScreen();
            } else if (element.webkitRequestFullscreen) { // Chrome, Safari, Opera
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) { // IE/Edge
                element.msRequestFullscreen();
            }
        }

        function clearAllTVFilterVisuals() {
            document.querySelectorAll('#tvSidebar .tv-nav-link').forEach(link => {
                link.classList.remove('tv-sidebar-link-focused');
            });
            document.querySelectorAll('#tvBottomNav button').forEach(button => {
                button.classList.remove('tv-sidebar-link-focused');
            });
        }

        function applyTVFilter(filter, type) {
            let updateNeeded = false;

            if (type === 'brand') {
                if (filter === 'all' && state.tvSearchTerm) {
                    state.tvSearchTerm = '';
                    const tvSearchInput = document.getElementById('tvSearch');
                    if (tvSearchInput) {
                        tvSearchInput.value = '';
                    }
                    updateNeeded = true;
                }

                if (state.tvCurrentFilter !== filter) {
                    state.tvCurrentFilter = filter;
                    localStorage.setItem('tvCurrentFilter', filter);
                    updateNeeded = true;
                } else if (filter !== 'all' && filter !== 'live' && filter !== 'favorites') {
                    state.tvCurrentFilter = 'all';
                    localStorage.setItem('tvCurrentFilter', 'all');
                    updateNeeded = true;
                }

                if (state.tvSportFilter !== 'all') {
                    state.tvSportFilter = 'all';
                    localStorage.setItem('tvSportFilter', 'all');
                    updateNeeded = true;
                }
            }

            if (type === 'sport') {
                state.tvSportFilter = state.tvSportFilter === filter ? 'all' : filter;
                localStorage.setItem('tvSportFilter', state.tvSportFilter);
                updateNeeded = true;

                if (state.tvSportFilter !== 'all' && state.tvCurrentFilter !== 'all') {
                    state.tvCurrentFilter = 'all';
                    localStorage.setItem('tvCurrentFilter', 'all');
                }
            }

            if (updateNeeded) {
                renderTVChannels();
            }
        }


        function showStatusMessage(message, type = "info") {
            let statusElement;
            let container;
            
            container = document.getElementById('tvStatusMessageContainer');
            statusElement = container.querySelector(".status-message");
            if (!statusElement) {
                statusElement = document.createElement("div");
                statusElement.className = "status-message";
                container.prepend(statusElement);
            }

            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.classList.remove('hide');
            
            if (state.darkMode && type === 'error') {
                 statusElement.style.color = 'var(--text)';
            } else if (state.darkMode && type === 'warning') {
                statusElement.style.color = 'var(--warning)';
            } else if (state.darkMode && (type === 'success' || type === 'info')) {
                statusElement.style.color = 'var(--primary)';
            } else {
                statusElement.style.color = '';
            }


            if (type === "success" || type === "info") {
                setTimeout(() => {
                    statusElement.classList.add('hide');
                    statusElement.addEventListener('transitionend', () => {
                        if (statusElement.classList.contains('hide')) {
                            statusElement.remove();
                        }
                    }, {
                        once: true
                    });
                }, 3000);
            }
        }

        function saveBackup(data, key, contentHash = null) {
            try {
                localStorage.setItem(key, JSON.stringify({
                    timestamp: new Date().getTime(),
                    data,
                    contentHash
                }));
            } catch (e) {
                console.error(`Error al guardar la copia de seguridad para ${key}:`, e);
            }
        }

        function loadBackup(key) {
            try {
                const backupData = localStorage.getItem(key);
                if (backupData) {
                    const {
                        timestamp,
                        data,
                        contentHash
                    } = JSON.parse(backupData);
                    const backupAgeHours = (new Date().getTime() - timestamp) / (1000 * 60 * 60);
                    if (backupAgeHours > BACKUP_EXPIRY_HOURS) {
                        localStorage.removeItem(key);
                        return null;
                    }
                    return { timestamp, data, contentHash }; 
                }
            } catch (e) {
                console.error(`Error al cargar la copia de seguridad para ${key}:`, e);
            }
            return null;
        }

        function mergeChannels(channelsArray) {
            const allChannels = channelsArray;
            const eventChannels = allChannels.filter(channel => channel.source === 'events');
            const otherChannels = allChannels.filter(channel => channel.source !== 'events');
            const eventIds = new Set(eventChannels.map(channel => channel.id));
            const uniqueOtherChannelsMap = new Map();
            const orderedOtherSources = ['elcano', 'shickat', 'era', 'gist'];
            orderedOtherSources.forEach(source => {
                otherChannels.forEach(channel => {
                    if (channel.source === source) {
                        if (!eventIds.has(channel.id)) {
                            if (!uniqueOtherChannelsMap.has(channel.id)) {
                                uniqueOtherChannelsMap.set(channel.id, channel);
                            }
                        }
                    }
                });
            });
            const mergedOtherChannels = Array.from(uniqueOtherChannelsMap.values());
            return eventChannels.concat(mergedOtherChannels);
        }

        function loadAndRenderBackupChannels() {
            let allBackupChannels = [];
            let hasBackup = false;
            for (const key in BACKUP_KEYS) {
                const backup = loadBackup(BACKUP_KEYS[key]);
                if (backup && backup.data) {
                    allBackupChannels = allBackupChannels.concat(backup.data.map(c => ({
                        ...c,
                        source: key,
                        name: c.name || `Canal de ${key.toUpperCase()}`,
                        id: c.id || `${key}_${Math.random()}`,
                        number: (c.id || `${key}_${Math.random()}`).substring(0, 3),
                        displayableName: c.displayableName || c.name
                    })));
                    hasBackup = true;
                }
            }
            if (allBackupChannels.length > 0) {
                const newChannels = mergeChannels(allBackupChannels);
                state.channelsData = newChannels;
                processChannelNames();
                renderTVChannels();
                return true;
            }
            return false;
        }

        async function fetchAndProcessSource(sourceName, url, processor, backupKey) {
            let channels = null;
            let message = '';
            let contentHash = null;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("Error al obtener el contenido de la fuente");
                const infoContent = await response.text();
                
                contentHash = await hashContent(infoContent);

                const backup = loadBackup(backupKey);

                if (backup && backup.contentHash === contentHash) {
                    channels = backup.data;
                    message = `Canales de ${sourceName} cargados (Sin cambios).`;
                    console.log(`[${sourceName}] Contenido sin cambios. Usando backup local.`);
                } else {
                    channels = await processor(infoContent);
                    saveBackup(channels, backupKey, contentHash);
                    message = `Canales de ${sourceName} cargados y actualizados.`;
                    console.log(`[${sourceName}] Contenido actualizado o nuevo. Procesado y guardado.`);
                }

            } catch (error) {
                console.error(`Fallo al cargar de ${sourceName}:`, error);
                
                const backup = loadBackup(backupKey);
                if (backup && backup.data) {
                    channels = backup.data;
                    message = `Fallo de ${sourceName}. Mostrando canales del historial.`;
                } else {
                    message = `Fallo de ${sourceName}. Sin historial disponible.`;
                }
            }

            return {
                name: sourceName,
                channels,
                message
            };
        }


        async function loadInitialChannels() {
            const tvChannelsGrid = document.getElementById("tvChannelsGrid");
            
            document.getElementById('tvStatusMessageContainer').innerHTML = '';
            
            // Iniciar Stage en modo de carga
            updateStage(null);

            const isShowingBackup = loadAndRenderBackupChannels();
            const temporaryLoadMessage = isShowingBackup ? "Mostrando historial. Obteniendo datos en tiempo real..." : "Cargando datos en tiempo real...";
            showStatusMessage(temporaryLoadMessage, "warning");
            
            const results = await Promise.allSettled([
                fetchAndProcessSource('events', EVENTS_URL, loadEventsSource, BACKUP_KEYS.events),
                fetchAndProcessSource('era', ERA_URL, loadEraChannels, BACKUP_KEYS.era),
                fetchAndProcessSource('gist', GIST_URL, loadGistChannels, BACKUP_KEYS.gist),
                fetchProxyContentAndProcess('shickat', SHICKAT_URL, processShickatData, BACKUP_KEYS.shickat),
                fetchProxyContentAndProcess('elcano', ELCANO_URL, processElcanoDataFromHtml, BACKUP_KEYS.elcano)
            ]);
            
            let allChannels = [];
            let hasFallback = false;
            let hasOnlineSuccess = false;
            results.forEach(result => {
                if (result.status === 'fulfilled' && result.value.channels) {
                    if (result.value.message.includes('historial')) {
                        hasFallback = true;
                        allChannels = allChannels.concat(result.value.channels);
                    } else {
                        allChannels = allChannels.concat(result.value.channels);
                        hasOnlineSuccess = true;
                    }
                }
            });
            
            const statusElement = document.querySelector("#tvStatusMessageContainer .status-message"); 

            if (allChannels.length > 0) {
                const newChannels = mergeChannels(allChannels);
                state.channelsData = newChannels;
                processChannelNames();
                renderTVChannels();
                cleanObsoleteRatings();
                
                // Configurar el carrusel de Stage
                setupCarouselChannels();
                
                if (statusElement) statusElement.remove();

                if (hasOnlineSuccess) {
                    if (hasFallback) {
                        showStatusMessage("Canales actualizados (algunos con historial).", "warning");
                    } else {
                        showStatusMessage("Canales actualizados correctamente.", "success");
                    }
                } else if (isShowingBackup) {
                    showStatusMessage("Fallo al actualizar canales. Se sigue mostrando el historial.", "error");
                } else {
                    // Usar las nuevas clases de estilo aqu칤
                    tvChannelsGrid.innerHTML = ` <div class="no-results"><div class="no-results-icon">游니</div><div class="no-results-text">Error al cargar los canales.</div><div class="no-results-hint">No se han conseguido cargar los canales (modo offline/sin historial).</div><button class="retry-button" onclick="loadInitialChannels()">Reintentar</button></div> `;
                    showStatusMessage("Error al cargar canales. Sin historial disponible.", "error");
                }
            } else if (isShowingBackup) {
                if (statusElement) statusElement.remove();
                showStatusMessage("Fallo al actualizar canales. Se sigue mostrando el historial.", "error");
                setupCarouselChannels(); // Intenta el carrusel con el backup
            } else {
                if (statusElement) statusElement.remove();
                // Usar las nuevas clases de estilo aqu칤
                tvChannelsGrid.innerHTML = ` <div class="no-results-container"><div class="no-results"><div class="no-results-icon">游니</div><div class="no-results-text">Error al cargar los canales.</div><div class="no-results-hint">No se han conseguido cargar los canales (modo offline/sin historial).</div><button class="retry-button" onclick="loadInitialChannels()">Reintentar</button></div></div> `;
                showStatusMessage("Error al cargar canales. Sin historial disponible.", "error");
                updateStage(null); // No hay nada que mostrar en el Stage
            }
        }

        function normalizeChannelName(name) {
            if (name.includes('Eurosport 1')) {
                return '驕EUROSPORT 1';
            } else if (name.includes('Eurosport 2')) {
                return '驕EUROSPORT 2';
            } else if (name.includes('Eurosport')) {
                return '驕EUROSPORT 1';
            } else if (name.includes('Teledeporte')) {
                return 'Teledeporte';
            }
            return name;
        }

        async function loadGistChannels(infoContent) {
            return processGistData(infoContent);
        }

        async function loadEraChannels(infoContent) {
            return processGistData(infoContent).map(c => ({
                ...c,
                source: 'era',
                name: c.name
            }));
        }

        function processGistData(infoCanales) {
            const numberedChannels = [];
            const lines = infoCanales.split('\n').filter(line => line.trim() !== '');
            const channelMappings = {
                'DAZN LA LIGA 1': 'DAZN La Liga',
                'MOVISTAR': 'M+',
                'CLASICOS': 'Cl치sicos',
                'VAMOS': 'Vamos',
                'ACCION': 'Acci칩n',
                'LALIGA': 'La Liga',
                'DEPORTES': 'Deportes',
                'PLUS': 'Plus',
                'M.': 'M+',
                'LIGA DE CAMPEONES': 'M+ Liga de Campeones',
                'GOLF': 'Golf',
                'LA LIGA': 'La Liga',
                'HYPERMOTION': 'La Liga Hypermotion',
                'EUROSPORT': '驕EUROSPORT',
                'ELLAS': 'Ellas'
            };
            for (let i = 0; i < lines.length; i += 2) {
                const nameLine = lines[i].trim();
                const idLine = lines[i + 1] ? lines[i + 1].trim() : '';
                if (nameLine.includes('-->') && idLine.length > 0) {
                    let namePart = nameLine.split('-->')[0].trim().toUpperCase();
                    const acestreamId = idLine.replace(/p$/, '');
                    if (acestreamId.length === 40) {
                        let quality = 'SD';
                        let multiAudio = false;
                        if (namePart.includes('FHD')) {
                            quality = 'FHD';
                            namePart = namePart.replace('FHD', '').trim();
                        } else if (namePart.includes('4K')) {
                            quality = '4K';
                            namePart = namePart.replace('4K', '').trim();
                        } else if (namePart.includes('HD')) {
                            quality = 'HD';
                            namePart = namePart.replace('HD', '').trim();
                        } else if (namePart.includes('SD')) {
                            quality = 'SD';
                            namePart = namePart.replace('SD', '').trim();
                        }
                        if (namePart.includes('MULTI')) {
                            multiAudio = true;
                            namePart = namePart.replace('MULTI', '').trim();
                        }
                        namePart = namePart.replace(/\(ES\)|\(Es\)/g, '', ).trim();
                        let simplifiedName = namePart;
                        for (const key in channelMappings) {
                            if (simplifiedName.includes(key)) {
                                simplifiedName = simplifiedName.replace(key, channelMappings[key]);
                            }
                        }
                        simplifiedName = normalizeChannelName(simplifiedName);
                        numberedChannels.push({
                            id: acestreamId,
                            number: acestreamId.substring(0, 3),
                            name: simplifiedName,
                            quality: quality,
                            multiAudio: multiAudio,
                            isKnown: true,
                            source: 'gist'
                        });
                        trackFirstSeen(acestreamId);
                    }
                }
            }
            return numberedChannels;
        }

        async function fetchProxyContentAndProcess(sourceName, url, processor, backupKey) {
            let lastError;
            let content = null;
            let finalMessage = '';

            for (const proxy of PROXIES) {
                try {
                    const proxyUrl = proxy + encodeURIComponent(url);
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);
                    
                    const response = await fetch(proxyUrl, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) throw new Error(`Proxy ${proxy} responded with ${response.status}`);
                    
                    content = await response.text();
                    
                    const contentHash = await hashContent(content);

                    const backup = loadBackup(backupKey);
                    
                    if (backup && backup.contentHash === contentHash) {
                        finalMessage = `Canales de ${sourceName} cargados (Sin cambios).`;
                        console.log(`[${sourceName}] Contenido sin cambios. Usando backup local.`);
                        return { name: sourceName, channels: backup.data, message: finalMessage };
                    } else {
                        const channels = await processor(content); 
                        saveBackup(channels, backupKey, contentHash);
                        finalMessage = `Canales de ${sourceName} cargados y actualizados.`;
                        console.log(`[${sourceName}] Contenido actualizado o nuevo. Procesado y guardado.`);
                        return { name: sourceName, channels, message: finalMessage };
                    }

                } catch (error) {
                    lastError = error;
                    console.warn(`Proxy ${proxy} fall칩 para ${sourceName}:`, error);
                    continue;
                }
            }

            const backup = loadBackup(backupKey);
            if (backup && backup.data) {
                finalMessage = `Fallo de ${sourceName}. Mostrando canales del historial.`;
                return { name: sourceName, channels: backup.data, message: finalMessage };
            } else {
                finalMessage = `Fallo de ${sourceName}. Sin historial disponible.`;
                throw lastError || new Error(`Todos los proxies fallaron para la fuente ${sourceName}.`);
            }
        }
        
        async function loadElcanoSource(htmlContent) {
            return processElcanoDataFromHtml(htmlContent);
        }
        
        function processElcanoDataFromHtml(htmlContent) {
            const jsonMatch = htmlContent.match(/const linksData\s*=\s*({[\s\S]*?});/);
            if (!jsonMatch) throw new Error("No se encontr칩 linksData o el formato HTML ha cambiado.");
            let jsonString = jsonMatch[1];
            jsonString = jsonString.replace(/\s*\/\/.*(?:\n|$)/g, '');
            jsonString = jsonString.replace(/,\s*}/g, '}')
                .replace(/,\s*]/g, ']');
            const linksData = JSON.parse(jsonString);
            if (!linksData || !linksData.links || !Array.isArray(linksData.links)) {
                throw new Error("Estructura de linksData incorrecta o falta el array 'links'.");
            }
            return processElcanoData(linksData.links);
        }

        async function loadEventsSource(htmlContent) {
            return processEventsData(htmlContent);
        }

        async function loadShickatChannels(htmlContent) {
            return processShickatData(htmlContent);
        }

        function processShickatData(htmlContent) {
            const numberedChannels = [];
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const cards = doc.querySelectorAll('article.canal-card');
            const nameMappings = {
                'Ellas Vamos': 'Ellas',
                'Movistar': 'M+',
                'Clasicos': 'Cl치sicos',
                'Accion': 'Acci칩n',
                'Deportes': 'Deportes',
                'Plus': 'Plus',
                'M+ Liga de Campeones': 'M+ Liga de Campeones',
                'Golf': 'Golf',
            };
            cards.forEach(card => {
                const nameElement = card.querySelector('.canal-nombre');
                const acestreamLinkElement = card.querySelector('.acestream-link');
                if (nameElement && acestreamLinkElement) {
                    const rawName = nameElement.textContent.trim();
                    const acestreamId = acestreamLinkElement.textContent.trim();
                    if (acestreamId.length === 40) {
                        let quality = '720p';
                        let simplifiedName = rawName;
                        if (rawName.includes('(HD)')) {
                            quality = '720p';
                            simplifiedName = rawName.replace('(HD)', '').trim();
                        } else if (rawName.includes('(FHD)')) {
                            quality = '1080p';
                            simplifiedName = simplifiedName.replace('(FHD)', '').trim();
                        }
                        const multiAudio = simplifiedName.includes('MultiAudio');
                        for (const key in nameMappings) {
                            if (simplifiedName.includes(key)) {
                                simplifiedName = simplifiedName.replace(key, nameMappings[key]);
                                break;
                            }
                        }
                        if (simplifiedName.includes('M. LaLiga')) {
                            simplifiedName = simplifiedName.replace('M. LaLiga', 'M+ La Liga');
                        } else if (simplifiedName.includes('Movistar')) {
                            simplifiedName = simplifiedName.replace('Movistar', 'M+');
                        }
                        if (simplifiedName.includes('LaLiga')) {
                            simplifiedName = simplifiedName.replace('LaLiga', 'La Liga');
                        }
                        simplifiedName = normalizeChannelName(simplifiedName);
                        numberedChannels.push({
                            id: acestreamId,
                            number: acestreamId.substring(0, 3),
                            name: simplifiedName,
                            quality: quality,
                            multiAudio: multiAudio,
                            isKnown: true,
                            source: 'shickat'
                        });
                        trackFirstSeen(acestreamId);
                    }
                }
            });
            return numberedChannels;
        }

        function processElcanoData(links) {
            const numberedChannels = [];
            const nameMap = {
                'M. LaLiga': 'M+ La Liga',
                'LaLiga Smartbank': 'La Liga Hypermotion',
                'LaLiga': 'La Liga',
                'MovistarPlus': 'M+ Plus',
                'Vamos': 'M+ Vamos',
                'Deporte': 'M+ Deportes',
                'Dedporte': 'M+ Deportes',
                'Dazn': 'DAZN',
                'Campeones': 'M+ Liga de Campeones'
            };
            links.forEach(link => {
                if (link.url && link.url.startsWith('acestream://')) {
                    const acestreamId = link.url.split('://')[1];
                    let quality = '720p';
                    let multiAudio = false;
                    if (link.name.includes('1080')) quality = '1080p';
                    if (link.name.includes('720')) quality = '720p';
                    if (link.name.includes('UHD')) quality = 'UHD';
                    multiAudio = link.name.includes('MultiAudio') || link.name.includes('Multi Audio') || link.name.toLowerCase().includes('multi');
                    let simplifiedName = link.name
                        .replace(/1080P|1080|720|UHD|MultiAudio|Multi Audio|\(.*?\)/g, '')
                        .replace(/\s+/g, ' ')
                        .trim();
                    for (const key in nameMap) {
                        if (simplifiedName.includes(key)) {
                            simplifiedName = simplifiedName.replace(key, nameMap[key]);
                            break;
                        }
                    }
                    simplifiedName = normalizeChannelName(simplifiedName);
                    numberedChannels.push({
                        id: acestreamId,
                        number: acestreamId.substring(0, 3),
                        name: simplifiedName,
                        quality: quality,
                        multiAudio: multiAudio,
                        isKnown: true,
                        source: 'elcano'
                    });
                    trackFirstSeen(acestreamId);
                }
            });
            return numberedChannels;
        }

        function calculateDuration(sportName) {
            const normalizedName = normalizeText(sportName);

            // --- L칩gica Espec칤fica para F1/Motorsport ---
            if (normalizedName.includes('formula 1') || normalizedName.includes('f1')) {
                if (normalizedName.includes('practice') || normalizedName.includes('entrenamiento')) {
                    // Ejemplo: Free Practice / Pr치ctica Libre -> 1 hora y 5 minutos
                    return 65; 
                } else if (normalizedName.includes('qualifying') || normalizedName.includes('clasificacion')) {
                    // Ejemplo: Qualifying / Clasificaci칩n -> 1 hora y 30 minutos
                    return 90; 
                } else if (normalizedName.includes('race') || normalizedName.includes('carrera') || normalizedName.includes('gp')) {
                    // Ejemplo: Race / Carrera (incluye el previo/post de 1 hora)
                    return 180; 
                }
                return 180; // Default para F1 si no se especifica el tipo de evento
            }
            
            // --- L칩gica General de Deportes ---
            if (normalizedName.includes('futbol')) return 120; // 90 min + 30 min (previo/descanso/post)
            if (normalizedName.includes('baloncesto') || normalizedName.includes('nba')) return 150; // 48 min de juego + pausas y extras
            if (normalizedName.includes('tenis')) return 300; // La duraci칩n es muy variable (5 horas)
            if (normalizedName.includes('motor')) return 120; // 2 horas para otros deportes de motor
            if (normalizedName.includes('ciclismo')) return 180; 
            if (normalizedName.includes('boxeo')) return 120; 
            
            // Valor por defecto para otros eventos no clasificados (1 hora y 45 minutos)
            return 105; 
        }

        function getEventTime(dateString, timeString) {
            const now = new Date();
            const date = parseDateString(dateString, now);
            if (date.getTime() === now.getTime()) {
                date.setHours(now.getHours());
                date.setMinutes(now.getMinutes());
            }
            const [hours, minutes] = timeString.split(':').map(Number);
            const eventTime = new Date(date);
            eventTime.setHours(hours, minutes, 0, 0);
            const todayYear = now.getFullYear();
            const todayMonth = now.getMonth();
            const todayDate = now.getDate();
            if (dateString.toLowerCase() === 'hoy' || (eventTime.getDate() === todayDate && eventTime.getMonth() === todayMonth && eventTime.getFullYear() === todayYear)) {
                return eventTime;
            }
            return eventTime;
        }

        function processEventsData(htmlContent) {
            const numberedChannels = [];
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const table = doc.querySelector('table');
            if (!table) {
                console.warn("No se encontr칩 la tabla de eventos");
                return numberedChannels;
            }
            const rows = table.querySelectorAll('tbody tr');
            const channelMappings = {
                'Movistar': 'M+',
                'DAZN LA LIGA 1': 'DAZN La Liga',
                'LALIGA': 'La Liga',
                'Premier': 'Premier League',
                'Eurosport': '驕EUROSPORT',
                'HYPERMOTION': 'La Liga Hypermotion',
                'LIGA DE CAMPEONES': 'M+ Liga de Campeones',
                'PLUS': 'Plus',
                'VAMOS': 'Vamos',
                'Deportes': 'Deportes'
            };
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6) {
                    const date = cells[0].textContent.trim();
                    const time = cells[1].textContent.trim();
                    const sportName = cells[2].textContent.trim();
                    const competition = cells[3].textContent.trim();
                    const match = cells[4].textContent.trim();
                    const canalesCell = cells[5];
                    const links = canalesCell.querySelectorAll('a[href^="acestream://"]');
                    if (links.length > 0) {
                        let sportEmoji = '仇';
                        const normalizedSport = normalizeText(sportName);
                        if (normalizedSport.includes('futbol')) {
                            sportEmoji = '丘';
                        } else if (normalizedSport.includes('handball') || normalizedSport.includes('balonmano')) {
                            sportEmoji = '游쮝꽥뗵勇';
                        } else if (normalizedSport.includes('baloncesto') || normalizedSport.includes('basket') || normalizedSport.includes('nba')) {
                            sportEmoji = '游';
                        } else if (normalizedSport.includes('tenis')) {
                            sportEmoji = '游';
                        } else if (normalizedSport.includes('motogp') || normalizedSport.includes('motos')) {
                            sportEmoji = '游끬勇';
                        } else if (normalizedSport.includes('paddle') || normalizedSport.includes('padel')) {
                            sportEmoji = '游볥';
                        } else if (normalizedSport.includes('triatlon') || normalizedSport.includes('triathlon')) {
                            sportEmoji = '游끩游뛊游끢';
                        } else if (normalizedSport.includes('motor') || normalizedSport.includes('rally')) {
                            sportEmoji = '游뚱';
                        } else if (normalizedSport.includes('f1') || normalizedSport.includes('formula')) {
                            sportEmoji = '游끭勇';
                        } else if (normalizedSport.includes('boxeo') || normalizedSport.includes('lucha')) {
                            sportEmoji = '游볡';
                        } else if (normalizedSport.includes('ciclismo') || normalizedSport.includes('tour')) {
                            sportEmoji = '游뛊';
                        } else if (normalizedSport.includes('beisbol') || normalizedSport.includes('baseball')) {
                            sportEmoji = '丘';
                        } else if (normalizedSport.includes('golf')) {
                            sportEmoji = '久';
                        } else if (normalizedSport.includes('voleibol') || normalizedSport.includes('voley')) {
                            sportEmoji = '游끯';
                        } else if (normalizedSport.includes('hockey')) {
                            sportEmoji = '游끰';
                        } else if (normalizedSport.includes('rugby')) {
                            sportEmoji = '游끨';
                        } else if (normalizedSport.includes('natacion') || normalizedSport.includes('agua')) {
                            sportEmoji = '游끩';
                        } else if (normalizedSport.includes('atletismo') || normalizedSport.includes('pista')) {
                            sportEmoji = '游끢';
                        } else if (normalizedSport.includes('gimnasia')) {
                            sportEmoji = '游뱢';
                        } else if (normalizedSport.includes('esqui') || normalizedSport.includes('nieve')) {
                            sportEmoji = '久勇';
                        } else if (normalizedSport.includes('surf')) {
                            sportEmoji = '游끣';
                        } else if (normalizedSport.includes('e-sports') || normalizedSport.includes('esports')) {
                            sportEmoji = '游꿡';
                        } else if (normalizedSport.includes('ajedrez')) {
                            sportEmoji = '鮫勇';
                        } else if (normalizedSport.includes('dardos')) {
                            sportEmoji = '游꿢';
                        } else if (normalizedSport.includes('billares') || normalizedSport.includes('pool')) {
                            sportEmoji = '游꿤';
                        } else if (normalizedSport.includes('patinaje') || normalizedSport.includes('roller')) {
                            sportEmoji = '久젎잺';
                        } else if (normalizedSport.includes('criquet') || normalizedSport.includes('cricket')) {
                            sportEmoji = '游끮';
                        }
                        const eventStartTime = getEventTime(date, time);
                        const durationMinutes = calculateDuration(sportName);
                        const eventEndTime = new Date(eventStartTime.getTime() + durationMinutes * 60000);
                        links.forEach(link => {
                            const acestreamId = link.href.split('://')[1];
                            let channelName = link.textContent.trim();
                            for (const key in channelMappings) {
                                const regex = new RegExp(key, 'gi');
                                channelName = channelName.replace(regex, channelMappings[key]);
                            }
                            let simplifiedName = channelName
                                .replace(/Estable|New Era II|New Loop|New Era VI|FHD|4K|HD|UHD|MultiAudio|SD|\(.*?\)|-->.*$/g, '')
                                .replace(/\s+/g, ' ')
                                .trim();
                            let quality = '720p';
                            if (channelName.includes('1080') || channelName.includes('FHD')) quality = '1080p';
                            if (channelName.includes('UHD') || channelName.includes('4K')) quality = 'UHD';
                            if (channelName.includes('SD') && !channelName.includes('FHD')) quality = 'SD';
                            const multiAudio = channelName.includes('Multi') || channelName.includes('multi');
                            simplifiedName = normalizeChannelName(simplifiedName);
                            numberedChannels.push({
                                id: acestreamId,
                                number: acestreamId.substring(0, 3),
                                name: simplifiedName,
                                quality: quality,
                                multiAudio: multiAudio,
                                source: 'events',
                                event: {
                                    time,
                                    competition,
                                    match,
                                    date,
                                    sportEmoji,
                                    sportName,
                                    startTime: eventStartTime.getTime(),
                                    endTime: eventEndTime.getTime(),
                                    durationMinutes // Nuevo campo para el Stage
                                }
                            });
                            trackFirstSeen(acestreamId);
                        });
                    }
                }
            });
            return numberedChannels;
        }

        function processChannelNames() {
            const brands = [{
                name: 'M+',
                class: 'movistar'
            }, {
                name: '驕Eurosport',
                class: 'eurosport'
            }, {
                name: 'DAZN',
                class: 'dazn'
            }, {
                name: 'F1',
                class: 'f1'
            }, {
                name: 'Acci칩n',
                class: 'action'
            }, {
                name: 'Deportes',
                class: 'sports'
            }, {
                name: 'Cl치sicos',
                class: 'cinema-red'
            }, {
                name: 'Vamos',
                class: 'vamos'
            }, {
                name: 'Copa del Rey',
                class: 'copadelrey'
            }, {
                name: 'Liga de Campeones',
                class: 'champions'
            }, {
                name: 'La Liga',
                class: 'liga'
            }, {
                name: 'Hypermotion',
                class: 'hypermotion'
            }, {
                name: 'Golf',
                class: 'golf'
            }, {
                name: '驕EUROSPORT\\d+',
                class: 'eurosport-number',
                regex: true
            }, {
                name: 'Smartbank',
                class: 'smartbank'
            }, {
                name: 'Plus',
                class: 'plus'
            }, {
                name: 'Western',
                class: 'western'
            }, {
                name: 'Documentales',
                class: 'documentary'
            }, {
                name: 'Originales',
                class: 'originals'
            }, {
                name: 'Hits',
                class: 'cinema-red'
            }, {
                name: 'Estrenos',
                class: 'cinema-red'
            }, {
                name: 'Indie',
                class: 'cinema-red'
            }, {
                name: 'Cine Espa침ol',
                class: 'cinema-red'
            }, {
                name: 'Drama',
                class: 'cinema-red'
            }, {
                name: 'Ellas',
                class: 'ellas'
            }, {
                name: 'Series',
                class: 'series'
            }];
            state.channelsData.forEach(channel => {
                let result = channel.name;
                brands.forEach(brand => {
                    if (brand.regex) {
                        const regex = new RegExp(`(${brand.name})`, 'gi');
                        result = result.replace(regex, `<span class="${brand.class}">$1</span>`);
                    } else {
                        const escapedName = brand.name.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                        const regex = new RegExp(`(${escapedName})`, 'gi');
                        result = result.replace(regex, `<span class="${brand.class}">$1</span>`);
                    }
                });
                const comediaRegex = /(comedia)/gi;
                result = result.replace(comediaRegex, '<span class="degradado-comedia">Comedia</span>');
                channel.displayableName = result;
            });
        }

        function compareChannelsForSort(a, b) {
            const channelA = state.channelsData.find(c => c.id === a.id) || a;
            const channelB = state.channelsData.find(c => c.id === b.id) || b;
            
            const ratingA = state.channelRatings[channelA.id] !== undefined ? state.channelRatings[channelA.id] : 2.5;
            const ratingB = state.channelRatings[channelB.id] !== undefined ? state.channelRatings[channelB.id] : 2.5;

            if (ratingA !== ratingB) {
                return ratingB - ratingA;
            }
            
            const qualityMap = { 'UHD': 6, '4K': 5, 'FHD': 4, 'HD': 3, 'SD': 2, 'N/A': 1 };
            const qualityA = qualityMap[standardizeQuality(channelA.quality)] || 0;
            const qualityB = qualityMap[standardizeQuality(channelB.quality)] || 0;
            if (qualityB !== qualityA) {
                return qualityB - qualityA;
            }
            
            return channelA.name.localeCompare(channelB.name);
        }

        function getBestChannelInSubgroup(channels) {
            if (!channels || channels.length === 0) return null;
            
            const mainChannelName = channels[0].name.trim().toLowerCase();
            const lastPlayedId = state.lastPlayedByChannel[mainChannelName];

            if (lastPlayedId) {
                const lastPlayedChannel = channels.find(c => c.id === lastPlayedId);
                if (lastPlayedChannel) {
                    const rating = state.channelRatings[lastPlayedId] !== undefined ? state.channelRatings[lastPlayedId] : 2.5;
                    if (rating >= 3) {
                         const others = channels.filter(c => c.id !== lastPlayedId);
                         return [lastPlayedChannel, ...others].sort(compareChannelsForSort)[0];
                    }
                }
            }
            
            const sortedChannels = [...channels].sort((a, b) => {
                const ratingA = state.channelRatings[a.id] !== undefined ? state.channelRatings[a.id] : 2.5;
                const ratingB = state.channelRatings[b.id] !== undefined ? state.channelRatings[b.id] : 2.5;
                if (ratingA !== ratingB) {
                    return ratingB - ratingA;
                }
                if (a.isLive && !b.isLive) return -1;
                if (!a.isLive && b.isLive) return 1;
                const qualityMap = {
                    'UHD': 6,
                    '4K': 5,
                    'FHD': 4,
                    'HD': 3,
                    'SD': 2,
                    'N/A': 1
                };
                const qualityA = qualityMap[standardizeQuality(a.quality)] || 0;
                const qualityB = qualityMap[standardizeQuality(b.quality)] || 0;
                if (qualityB !== qualityA) {
                    return qualityB - qualityA;
                }
                const sourcePriorityMap = {
                    'gist': 4,
                    'era': 3,
                    'events': 2,
                    'shickat': 1,
                    'elcano': 0,
                    'history': -1
                };
                const sourceA = sourcePriorityMap[a.source] || 0;
                const sourceB = sourcePriorityMap[b.source] || 0;
                if (sourceB !== sourceA) {
                    return sourceB - sourceA;
                }
                return a.name.localeCompare(b.name);
            });
            return sortedChannels[0];
        }

        function getGroupedChannels() {
            const filteredChannels = filterChannels();
            const allEventChannels = state.channelsData.filter(c => c.source === 'events');
            filteredChannels.forEach(channel => {
                channel.isLive = isChannelLive(channel, allEventChannels);
            });
            const sortedChannels = [...filteredChannels].sort((a, b) => {
                if (a.isLive && !b.isLive) return -1;
                if (!a.isLive && b.isLive) return 1;
                const aIsOff = a.name.includes('(OFF)');
                const bIsOff = b.name.includes('(OFF)');
                if (aIsOff && !bIsOff) return 1;
                if (!aIsOff && bIsOff) return -1;
                const nameNumberA = getChannelNumberFromName(a.name);
                const nameNumberB = getChannelNumberFromName(b.name);
                if (nameNumberA !== nameNumberB) {
                    return nameNumberA - nameNumberB;
                }
                const qualityMap = {
                    '4K': 5,
                    'FHD': 4,
                    'HD': 3,
                    'SD': 2,
                    'N/A': 1,
                    'UHD': 6
                };
                const qualityA = qualityMap[standardizeQuality(a.quality)] || 0;
                const qualityB = qualityMap[standardizeQuality(b.quality)] || 0;
                if (qualityB !== qualityA) {
                    return qualityB - qualityA;
                }
                const sourcePriorityMap = {
                    'gist': 4,
                    'era': 3,
                    'events': 2,
                    'shickat': 1,
                    'elcano': 0,
                    'history': -1
                };
                const sourceA = sourcePriorityMap[a.source] || 0;
                const sourceB = sourcePriorityMap[b.source] || 0;
                if (sourceB !== sourceA) {
                    return sourceB - sourceA;
                }
                return a.name.localeCompare(b.name);
            });
            const groups = {};
            const eventGroupKeysByChannelName = new Map();
            sortedChannels.forEach(channel => {
                let groupName;
                let isEventGroup = false;
                if (channel.source === 'events' && channel.event) {
                    if (state.hideEventDetails) {
                        groupName = determineBrandGroup(channel);
                    } else {
                        groupName = `${channel.event.date}###${channel.event.competition}###${channel.event.match}`;
                        isEventGroup = true;
                        const normalizedChannelName = normalizeText(channel.name);
                        if (!eventGroupKeysByChannelName.has(normalizedChannelName)) {
                            eventGroupKeysByChannelName.set(normalizedChannelName, new Set());
                        }
                        eventGroupKeysByChannelName.get(normalizedChannelName).add(groupName);
                    }
                } else {
                    groupName = determineBrandGroup(channel);
                    const normalizedChannelName = normalizeText(channel.name);
                    if (!state.hideEventDetails && eventGroupKeysByChannelName.has(normalizedChannelName)) {
                        const eventGroupKeys = eventGroupKeysByChannelName.get(normalizedChannelName);
                        for (const eventGroupKey of eventGroupKeys) {
                            const eventGroup = groups[eventGroupKey];
                            if (eventGroup) {
                                eventGroup.channels.push(channel);
                                return;
                            }
                        }
                    }
                }
                if (!groups[groupName]) {
                    groups[groupName] = {
                        name: groupName,
                        channels: [],
                        isEvent: isEventGroup,
                        time: isEventGroup ? channel.event.time : null,
                        date: isEventGroup ? channel.event.date : null,
                        sportEmoji: isEventGroup ? channel.event.sportEmoji : null,
                        sportName: isEventGroup ? channel.event.sportName : null,
                        competition: isEventGroup ? channel.event.competition : null,
                        match: isEventGroup ? channel.event.match : null,
                        hasLive: channel.isLive
                    };
                } else {
                    if (channel.isLive) {
                        groups[groupName].hasLive = true;
                    }
                }
                groups[groupName].channels.push(channel);
            });
            Object.values(groups).forEach(group => {
                const subGroups = {};
                group.channels.forEach(channel => {
                    let subGroupName = channel.name.trim();
                    if (group.name === 'Otros') {
                        const normalizedChannelName = normalizeText(channel.name);
                        let foundSubGroup = null;
                        for (const subGroupKey of OTHER_SUBGROUPS) {
                            const normalizedSubGroupKey = normalizeText(subGroupKey);
                            if (normalizedChannelName.includes(normalizedSubGroupKey)) {
                                foundSubGroup = subGroupKey;
                                break;
                            }
                        }
                        subGroupName = foundSubGroup || subGroupName;
                    }
                    if (subGroupName.includes('DAZN') && subGroupName.includes('BAR')) {
                        subGroupName = subGroupName.replace(' BAR', '').trim();
                    }
                    if (!subGroups[subGroupName]) {
                        subGroups[subGroupName] = [];
                    }
                    subGroups[subGroupName].push(channel);
                });
                group.subGroups = subGroups;
            });
            const sortedGroupKeys = Object.keys(groups).sort((a, b) => {
                const groupA = groups[a];
                const groupB = groups[b];
                const aHasLive = groupA.channels.some(c => c.isLive);
                const bHasLive = groupB.channels.some(c => c.isLive);
                if (aHasLive && !bHasLive) return -1;
                if (!aHasLive && bHasLive) return 1;
                if (groupA.isEvent && groupB.isEvent) {
                    const dateCompare = compareEventDates(groupA, groupB);
                    if (dateCompare !== 0) return dateCompare;
                    return a.localeCompare(b);
                }
                if (groupA.isEvent && !groupB.isEvent) return -1;
                if (!groupA.isEvent && groupB.isEvent) return 1;
                const indexA = groupOrder.indexOf(a);
                const indexB = groupOrder.indexOf(b);
                if (indexA === -1 && indexB === -1) {
                    return a.localeCompare(b);
                }
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            if (groups['Otros']) {
                sortedGroupKeys.push(sortedGroupKeys.splice(sortedGroupKeys.indexOf('Otros'), 1)[0]);
            }
            return {
                groups,
                sortedGroupKeys
            };
        }

        function filterChannels() {
            let filteredChannels = state.channelsData;
            const searchTerm = state.tvSearchTerm.trim().toLowerCase();
            state.searchTerm = state.tvSearchTerm.trim();

            if (searchTerm) {
                filteredChannels = filteredChannels.filter(channel => {
                    const normalizedSearchTerm = normalizeText(searchTerm);
                    const nameMatches = normalizeText(channel.name).includes(normalizedSearchTerm);
                    const idMatches = channel.id && channel.id.toLowerCase().includes(normalizedSearchTerm.replace('#', ''));
                    let eventDetailsMatch = false;
                    if (channel.event) {
                        const {
                            time,
                            competition,
                            match,
                            date,
                            sportName
                        } = channel.event;
                        eventDetailsMatch = normalizeText(time || '').includes(normalizedSearchTerm) || normalizeText(sportName || '').includes(normalizedSearchTerm) || normalizeText(competition || '').includes(normalizedSearchTerm) || normalizeText(match || '').includes(normalizedSearchTerm) || normalizeText(date || '').includes(normalizedSearchTerm);
                    }
                    return nameMatches || idMatches || eventDetailsMatch;
                });
            }

            let currentFilter = state.tvCurrentFilter;
            let currentSportFilter = state.tvSportFilter;
            
            if (currentSportFilter !== 'all') {
                currentFilter = 'all'; 
            }

            if (currentFilter === 'favorites') {
                filteredChannels = filteredChannels.filter(c => state.favorites.includes(c.id));
            } else if (currentFilter === 'live') {
                filteredChannels = filteredChannels.filter(c => {
                    const allEventChannels = state.channelsData.filter(ch => ch.source === 'events');
                    return isChannelLive(c, allEventChannels);
                });
            } else if (currentFilter !== 'all' && currentFilter !== 'live' && currentFilter !== 'favorites') {
                filteredChannels = filteredChannels.filter(channel => normalizeText(channel.name).includes(normalizeText(currentFilter.replace('+', ''))));
            }

            if (currentSportFilter !== 'all') {
                const normalizedSportFilter = normalizeText(currentSportFilter);
                const sportSearchTerms = {
                    'futbol': ['futbol', 'soccer', 'Hypermotion', 'copa del rey', 'premier league', 'bundesliga', 'serie a'],
                    'baloncesto': ['baloncesto', 'basket', 'nba', 'euroliga'],
                    'tenis': ['tenis', 'wimbledon', 'roland garros', 'us open', 'atp', 'wta'],
                    'motorsport': ['gp', 'motogp', 'dakar', 'rally', 'wrc', 'nascar', 'motor'],
                    'f1': ['f1', 'f칩rmula 1', 'formula 1', 'formulaone', 'f칩rmulaone']
                };
                let targetTerms = sportSearchTerms[normalizedSportFilter] || [normalizedSportFilter];
                if (normalizedSportFilter === 'motorsport' && sportSearchTerms['f1']) {
                    targetTerms = targetTerms.concat(sportSearchTerms['f1']);
                }
                filteredChannels = filteredChannels.filter(channel => {
                    const normalizedName = normalizeText(channel.name);
                    const eventDetailsMatch = channel.event && (
                        normalizeText(channel.event.sportName || '').includes(normalizedSportFilter) ||
                        targetTerms.some(term => normalizeText(channel.event.competition || '').includes(term)) ||
                        targetTerms.some(term => normalizeText(channel.event.match || '').includes(term))
                    );
                    const nameMatch = targetTerms.some(term => normalizedName.includes(term));
                    return eventDetailsMatch || nameMatch;
                });
            }

            return filteredChannels;
        }

        function standardizeQuality(quality) {
            if (!quality) return 'SD';
            quality = quality.toLowerCase();
            if (quality.includes('uhd') || quality.includes('4k')) {
                return '4K';
            }
            if (quality.includes('1080') || quality.includes('fhd')) {
                return 'FHD';
            }
            if (quality.includes('720') || quality.includes('hd')) {
                return 'HD';
            }
            return 'SD';
        }

        function getChannelNumberFromName(name) {
            const match = name.match(/\d+/);
            return match ? parseInt(match[0], 10) : 1;
        }

        function formatEventDate(dateString) {
            const normalizedDate = dateString.toLowerCase();
            const today = new Date();

            // 1. Manejar "Hoy", "Ma침ana", "Ayer" (Devolver solo el d칤a)
            if (normalizedDate === 'hoy' || normalizedDate === 'ma침ana' || normalizedDate === 'ayer') {
                const date = parseDateString(dateString, today);
                const weekdays = ['Domingo', 'Lunes', 'Martes', 'Mi칠rcoles', 'Jueves', 'Viernes', 'S치bado'];
                
                // Si es "Hoy" o "Ma침ana", devolvemos la palabra en espa침ol para la conjugaci칩n correcta (Eventos de Hoy)
                if (normalizedDate === 'hoy' || normalizedDate === 'ma침ana') {
                    return normalizedDate.charAt(0).toUpperCase() + normalizedDate.slice(1);
                }
                
                // Si es "Ayer", devolvemos el d칤a de la semana para una mejor UX
                return weekdays[date.getDay()];
            }

            // 2. Manejar formato de fecha DD/MM/YY o DD/MM/YYYY (Devolver "el [D칤a] [fecha]")
            const parts = dateString.split('/');
            if (parts.length >= 2 && parts.length <= 3) {
                const date = parseDateString(dateString, today);
                const weekdays = ['Domingo', 'Lunes', 'Martes', 'Mi칠rcoles', 'Jueves', 'Viernes', 'S치bado'];
                
                // Devuelve el d칤a y la fecha original (ej: "el S치bado 13/7/25")
                return `el ${weekdays[date.getDay()]} ${dateString}`; 
            }
            
            // 3. Fallback: Devolver la cadena original
            return dateString; 
        }

        function compareEventDates(eventA, eventB) {
            const today = new Date();
            const dateStringA = eventA.date.toLowerCase();
            const dateStringB = eventB.date.toLowerCase();
            
            const isTodayA = dateStringA === 'hoy';
            const isTodayB = dateStringB === 'hoy';
            const isTomorrowA = dateStringA === 'ma침ana';
            const isTomorrowB = dateStringB === 'ma침ana';
            const isYesterdayA = dateStringA === 'ayer';
            const isYesterdayB = dateStringB === 'ayer';
            
            if (isTodayA && !isTodayB) return -1;
            if (!isTodayA && isTodayB) return 1;
            if (isTodayA && isTodayB) return eventA.time.localeCompare(eventB.time);

            if (isTomorrowA && !isTomorrowB) return -1;
            if (!isTomorrowA && isTomorrowB) return 1;
            if (isTomorrowA && isTomorrowB) return eventA.time.localeCompare(eventB.time);
            
            if (isYesterdayA && !isYesterdayB) return -1;
            if (!isYesterdayA && isYesterdayB) return 1;
            if (isYesterdayA && isYesterdayB) return eventA.time.localeCompare(eventB.time);

            const dateA = parseDateString(eventA.date, today);
            const dateB = parseDateString(eventB.date, today);
            
            if (dateA.getTime() !== dateB.getTime()) {
                return dateA.getTime() - dateB.getTime();
            }
            return eventA.time.localeCompare(eventB.time);
        }

        function parseDateString(dateString, today) {
            const normalizedDate = dateString.toLowerCase();
            if (normalizedDate === 'ma침ana') {
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                return tomorrow;
            }
            if (normalizedDate === 'ayer') {
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                return yesterday;
            }
            const parts = dateString.split('/');
            if (parts.length >= 2 && parts.length <= 3) {
                // Asume formato DD/MM/YY o DD/MM/YYYY
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // Mes es 0-indexado
                let year = parts[2] ? parseInt(parts[2], 10) : today.getFullYear();
                
                if (parts.length === 2) {
                     year = today.getFullYear(); // Si falta el a침o, usa el actual
                }
                
                if (year < 100) {
                     year = year + 2000;
                }
                
                const date = new Date(year, month, day);
                
                // Validaci칩n b치sica para evitar fechas inv치lidas que JS pueda interpretar
                if (date.getDate() !== day || date.getMonth() !== month || date.getFullYear() !== year) {
                    return today;
                }

                return date;
            }
            return today;
        }

        function isChannelLive(channel, allEventChannels) {
            if (channel.source !== 'events' || !channel.event) {
                return false;
            }
            const now = new Date().getTime();
            const event = channel.event;
            const liveStartTime = event.startTime - (15 * 60 * 1000);
            const liveEndTime = event.endTime;
            const isTimeframeLive = now >= liveStartTime && now <= liveEndTime;
            if (!isTimeframeLive) {
                return false;
            }
            const isConflicted = findConflictingSiblings(channel, allEventChannels);
            if (isConflicted) {
                return false;
            }
            return true;
        }

        function findConflictingSiblings(currentChannel, allEventChannels) {
            const currentChannelName = normalizeText(currentChannel.name);
            const currentStartTime = currentChannel.event.startTime;
            const conflictingSibling = allEventChannels.find(sibling => {
                if (sibling.id === currentChannel.id || sibling.source !== 'events' || !sibling.event) {
                    return false;
                }
                const siblingChannelName = normalizeText(sibling.name);
                const siblingStartTime = sibling.event.startTime;
                const isSameChannelName = siblingChannelName === currentChannelName;
                const isScheduledLater = siblingStartTime > currentStartTime;
                if (isSameChannelName && isScheduledLater) {
                    const now = new Date().getTime();
                    const siblingLiveStartTime = siblingStartTime - (15 * 60 * 1000);
                    if (now >= siblingLiveStartTime) {
                        return true;
                    }
                }
                return false;
            });
            return !!conflictingSibling;
        }
        const groupOrder = [
            'DAZN F1',
            'DAZN',
            'DAZN La Liga',
            'M+ La Liga',
            'Liga de Campeones',
            'La Liga Hypermotion',
            'M+ Vamos',
            'M+ Deportes',
            'M+ Plus',
            'M+ Golf',
            'M+',
            '驕EUROSPORT'
        ];
        const groupRegexes = {
            'DAZN F1': /DAZN F1/i,
            'DAZN': /DAZN(?!.*F1|.*La Liga)/i,
            'DAZN La Liga': /DAZN La Liga/i,
            'Liga de Campeones': /Liga de Campeones/i,
            'La Liga Hypermotion': /La Liga Hypermotion/i,
            'M+ La Liga': /M\+ La Liga/i,
            'M+ Vamos': /M\+ Vamos/i,
            'M+ Deportes': /M\+ Deportes/i,
            'M+ Plus': /M\+ Plus/i,
            'M+ Golf': /M\+ Golf/i,
            'M+': /M\+(?!.*La Liga|.*Vamos|.*Deportes|.*Plus|.*Golf|.*Liga de Campeones)/i,
            '驕EUROSPORT': /驕EUROSPORT/i,
        };

        function determineBrandGroup(channel) {
            const channelName = channel.name;
            const normalizedName = normalizeText(channelName);
            if (channelName.includes('驕EUROSPORT') && channelName.includes('(')) {
                return 'Otros';
            }
            if (groupRegexes['DAZN'] && groupRegexes['DAZN'].test(channelName)) {
                if (normalizedName.includes('eventos') || normalizedName.includes('eleven')) {
                    return 'Otros';
                }
            }
            for (const groupName of groupOrder) {
                if (groupRegexes[groupName] && groupRegexes[groupName].test(channelName)) {
                    return groupName;
                }
            }
            return 'Otros';
        }

        function playChannel(acestreamId) {
            const acestreamUrl = `acestream://${acestreamId}`;
            const newWindow = window.open(acestreamUrl, '_blank');
            setTimeout(() => {
                if (newWindow && newWindow.closed) {} else {}
            }, 500);
        }

        function handleChannelPlay(channelToPlay) {
            if (state.lastChannelPlay) {
                updateChannelRating(state.lastChannelPlay.channelId, channelToPlay.id);
            }
            
            const now = new Date().getTime();
            state.lastChannelPlay = {
                channelId: channelToPlay.id,
                timestamp: now
            };
            localStorage.setItem('lastChannelPlay', JSON.stringify(state.lastChannelPlay));
            
            state.lastPlayedByChannel[channelToPlay.name.trim().toLowerCase()] = channelToPlay.id;
            localStorage.setItem('lastPlayedByChannel', JSON.stringify(state.lastPlayedByChannel));

            playChannel(channelToPlay.id);
        }

        function updateChannelRating(previousChannelId, currentChannelId) {
            const now = new Date().getTime();
            const previousChannelData = state.channelsData.find(c => c.id === previousChannelId);
            
            if (!previousChannelData) return;

            const duration = (now - state.lastChannelPlay.timestamp) / 1000;
            let rating = state.channelRatings[previousChannelId] !== undefined ? state.channelRatings[previousChannelId] : 2.5;
            let newRating = rating;
            
            const previousName = previousChannelData.name.toLowerCase().trim();
            const currentChannelData = state.channelsData.find(c => c.id === currentChannelId);
            const currentName = currentChannelData ? currentChannelData.name.toLowerCase().trim() : '';

            if (previousChannelId !== currentChannelId && previousName === currentName) {
                if (duration >= (30 * 60)) {
                    newRating += 1.5;
                } else if (duration >= (15 * 60)) {
                    newRating += 0.5;
                } else if (duration >= (5 * 60)) {
                    newRating -= 1;
                } else if (duration >= 10) {
                    newRating -= 1.5;
                } else {
                    newRating -= 2;
                }
            } else if (previousChannelId !== currentChannelId && previousName !== currentName) {
                if (duration >= (30 * 60)) {
                    newRating += 1.5;
                } else {
                    newRating = rating;
                }
            } else if (previousChannelId === currentChannelId) {
                return;
            }
            
            state.channelRatings[previousChannelId] = Math.max(1, Math.min(5, newRating));
            saveRatings();
            
            renderTVChannels();
        }

        function showCopyModal(acestreamId) {
            const acestreamUrl = `acestream://${acestreamId}`;
            const copyModal = document.getElementById('copyModal');
            const copyAceStreamBtn = document.getElementById('copyAceStreamBtn');
            const urlDisplayAceStream = document.getElementById('copyUrlDisplayAceStream');
            urlDisplayAceStream.textContent = acestreamUrl;
            copyAceStreamBtn.onclick = () => copyUrlToClipboard(acestreamUrl, 'AceStream');
            copyModal.classList.add('active');
        }

        async function copyAcestreamDirectly(acestreamId) {
            const acestreamUrl = `acestream://${acestreamId}`;
            try {
                await navigator.clipboard.writeText(acestreamUrl);
                showCopySuccessMessage('AceStream');
            } catch (err) {
                console.error('Error al copiar el texto: ', err);
                alert('No se pudo copiar la URL. Por favor, hazlo manualmente.');
            }
        }

        function hideCopyModal() {
            document.getElementById('copyModal').classList.remove('active');
        }

        function showCopySuccessMessage(format = 'AceStream') {
            const messageElement = document.getElementById('copyMessage');
            messageElement.textContent = `${format} URL copiada con 칠xito!`;
            messageElement.classList.add('show');
            setTimeout(() => {
                messageElement.classList.remove('show');
            }, 2000);
        }

        async function copyUrlToClipboard(urlToCopy, format) {
            try {
                await navigator.clipboard.writeText(urlToCopy);
                hideCopyModal();
                showCopySuccessMessage(format);
            } catch (err) {
                console.error('Error al copiar el texto: ', err);
                alert('No se pudo copiar la URL. Por favor, hazlo manualmente.');
            }
        }

        function changePrimaryColor(color) {
            state.primaryColor = color;
            const rgb = hexToRgb(color);
            document.documentElement.style.setProperty('--primary-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`);
            document.documentElement.style.setProperty('--primary', color);
            document.documentElement.style.setProperty('--primary-dark', color === '#2563eb' ? '#1e50c7' : color);
            updatePrimaryLightColor();
            document.querySelectorAll('.color-option').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.color-option[data-color="${color}"]`).classList.add('active');
            localStorage.setItem('primaryColor', color);
            renderTVChannels();
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return {
                r,
                g,
                b
            };
        }

        function updatePrimaryLightColor() {
            const rgb = hexToRgb(state.primaryColor);
            const isDarkMode = document.body.classList.contains('dark-mode');
            document.documentElement.style.setProperty('--primary-light', isDarkMode ? `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.2)` : `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1)`);
        }

        function cleanObsoleteRatings() {
            const activeChannelIds = new Set(state.channelsData.map(c => c.id));
            const ratingsToKeep = {};
            for (const channelId in state.channelRatings) {
                if (activeChannelIds.has(channelId)) {
                    ratingsToKeep[channelId] = state.channelRatings[channelId];
                }
            }
            state.channelRatings = ratingsToKeep;
            saveRatings();
            console.log("Puntuaciones de canales obsoletas limpiadas.");
        }

        function saveRatings() {
            localStorage.setItem('channelRatings', JSON.stringify(state.channelRatings));
        }

        function resetRatings() {
            if (confirm('쮼st치s seguro de que quieres restablecer todas las puntuaciones de los canales?')) {
                localStorage.removeItem('channelRatings');
                state.channelRatings = {};
                renderTVChannels();
                showStatusMessage("Puntuaciones de canales restablecidas.", "success");
                document.getElementById('settingsModal').classList.remove('modal--active');
            }
        }

        function getStarRating(score) {
            const fullStars = Math.floor(score);
            const hasHalfStar = score % 1 >= 0.5;
            let stars = '驕'.repeat(fullStars);
            if (hasHalfStar) {
                stars += '<span class="half-star">驕</span>';
            }
            const emptyStars = '驕'.repeat(5 - fullStars - (hasHalfStar ? 1 : 0));
            return `<span style="color: var(--primary);">${stars}</span><span style="color: gray;">${emptyStars}</span>`;
        }

        function restoreTVFilterUI() {
            clearAllTVFilterVisuals();

            if (state.tvSportFilter !== 'all') {
                const sportBtn = document.querySelector(`.tv-nav-link[data-sport-key="${state.tvSportFilter}"]`);
                if (sportBtn) {
                    sportBtn.classList.add('tv-sidebar-link-focused');
                }
            } else {
                const brandLink = document.querySelector(`.tv-nav-link[data-filter="${state.tvCurrentFilter}"]`);
                if (brandLink) {
                    brandLink.classList.add('tv-sidebar-link-focused');
                }
            }
        }
        
        const createTVChannelCard = (channel, allOptionsJson = '[]') => {
            const logoInfo = getPlaceholderInfo(channel.name);
            const isLiveClass = '';
            let bgColor = 'var(--card-bg)';
            let backgroundImageStyle = '';
            let logoClass = '';
            let nameStyle = 'white';

            let channelNameHTML = `<h3 style="font-size: 0.6rem; font-weight: 700; color: ${nameStyle}; white-space: normal; text-align: center;">${channel.displayableName}</h3>`;

            let liveIndicator = '';
            if (channel.isLive) {
                liveIndicator = `<span style="color: var(--primary); font-weight: 700; animation: soft-blink 1.5s infinite ease-in-out;">游댮 EN VIVO</span>`;
            }

            if (logoInfo) {
                const fullUrl = LOGOPEDIA_BASE_URL + logoInfo.url;
                const proxiedUrl = proxyImage(fullUrl);
                backgroundImageStyle = `background-image: url('${proxiedUrl}');`;
                logoClass = logoInfo.class;

                channelNameHTML = `<h3 style="font-size: 0.6rem; font-weight: 700; color: ${nameStyle}; white-space: normal; text-align: center; opacity: 0;">${channel.displayableName}</h3>`;
                
            } else {
                if (channel.name.includes('DAZN') && !channel.name.includes('F1')) bgColor = '#353535';
                else if (channel.name.includes('DAZN F1')) bgColor = '#353535';
                else if (channel.name.includes('M+')) bgColor = '#0085C1';
                else if (channel.name.includes('EUROSPORT')) bgColor = '#5e17eb';
                backgroundImageStyle = `background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%), ${bgColor};`;

                channelNameHTML = `<div style="position: absolute; bottom: 5px; left: 5px; right: 5px; text-align: center;"><h3 style="font-size: 0.6rem; font-weight: 700; color: ${nameStyle}; white-space: normal; margin: 0;">${channel.displayableName}</h3></div>`;
            }

            const rating = state.channelRatings[channel.id] !== undefined ? state.channelRatings[channel.id] : 2.5;
            const ratingStars = getStarRating(rating);
            const optionsButton = `<button class="tv-link-button" data-channel-id="${channel.id}" title="Ver opciones alternativas">+</button>`;

            return ` <div class="tv-card ${isLiveClass} ${logoClass}" data-channel-id="${channel.id}" data-all-options='${allOptionsJson}' style="${backgroundImageStyle}" tabindex="0" role="button" aria-label="Ver canal ${channel.name}"> ${optionsButton} ${channelNameHTML}</div> `;
        };

        function createTVChannelsHTML(groups, sortedGroupKeys) {
            if (sortedGroupKeys.length === 0) {
                // Nuevo HTML para el mensaje de no resultados, envuelto en el nuevo div para centrar
                return `
                    <div class="no-results-container">
                        <div class="no-results">
                            <div class="no-results-icon">游니</div>
                            <div class="no-results-text">No se encontraron canales</div>
                            <div class="no-results-hint">Prueba con otros filtros o t칠rminos de b칰squeda</div>
                        </div>
                    </div>
                `;
            }
            
            let html = '';
            let lastDateRendered = null;
            for (const groupKey of sortedGroupKeys) {
                const group = groups[groupKey];
                const subGroups = group.subGroups;

                if (group.isEvent) {
                    const formattedDate = formatEventDate(group.date);
                    
                    if (formattedDate !== lastDateRendered) {
                        
                        let prefix = 'Eventos del ';
                        const firstWord = formattedDate.split(' ')[0].toLowerCase();
                        
                        // Si empieza por Hoy, Ma침ana, o Ayer, usamos "Eventos de"
                        if (firstWord === 'hoy' || firstWord === 'ma침ana' || firstWord === 'ayer' || firstWord === 'el') {
                            prefix = 'Eventos de ';
                        }

                        // Construimos el encabezado con el prefijo
                        html += `<h2 class="tv-date-header">${prefix}${formattedDate}</h2>`;
                        lastDateRendered = formattedDate;
                    }
                } else {
                    lastDateRendered = null;
                }

                let groupTitle = group.name;
                let groupTitleStyle = '';
                
                if (group.isEvent) {
                    const liveTimeClass = group.hasLive ? 'live-time-blink' : '';
                    
                    // MODIFICACI칍N CLAVE: Aplicar estilo al nombre de la competici칩n (group.competition)
                    const competitionHtml = `<span style="color: var(--primary);">${group.competition}</span>`;
                    
                    groupTitle = `<span class="${liveTimeClass}" style="margin-right: 7.5px;">${group.time}</span> ${group.sportEmoji} ${competitionHtml} - ${group.match}`;
                    
                    const isFirstGroupAfterDateHeader = !lastDateRendered || (group.date && formatEventDate(group.date) === lastDateRendered);
                    if(isFirstGroupAfterDateHeader) {
                        groupTitleStyle = 'margin-top: 0;';
                    }

                }
                
                // MODIFICACI칍N: A침adir onclick, tabindex y role="button" al tv-group-header
                html += ` 
                    <div class="tv-group">
                        <header class="tv-group-header" tabindex="0" role="button" onclick="focusNextChannelInGroup(this)">
                            <h2 class="tv-group-title" style="${groupTitleStyle}">${groupTitle}</h2>
                        </header> 
                `;

                let cardsHTML = '';
                const sortedSubGroupNames = Object.keys(subGroups).sort((a, b) => {
                    const aHasLive = subGroups[a].some(c => c.isLive);
                    const bHasLive = subGroups[b].some(c => c.isLive);
                    if (aHasLive && !bHasLive) return -1;
                    if (!aHasLive && bHasLive) return 1;
                    return a.localeCompare(b);
                });

                sortedSubGroupNames.forEach(subGroupName => {
                    const channels = subGroups[subGroupName];
                    const bestChannel = getBestChannelInSubgroup(channels);
                    if (!bestChannel) return;

                    const allOptions = channels.map(c => ({
                        id: c.id,
                        name: c.displayableName,
                        quality: standardizeQuality(c.quality),
                        multiAudio: c.multiAudio,
                        source: c.source,
                        rating: state.channelRatings[c.id] !== undefined ? state.channelRatings[c.id] : 2.5
                    }));
                    const allOptionsJson = JSON.stringify(allOptions);

                    cardsHTML += createTVChannelCard(bestChannel, allOptionsJson);
                });

                if (cardsHTML) {
                    html += `<div class="tv-subgroup-content">${cardsHTML}</div>`;
                }

                html += `</div>`;
            }
            return html;
        }
        
        // #############################
        // ### NUEVA FUNCI칍N DE FOCO SECUENCIAL ###
        // #############################
        function focusNextChannelInGroup(headerElement) {
            const groupElement = headerElement.closest('.tv-group');
            if (!groupElement) return;

            const channelsInGroup = Array.from(groupElement.querySelectorAll('.tv-card'));
            if (channelsInGroup.length === 0) return;

            const currentFocus = state.tvFocusManager.currentFocus;
            let nextElement = channelsInGroup[0]; // Por defecto, el primer canal

            if (currentFocus && currentFocus.classList.contains('tv-card') && currentFocus.closest('.tv-group') === groupElement) {
                const currentIndex = channelsInGroup.indexOf(currentFocus);
                // Si no es el 칰ltimo, el siguiente
                if (currentIndex < channelsInGroup.length - 1) {
                    nextElement = channelsInGroup[currentIndex + 1];
                } else {
                    // Si es el 칰ltimo, vuelve al primero (c칤clico)
                    nextElement = channelsInGroup[0]; 
                }
            }
            
            // Si el foco actual era el propio encabezado, ir al primer canal
            if (currentFocus === headerElement) {
                 nextElement = channelsInGroup[0];
            }

            if (nextElement) {
                state.tvFocusManager.setFocus(nextElement);
            }
        }
        // #############################
        // ### FIN NUEVA FUNCI칍N DE FOCO SECUENCIAL ###
        // #############################

        function renderTVChannels() {
            const tvGrid = document.getElementById('tvChannelsGrid');
            if (!tvGrid) return;

            const statusContainer = document.getElementById('tvStatusMessageContainer');
            if (statusContainer) {
                statusContainer.innerHTML = ''; 
            }

            const previouslyFocusedElement = state.tvFocusManager ? state.tvFocusManager.currentFocus : null;

            restoreTVFilterUI();

            const {
                groups,
                sortedGroupKeys
            } = getGroupedChannels();
            tvGrid.innerHTML = createTVChannelsHTML(groups, sortedGroupKeys);
            
            // A침adir/eliminar la clase de centrado si no hay canales
            if (sortedGroupKeys.length === 0) {
                tvGrid.classList.add('no-channels');
            } else {
                tvGrid.classList.remove('no-channels');
            }
            
            attachTVCardEvents();

            if (state.tvFocusManager) {
                state.tvFocusManager.updateFocusableElements();

                const tvSearch = document.getElementById('tvSearch');
                const firstCard = document.querySelector('.tv-card');
                const sidebarElements = Array.from(document.querySelectorAll('#tvSearch, .tv-nav-link, #settingsModeBtn'));

                // Si el foco estaba en la barra de b칰squeda, mantenerlo
                if (previouslyFocusedElement === tvSearch || (tvSearch && document.activeElement === tvSearch)) {
                    state.tvFocusManager.setFocus(tvSearch);
                    state.isStageFocused = false;
                    updateStage(null); 
                    return;
                }
                
                // Si el foco estaba en la sidebar y hay cards, enfocar la primera card.
                const wasSidebarFocused = previouslyFocusedElement && sidebarElements.includes(previouslyFocusedElement);
                if ((wasSidebarFocused || !previouslyFocusedElement) && firstCard) {
                    state.tvFocusManager.setFocus(firstCard);
                    return;
                }
                
                // Si el foco estaba en un encabezado, mantener el foco en 칠l o en el primer canal.
                if (previouslyFocusedElement && previouslyFocusedElement.classList.contains('tv-group-header')) {
                    state.tvFocusManager.setFocus(previouslyFocusedElement);
                    return;
                }
                
                // Si el elemento previamente enfocado a칰n existe, restablecer el foco en 칠l.
                if (previouslyFocusedElement && document.body.contains(previouslyFocusedElement)) {
                    state.tvFocusManager.setFocus(previouslyFocusedElement);
                    return;
                }

                // L칩gica de fallback para establecer el foco inicial
                let elementToFocus = null;
                const activeSportFilterLink = document.querySelector(`.tv-nav-link.sport-filter.tv-sidebar-link-focused`);
                const activeBrandLink = document.querySelector(`.tv-nav-link.brand-filter[data-filter="${state.tvCurrentFilter}"].tv-sidebar-link-focused`);
                const activeMainLink = document.querySelector(`.tv-nav-link[data-filter="${state.tvCurrentFilter}"].tv-sidebar-link-focused`);

                elementToFocus = activeSportFilterLink || activeBrandLink || activeMainLink;

                if (elementToFocus) {
                    state.tvFocusManager.setFocus(elementToFocus);
                } else if (firstCard) {
                    state.tvFocusManager.setFocus(firstCard);
                } else {
                    state.tvFocusManager.setFocus(document.querySelector('.tv-nav-link[data-filter="all"]'));
                }
            }
        }
        
        // #############################
        // ### NUEVAS FUNCIONES STAGE ###
        // #############################
        
        function getStageChannelInfo(channel) {
            const now = new Date().getTime();
            const info = {
                channelName: channel.displayableName,
                mainInfo: channel.name,
                secondaryInfo: `${standardizeQuality(channel.quality)}${channel.multiAudio ? ' 游꿚' : ''} | PID: ${channel.number}`,
                status: 'Sin Evento',
                statusClass: 'status-none',
                progress: 0,
                sportEmoji: SPORT_EMOJIS.default,
                bgColor: SPORT_COLORS.default,
                sportFieldClass: SPORT_FIELD_CLASSES.default.class,
                sportFieldElements: SPORT_FIELD_CLASSES.default.elements,
                isLive: false,
                isEvent: false
            };

            if (channel.source === 'events' && channel.event) {
                const event = channel.event;
                info.isEvent = true;
                info.mainInfo = `${event.match}`;
                info.secondaryInfo = `${event.sportEmoji} ${event.competition} | ${event.time} ${event.date}`;
                info.sportEmoji = event.sportEmoji;
                
                const fieldInfo = getSportField(event.sportName);
                info.sportFieldClass = fieldInfo.class;
                info.sportFieldElements = fieldInfo.elements;

                const startTime = event.startTime;
                const endTime = event.endTime;
                const liveStartTime = startTime - (15 * 60 * 1000); // 15 minutos antes
                
                if (now < liveStartTime) {
                    info.status = 'Pr칩ximamente';
                    info.statusClass = 'status-upcoming';
                    const diffMinutes = Math.floor((liveStartTime - now) / (60 * 1000));
                    info.secondaryInfo += ` | Inicia en ${diffMinutes} min`;
                    info.progress = 0;
                } else if (now >= liveStartTime && now <= endTime) {
                    info.status = 'EN VIVO';
                    info.statusClass = 'status-live';
                    info.isLive = true;
                    
                    const totalDuration = endTime - liveStartTime;
                    const elapsed = now - liveStartTime;
                    let progress = (elapsed / totalDuration) * 100;
                    progress = Math.min(100, Math.max(0, progress));

                    info.progress = progress;
                    
                    if (progress > 85) {
                        info.status = 'A punto de acabar';
                    }
                } else {
                    info.status = 'Finalizado';
                    info.statusClass = 'status-finished';
                    info.progress = 100;
                }
            }

            return info;
        }
        
        function getSportField(sportName) {
            const normalizedName = normalizeText(sportName);
            for (const key in SPORT_FIELD_CLASSES) {
                if (key !== 'default' && normalizedName.includes(key)) {
                    return SPORT_FIELD_CLASSES[key];
                }
            }
            return SPORT_FIELD_CLASSES.default;
        }

        /* ELIMINADA: getSportColor() */

        function updateStage(channel) {
            const stage = document.getElementById('tvStage');
            const stageBg = document.getElementById('tvStageBackground');
            const channelIcon = document.getElementById('stageChannelIcon');
            const channelNameEl = document.getElementById('stageChannelName');
            const mainInfoEl = document.getElementById('stageMainInfo');
            const secondaryInfoEl = document.getElementById('stageSecondaryInfo');
            const statusEl = document.getElementById('stageStatus');
            const progressBar = document.getElementById('stageProgressBar');
            const carouselIndicator = document.getElementById('stageCarouselIndicator');
            
            // Si hay un carrusel activo, detenerlo.
            if (state.carouselTimer) {
                clearInterval(state.carouselTimer);
                state.carouselTimer = null;
            }
            
            // Si el canal es nulo o no est치 en foco, mostrar el carrusel (o un mensaje de carga/no hay eventos)
            if (!channel || !state.isStageFocused) {
                 stage.classList.add('carousel-mode');
                 
                 // Si hay canales para el carrusel, lo iniciamos
                 if (state.carouselChannels.length > 0) {
                     startCarousel();
                     return;
                 }
                 
                 // Sino hay canales de carrusel (ni live ni upcoming)
                 stageBg.className = 'campo-base pista-atletismo';
                 stageBg.innerHTML = SPORT_FIELD_CLASSES.default.elements;
                 channelIcon.style.display = 'none';
                 channelNameEl.innerHTML = 'Bienvenido a la Gu칤a TV.';
                 mainInfoEl.innerHTML = 'Selecciona un canal para ver los detalles.';
                 secondaryInfoEl.textContent = 'No hay eventos en vivo o pr칩ximos en las pr칩ximas horas.';
                 statusEl.className = 'stage-status status-none';
                 statusEl.textContent = 'INFO';
                 progressBar.style.width = '0%';
                 carouselIndicator.innerHTML = ''; 
                 return;
            }
            
            // Modo Foco en Canal
            stage.classList.remove('carousel-mode');
            const info = getStageChannelInfo(channel);
            
            // 1. Icono y Fondo (Fondo de campo)
            const logoInfo = getPlaceholderInfo(channel.name);
            if (logoInfo) {
                const fullUrl = LOGOPEDIA_BASE_URL + logoInfo.url;
                channelIcon.src = proxyImage(fullUrl);
                channelIcon.style.display = 'block';
            } else {
                channelIcon.src = '';
                channelIcon.style.display = 'none';
            }
            
            // Aplicar la clase de campo y los elementos
            stageBg.className = `campo-base ${info.sportFieldClass}`;
            stageBg.innerHTML = info.sportFieldElements;

            // 2. Informaci칩n
            channelNameEl.innerHTML = info.channelName;
            mainInfoEl.innerHTML = info.mainInfo;
            secondaryInfoEl.textContent = info.secondaryInfo;

            // 3. Estado y Progreso
            statusEl.className = `stage-status ${info.statusClass}`;
            statusEl.textContent = info.status;
            progressBar.style.width = `${info.progress}%`;
            
            // 4. Indicador
            carouselIndicator.innerHTML = ''; 

            // Actualizar el stage cada segundo si est치 en vivo
            if (info.isLive) {
                state.carouselTimer = setInterval(() => {
                    if (state.tvFocusManager && state.tvFocusManager.currentFocus && state.tvFocusManager.currentFocus.getAttribute('data-channel-id') === channel.id) {
                        updateStage(channel);
                    } else {
                        clearInterval(state.carouselTimer);
                        state.carouselTimer = null;
                    }
                }, 1000);
            }
        }
        
        function setupCarouselChannels() {
            // Obtener todos los canales de eventos
            const allEventChannels = state.channelsData.filter(c => c.source === 'events');
            
            // 1. Canales En Vivo
            const liveChannels = allEventChannels
                .filter(c => {
                    const event = c.event;
                    if (!event) return false;
                    const now = new Date().getTime();
                    const liveStartTime = event.startTime - (15 * 60 * 1000); 
                    const liveEndTime = event.endTime;
                    return now >= liveStartTime && now <= liveEndTime && !findConflictingSiblings(c, allEventChannels);
                })
                .sort((a, b) => a.event.endTime - b.event.endTime); // Primero los que est치n a punto de terminar
                
            // 2. Canales Pr칩ximamente (inician en menos de 1 hora, no finalizados)
            const UPCOMING_THRESHOLD_MS = 60 * 60 * 1000;
            const now = new Date().getTime();
            
            const upcomingChannels = allEventChannels
                .filter(c => {
                    const event = c.event;
                    if (!event) return false;
                    const liveStartTime = event.startTime - (15 * 60 * 1000); 
                    const timeToStart = liveStartTime - now;
                    return timeToStart > 0 && timeToStart <= UPCOMING_THRESHOLD_MS;
                })
                .sort((a, b) => a.event.startTime - b.event.startTime); // Primero los que inician antes

            state.carouselChannels = [...liveChannels, ...upcomingChannels];
            state.carouselIndex = 0;
            
            // Si no hay canales, Stage se queda en modo info
            if (state.carouselChannels.length === 0) {
                updateStage(null); 
                return;
            }
            
            // Si hay canales, iniciamos el carrusel
            if (state.carouselChannels.length > 0) {
                 startCarousel();
            }
        }
        
        function startCarousel() {
            if (state.carouselChannels.length === 0) {
                updateStage(null); 
                return;
            }

            const stage = document.getElementById('tvStage');
            
            // Renderiza el contenido inicial
            renderCarouselItem(state.carouselChannels[state.carouselIndex]);
            
            // Crea los indicadores
            const indicatorContainer = document.getElementById('stageCarouselIndicator');
            indicatorContainer.innerHTML = state.carouselChannels.map((_, index) => 
                `<span class="carousel-dot ${index === state.carouselIndex ? 'active' : ''}"></span>`
            ).join('');

            // Inicia el temporizador
            if (state.carouselTimer) clearInterval(state.carouselTimer);
            state.carouselTimer = setInterval(nextCarouselItem, 5000);
        }
        
        function nextCarouselItem() {
            if (state.isStageFocused) return;
            
            state.carouselIndex = (state.carouselIndex + 1) % state.carouselChannels.length;
            const nextChannel = state.carouselChannels[state.carouselIndex];
            
            renderCarouselItem(nextChannel);
            
            // Actualiza los indicadores
            document.querySelectorAll('#stageCarouselIndicator .carousel-dot').forEach((dot, index) => {
                dot.classList.toggle('active', index === state.carouselIndex);
            });
        }
        
        function renderCarouselItem(channel) {
            const stage = document.getElementById('tvStage');
            const stageBg = document.getElementById('tvStageBackground');
            const channelIcon = document.getElementById('stageChannelIcon');
            const channelNameEl = document.getElementById('stageChannelName');
            const mainInfoEl = document.getElementById('stageMainInfo');
            const secondaryInfoEl = document.getElementById('stageSecondaryInfo');
            const statusEl = document.getElementById('stageStatus');
            const progressBar = document.getElementById('stageProgressBar');
            
            const info = getStageChannelInfo(channel);
            
            // 1. Icono y Fondo
            const logoInfo = getPlaceholderInfo(channel.name);
            if (logoInfo) {
                const fullUrl = LOGOPEDIA_BASE_URL + logoInfo.url;
                channelIcon.src = proxyImage(fullUrl);
                channelIcon.style.display = 'block';
            } else {
                channelIcon.src = '';
                channelIcon.style.display = 'none';
            }
            
            // Aplicar la clase de campo y los elementos
            stageBg.className = `campo-base ${info.sportFieldClass}`;
            stageBg.innerHTML = info.sportFieldElements;

            // 2. Informaci칩n
            channelNameEl.innerHTML = info.channelName;
            mainInfoEl.innerHTML = info.mainInfo;
            secondaryInfoEl.textContent = info.secondaryInfo;

            // 3. Estado y Progreso
            statusEl.className = `stage-status ${info.statusClass}`;
            statusEl.textContent = info.status;
            progressBar.style.width = `${info.progress}%`;
        }

        // #############################
        // ### FIN NUEVAS FUNCIONES STAGE ###
        // #############################

        const attachTVCardEvents = () => {
            const cards = document.querySelectorAll('.tv-card');
            cards.forEach(card => {
                card.removeEventListener('click', handleTVCardPlay);
                card.addEventListener('click', handleTVCardPlay);
                const optionsButton = card.querySelector('.tv-link-button');
                // IMPORTANTE: Aseguramos que el evento del bot칩n SIEMPRE est칠 asociado
                if (optionsButton) {
                    optionsButton.removeEventListener('click', handleTVCardOptionsClick);
                    optionsButton.addEventListener('click', handleTVCardOptionsClick);
                }
                
                // Con visibility: hidden aplicado por CSS, la funcionalidad es correcta sin m치s cambios en JS.
            });
            
            // Adjuntar evento de foco secuencial a los encabezados
            document.querySelectorAll('.tv-group-header').forEach(header => {
                header.removeEventListener('click', focusNextChannelInGroup);
                header.addEventListener('click', function(e) {
                     // Solo ejecutar si no es un evento de teclado (ya que el keyboard focus se maneja en tvFocusManager)
                     if (e.pointerType || e.detail === 0) { 
                         focusNextChannelInGroup(this);
                     }
                });
            });
        };
        
        const handleTVCardPlay = (e) => {
            if (e.target.closest('.tv-link-button')) {
                // Si se hace clic en el bot칩n de opciones, no hacer play
                return;
            }
            const card = e.currentTarget;
            const channelId = card.getAttribute('data-channel-id');
            const channel = state.channelsData.find(c => c.id === channelId);
            
            if (!channel) return;
            
            const optionsJson = card.getAttribute('data-all-options');
            let allOptions = [];
            try {
                allOptions = JSON.parse(optionsJson);
            } catch (error) {
                console.error("Error al parsear opciones para TV Card:", error);
                handleChannelPlay(channel);
                return;
            }
            
            const now = new Date().getTime();
            const RECENT_FAILURE_THRESHOLD_MS = 40 * 60 * 1000; 
            let channelToPlay = channel;
            let statusMessage = '';
            
            if (state.lastChannelPlay && 
                state.lastChannelPlay.channelId === channel.id && 
                (now - state.lastChannelPlay.timestamp) < RECENT_FAILURE_THRESHOLD_MS) {
                
                const sortedOptions = allOptions
                    .map(opt => state.channelsData.find(c => c.id === opt.id))
                    .filter(c => c)
                    .sort(compareChannelsForSort);
                
                const alternativeChannel = sortedOptions[1]; 
                
                if (alternativeChannel) {
                    channelToPlay = alternativeChannel;
                    
                    statusMessage = `仇 Fallo detectado en ${channel.name}. Abriendo alternativa: ${alternativeChannel.name} (${standardizeQuality(alternativeChannel.quality)}).`;
                    showStatusMessage(statusMessage, 'error');
                    
                } else {
                    statusMessage = `丘멆잺 ${channel.name} ha fallado de nuevo. Sin alternativas. Reintentando...`;
                    showStatusMessage(statusMessage, 'warning');
                }
            } 

            handleChannelPlay(channelToPlay);
        }
        
        const handleTVCardOptionsClick = (e) => {
            e.stopPropagation();
            const card = e.currentTarget.closest('.tv-card');
            const channelId = card.getAttribute('data-channel-id');
            const optionsJson = card.getAttribute('data-all-options');
            const channel = state.channelsData.find(c => c.id === channelId);
            if (channel && optionsJson) {
                try {
                    const allOptions = JSON.parse(optionsJson);
                    showTvOptionsModal(channel.name, allOptions);
                } catch (error) {
                    console.error("Error al parsear las opciones del canal:", error);
                    handleChannelPlay(channel);
                }
            }
        };

        function showTvOptionsModal(mainChannelName, optionsList) {
            const modal = document.getElementById('tvChannelOptionsModal');
            const nameSpan = document.getElementById('tvModalChannelName');
            const listDiv = document.getElementById('tvModalChannelList');
            nameSpan.innerHTML = state.channelsData.find(c => c.name === mainChannelName)?.displayableName || mainChannelName;
            listDiv.innerHTML = '';
            
            const lastPlayedId = state.lastPlayedByChannel[mainChannelName.trim().toLowerCase()];

            const renderOptionItem = (option) => {
                const isFavorite = state.favorites.includes(option.id);
                const favoriteIcon = isFavorite ? '驕' : '驕';
                const favoriteClass = isFavorite ? 'is-favorite' : 'is-not-favorite';
                
                const isLastViewed = option.id === lastPlayedId;
                const lastViewedIndicator = isLastViewed ? '<span class="last-viewed-indicator" title="칔ltimo AceStream reproducido para este canal">游녜勇</span>' : '';
                
                const ratingStars = getStarRating(option.rating);
                let sourceBadgeText = '';
                let sourceBadgeClass = '';
                switch (option.source) {
                    case 'gist':
                        sourceBadgeClass = 'gist-badge';
                        sourceBadgeText = 'NE';
                        break;
                    case 'era':
                        sourceBadgeClass = 'era-badge';
                        sourceBadgeText = 'ER';
                        break;
                    case 'elcano':
                        sourceBadgeClass = 'elcano-badge';
                        sourceBadgeText = 'EC';
                        break;
                    case 'events':
                        sourceBadgeClass = 'events-badge';
                        sourceBadgeText = 'EV';
                        break;
                    case 'shickat':
                        sourceBadgeClass = 'shickat-badge';
                        sourceBadgeText = 'SH';
                        break;
                }
                const sourceBadge = `<span class="${sourceBadgeClass}" style="font-size: 0.35rem; font-weight: 700; padding: 1px 2.5px; border-radius: 1.5px; color: white;">${sourceBadgeText}</span>`;
                
                const item = document.createElement('div');
                item.className = 'channel-option-item';
                item.setAttribute('data-id', option.id);
                const channelDisplayName = option.name;
                
                item.innerHTML = `
                    <div class="channel-option-name-container">
                        <button class="favorite-toggle-btn ${favoriteClass}" data-id="${option.id}" title="Marcar como favorito">${favoriteIcon}</button>
                        ${lastViewedIndicator}
                        <span class="channel-option-name">${channelDisplayName}</span>
                    </div>
                    <div class="channel-option-details">
                        ${ratingStars}
                        ${option.quality}
                        ${option.multiAudio ? '游꿚' : ''}
                        <span class="channel-number-display" style="font-weight: 700; color: var(--channel-number-color);">${option.id.substring(0, 3)}</span>
                        ${sourceBadge}
                    </div>
                `;

                item.onclick = (e) => {
                    if (e.target.closest('.favorite-toggle-btn')) {
                        return;
                    }
                    const fullChannel = state.channelsData.find(c => c.id === option.id);
                    if (fullChannel) {
                        handleChannelPlay(fullChannel);
                    }
                    hideTvOptionsModal();
                };

                item.querySelector('.favorite-toggle-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const channelIdToToggle = this.getAttribute('data-id');
                    
                    toggleFavorite(channelIdToToggle); 
                    
                    const isNowFavorite = state.favorites.includes(channelIdToToggle);
                    this.textContent = isNowFavorite ? '驕' : '驕';
                    this.classList.toggle('is-favorite', isNowFavorite);
                    this.classList.toggle('is-not-favorite', !isNowFavorite);
                    
                    showStatusMessage(`Canal ${isNowFavorite ? 'a침adido' : 'eliminado'} de favoritos.`, 'info');
                    
                });
                
                listDiv.appendChild(item);
            };

            optionsList
                .map(option => {
                    const channel = state.channelsData.find(c => c.id === option.id);
                    const rating = channel ? (state.channelRatings[channel.id] || 2.5) : 2.5;
                    const qualityMap = { 'UHD': 6, '4K': 5, 'FHD': 4, 'HD': 3, 'SD': 2, 'N/A': 1 };
                    const qualityScore = channel ? (qualityMap[standardizeQuality(channel.quality)] || 0) : 0;
                    
                    return { ...option, rating, qualityScore, isLastViewed: option.id === lastPlayedId };
                })
                .sort((a, b) => {
                    if (a.isLastViewed && !b.isLastViewed) return -1;
                    if (!a.isLastViewed && b.isLastViewed) return 1;
                    
                    if (b.rating !== a.rating) return b.rating - a.rating;
                    
                    if (b.qualityScore !== a.qualityScore) return b.qualityScore - a.qualityScore;
                    
                    return a.name.localeCompare(b.name);
                })
                .forEach(renderOptionItem);


            modal.classList.add('modal--active');
        }

        function hideTvOptionsModal() {
            document.getElementById('tvChannelOptionsModal').classList.remove('modal--active');
        }

        function initializeTVNavigation() {
            if (state.tvFocusManager) {
                document.removeEventListener('keydown', state.tvFocusManager.handleKeyDown);
            }
            const tvNavigation = {
                currentFocus: null,
                focusableElements: [],
                init: function() {
                    this.updateFocusableElements();
                    if (document.activeElement.id === 'tvSearch') {
                        this.setFocus(document.getElementById('tvSearch'));
                    } else if (this.focusableElements.length > 0) {
                        this.setFocus(document.querySelector('.tv-nav-link[data-filter="all"]'));
                    }
                    this.handleKeyDown = this.handleKeyDown.bind(this);
                    document.addEventListener('keydown', this.handleKeyDown);
                },
                removeFocusClasses: function() {
                    document.querySelectorAll('.tv-card-focused').forEach(el => el.classList.remove('tv-card-focused'));
                    document.querySelectorAll('.tv-sidebar-link-focused').forEach(el => el.classList.remove('tv-sidebar-link-focused'));
                },
                updateFocusableElements: function() {
                    const searchElement = document.getElementById('tvSearch');
                    const sidebarLinks = Array.from(document.querySelectorAll('.tv-nav-link'));
                    const settingsModeBtn = document.getElementById('settingsModeBtn');
                    // MODIFICACI칍N: Incluir los encabezados de grupo como elementos enfocables.
                    const groupHeaders = Array.from(document.querySelectorAll('.tv-group-header'));
                    const allCards = Array.from(document.querySelectorAll('.tv-card'));
                    this.focusableElements = [searchElement, ...sidebarLinks, settingsModeBtn, ...groupHeaders, ...allCards].filter(el => el && el.offsetParent !== null);
                },
                setFocus: function(element) {
                    if (!element) return;
                    
                    this.removeFocusClasses();
                    this.currentFocus = element;
                    
                    // L칩gica para el Stage: si es una tarjeta, actualizamos el Stage y entramos en modo foco.
                    if (element.classList.contains('tv-card')) {
                         state.isStageFocused = true;
                         const channelId = element.getAttribute('data-channel-id');
                         const channel = state.channelsData.find(c => c.id === channelId);
                         updateStage(channel);
                         element.classList.add('tv-card-focused');
                    } else {
                         state.isStageFocused = false;
                         updateStage(null); // Vuelve al carrusel o a info
                         if (element.id === 'tvSearch') {
                            element.focus();
                         } else if (element.id === 'settingsModeBtn') {
                            element.focus();
                            element.classList.add('tv-sidebar-link-focused');
                         } else if (element.classList.contains('tv-group-header')) {
                             // No a침adir una clase de foco especial al encabezado, ya se maneja con el :focus/:hover CSS
                             element.focus();
                         } else {
                            element.focus();
                            element.classList.add('tv-sidebar-link-focused');
                         }
                    }

                    element.scrollIntoView({
                        behavior: 'smooth',
                        block: 'nearest',
                        inline: 'center'
                    });
                },
                handleKeyDown: function(e) {
                    let nextElement = null;
                    switch (e.key) {
                        case 'ArrowUp':
                        case 'ArrowDown':
                        case 'ArrowLeft':
                        case 'ArrowRight':
                            e.preventDefault();
                            nextElement = this.moveFocus(e.key);
                            break;
                        case 'Enter':
                        case ' ':
                            e.preventDefault();
                            this.selectFocused();
                            return;
                        case 'Escape':
                        case 'Backspace':
                            e.preventDefault();
                            if (document.getElementById('settingsModal').classList.contains('modal--active')) {
                                document.getElementById('settingsModal').classList.remove('modal--active');
                                return;
                            }
                            if (document.getElementById('tvChannelOptionsModal').classList.contains('modal--active')) {
                                hideTvOptionsModal();
                                return;
                            }
                            if (this.currentFocus.id === 'tvSearch' && this.currentFocus.value.length > 0) {
                                this.currentFocus.value = '';
                                state.tvSearchTerm = '';
                                renderTVChannels();
                                return;
                            }
                            if (this.currentFocus.classList.contains('tv-card') || this.currentFocus.classList.contains('tv-nav-link')) {
                                applyTVFilter('all', 'brand');
                                this.setFocus(document.querySelector('.tv-nav-link[data-filter="all"]'));
                                return;
                            }
                            
                            if (this.currentFocus === document.querySelector('.tv-nav-link[data-filter="all"]')) {
                                this.setFocus(document.getElementById('tvSearch'));
                                return;
                            }
                            
                            if (this.currentFocus.id === 'settingsModeBtn') {
                                this.setFocus(document.querySelector('.tv-nav-link[data-filter="all"]'));
                                return;
                            }
                            
                            return;
                    }
                    if (nextElement) {
                        this.setFocus(nextElement);
                    }
                },
                moveFocus: function(direction) {
                    this.updateFocusableElements();
                    const allCards = Array.from(document.querySelectorAll('.tv-card'));
                    const sidebarElements = Array.from(document.querySelectorAll('#tvSearch, .tv-nav-link, #settingsModeBtn'));
                    const focusedElement = this.currentFocus;

                    // 1. Foco en Sidebar
                    if (sidebarElements.includes(focusedElement)) {
                        const focusedIndex = sidebarElements.indexOf(focusedElement);
                        if (direction === 'ArrowDown' && focusedIndex < sidebarElements.length - 1) {
                            return sidebarElements[focusedIndex + 1];
                        } else if (direction === 'ArrowUp' && focusedIndex > 0) {
                            return sidebarElements[focusedIndex - 1];
                        } else if (direction === 'ArrowRight') {
                             const firstHeader = document.querySelector('.tv-group-header');
                             if (firstHeader) return firstHeader;
                             if (allCards.length > 0) return allCards[0];
                        }
                    }
                    
                    // 2. Foco en Encabezado de Grupo
                    else if (focusedElement.classList.contains('tv-group-header')) {
                        const groupHeaders = Array.from(document.querySelectorAll('.tv-group-header'));
                        const focusedIndex = groupHeaders.indexOf(focusedElement);
                        
                        if (direction === 'ArrowRight') {
                            const cardsInGroup = Array.from(focusedElement.closest('.tv-group').querySelectorAll('.tv-card'));
                            if (cardsInGroup.length > 0) return cardsInGroup[0];
                        } else if (direction === 'ArrowLeft') {
                            return document.getElementById('settingsModeBtn');
                        } else if (direction === 'ArrowDown') {
                            if (focusedIndex < groupHeaders.length - 1) {
                                return groupHeaders[focusedIndex + 1];
                            }
                        } else if (direction === 'ArrowUp') {
                            if (focusedIndex > 0) {
                                return groupHeaders[focusedIndex - 1];
                            } else {
                                return document.querySelector('.tv-nav-link[data-filter="all"]');
                            }
                        }
                    }

                    // 3. Foco en Tarjeta (L칩gica original)
                    else if (focusedElement.classList.contains('tv-card')) {
                        const currentRow = focusedElement.closest('.tv-subgroup-content');
                        if (!currentRow) return null;
                        
                        const cardsInCurrentRow = Array.from(currentRow.querySelectorAll('.tv-card'));
                        const indexInRow = cardsInCurrentRow.indexOf(focusedElement);
                        const allRows = Array.from(document.querySelectorAll('.tv-subgroup-content'));
                        const currentRowIndex = allRows.indexOf(currentRow);
                        const currentGroupHeader = focusedElement.closest('.tv-group').querySelector('.tv-group-header');

                        if (direction === 'ArrowRight') {
                            if (indexInRow < cardsInCurrentRow.length - 1) {
                                return cardsInCurrentRow[indexInRow + 1];
                            }
                        } else if (direction === 'ArrowLeft') {
                            if (indexInRow > 0) {
                                return cardsInCurrentRow[indexInRow - 1];
                            } else {
                                return currentGroupHeader;
                            }
                        } else if (direction === 'ArrowDown') {
                            if (currentRowIndex < allRows.length - 1) {
                                const nextRow = allRows[currentRowIndex + 1];
                                const cardsInNextRow = Array.from(nextRow.querySelectorAll('.tv-card'));
                                return cardsInNextRow[Math.min(indexInRow, cardsInNextRow.length - 1)];
                            }
                        } else if (direction === 'ArrowUp') {
                            if (currentRowIndex > 0) {
                                const prevRow = allRows[currentRowIndex - 1];
                                const cardsInPrevRow = Array.from(prevRow.querySelectorAll('.tv-card'));
                                return cardsInPrevRow[Math.min(indexInRow, cardsInPrevRow.length - 1)];
                            } else {
                                return currentGroupHeader;
                            }
                        }
                    }
                    
                    return null;
                },
                selectFocused: function() {
                    if (this.currentFocus) {
                        if (this.currentFocus.classList.contains('tv-card')) {
                            this.currentFocus.click();
                        } else if (this.currentFocus.classList.contains('tv-nav-link')) {
                            this.currentFocus.click();
                        } else if (this.currentFocus.id === 'tvSearch') {
                            this.currentFocus.focus();
                        } else if (this.currentFocus.id === 'settingsModeBtn') {
                            document.getElementById('settingsModal').classList.add('modal--active');
                            setTimeout(() => {
                                document.getElementById('closeSettingsBtn').focus();
                            }, 100);
                        } else if (this.currentFocus.classList.contains('tv-group-header')) {
                             // Si se presiona ENTER en el encabezado, llama a la funci칩n de foco secuencial.
                             focusNextChannelInGroup(this.currentFocus);
                        }
                    }
                }
            };
            state.tvFocusManager = tvNavigation;
            tvNavigation.init();
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.body.classList.add('dark-mode');
            document.body.classList.add('tv-mode-active');
            
            // Inicializaci칩n del nuevo ajuste
            document.body.classList.toggle('hide-options-button-active', state.hideOptionsButton);
            
            initializeTVNavigation();
            loadInitialChannels();

            document.getElementById('darkModeCheckbox').checked = state.darkMode;
            document.getElementById('hideEventDetailsCheckbox').checked = state.hideEventDetails;
            document.getElementById('fullScreenOnClickCheckbox').checked = state.fullScreenOnClick; 
            document.getElementById('hideOptionsButtonCheckbox').checked = state.hideOptionsButton; // Establecer estado inicial del nuevo switch
            document.body.classList.toggle('hide-event-details', state.hideEventDetails);
            
            const copyModal = document.getElementById('copyModal');
            const cancelCopyBtn = document.getElementById('cancelCopyBtn');
            cleanupOldFirstSeenRecords();
            
            if (cancelCopyBtn) {
                cancelCopyBtn.addEventListener('click', hideCopyModal);
            }
            document.getElementById('closeTvOptionsBtn').addEventListener('click', hideTvOptionsModal);
            window.addEventListener('click', (event) => {
                if (event.target === copyModal) {
                    hideCopyModal();
                }
            });
            
            // Event Listener de Pantalla Completa al Clic
            document.body.addEventListener('click', (e) => {
                if (state.fullScreenOnClick && 
                    !e.target.closest('.modal') && 
                    !e.target.closest('#tvSidebar') &&
                    e.target.id !== 'tvSearch') {
                    requestFullScreen();
                }
            });
            
            document.getElementById('settingsModeBtn').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.add('modal--active');
            });

            document.querySelectorAll('#tvSidebar .tv-nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (TV_BRAND_FILTER_KEYS.includes(this.dataset.filter)) {
                        applyTVFilter(this.dataset.filter, 'brand');
                    } else if (TV_SPORT_FILTER_KEYS.includes(this.dataset.sportKey)) {
                        applyTVFilter(this.dataset.sportKey, 'sport');
                    }
                    if (state.tvFocusManager) {
                        state.tvFocusManager.setFocus(this);
                    }
                });
            });

            let tvSearchTimeout;
            document.getElementById('tvSearch').addEventListener('input', function(e) {
                clearTimeout(tvSearchTimeout);
                tvSearchTimeout = setTimeout(() => {
                    state.tvSearchTerm = e.target.value;
                    renderTVChannels();
                }, 300);
            });

            document.getElementById('darkModeCheckbox').addEventListener('change', toggleDarkMode);
            document.getElementById('hideEventDetailsCheckbox').addEventListener('change', toggleHideEventDetails);
            document.getElementById('fullScreenOnClickCheckbox').addEventListener('change', toggleFullScreenOnClick); 
            // NUEVO EVENT LISTENER para el nuevo switch
            document.getElementById('hideOptionsButtonCheckbox').addEventListener('change', toggleHideOptionsButton); 
            
            document.getElementById('closeSettingsBtn').addEventListener('click', () => document.getElementById('settingsModal').classList.remove('modal--active'));
            document.querySelectorAll('.color-option').forEach(btn => {
                btn.addEventListener('click', () => changePrimaryColor(btn.dataset.color));
            });
            changePrimaryColor(state.primaryColor);
            
            document.addEventListener('click', (e) => {
                if (e.target.closest('.channel-number-badge-button')) {
                    const button = e.target.closest('.channel-number-badge-button');
                    e.stopPropagation();
                    const channelId = button.dataset.id;
                    copyAcestreamDirectly(channelId);
                }
            });
            
            setInterval(() => {
                // Si el foco est치 en un canal o en la barra lateral, no hacer nada.
                if (state.tvFocusManager.currentFocus && (state.tvFocusManager.currentFocus.classList.contains('tv-card') || state.tvFocusManager.currentFocus.id !== 'tvSearch')) {
                    // Si el foco est치 en un canal, solo se actualiza el Stage por el setInterval de updateStage (si est치 Live)
                    // Si el foco est치 en la sidebar, el carrusel se encarga de las actualizaciones (si est치 activo)
                    
                    // Asegurar que el carrusel se actualice si no hay foco en una tarjeta
                    if (!state.isStageFocused && state.carouselChannels.length > 0) {
                        renderCarouselItem(state.carouselChannels[state.carouselIndex]);
                    }
                    
                    // No hacemos renderTVChannels() completo, solo si es necesario (e.g. cada 1 min)
                } else {
                     // Si est치 en el modo de b칰squeda o sin foco, hacemos un re-render suave de todo
                     renderTVChannels();
                }
            }, 1000); 

            setInterval(() => {
                // Re-render completo para actualizar eventos en la cuadr칤cula
                renderTVChannels();
                setupCarouselChannels(); // Recalcula canales del carrusel por si cambi칩 de estado (Upcoming -> Live)
            }, 60000); 
        });
    </script>
</body>

</html>
