<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>TV Deportes</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
    
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22TV%20Deportes%22,%22short_name%22:%22TV%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#121212%22,%22theme_color%22:%22#448aff%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20viewBox=%270%200%20100%20100%27%3E%3Ctext%20y=%27.8em%27%20font-size=%2785%27%3Eüì∫%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22,%22purpose%22:%22any%20maskable%22}],%22display_override%22:[%22window-controls-overlay%22],%22orientation%22:%22portrait%22}">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.8em%22 font-size=%2285%22>üì∫</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        #loader-container{position:fixed;top:0;left:0;width:100%;height:3px;background:transparent;z-index:10001;transition:opacity .4s ease}.loader-bar{height:100%;width:30%;background:var(--accent-blue);box-shadow:0 0 10px var(--accent-blue);animation:loading-slide 2s infinite ease-in-out}@keyframes loading-slide{0%{transform:translateX(-100%)}100%{transform:translateX(400%)}}.loading-finished #loader-container{opacity:0;pointer-events:none}:root{--bg-color:#121212;--card-bg:#1e1e1e;--accent-blue:#448aff;--text-main:#ffffff;--text-muted:#888888;--channel-bg:#2a2a2a;--border-color:#333333;--nav-bg:#1a1a1a;--warning:var(--accent-blue)}body{background-color:var(--bg-color);color:var(--text-main);font-family:Inter,sans-serif;margin:0;padding:6px;padding-bottom:52px;display:flex;flex-direction:column;align-items:center;min-height:100vh;overflow-x:hidden}@keyframes blink-blue{0%{opacity:1;color:var(--accent-blue)}50%{opacity:.3;color:#fff}100%{opacity:1;color:var(--accent-blue)}}@keyframes blink-line{0%{border-color:var(--accent-blue)}50%{border-color:transparent}100%{border-color:var(--accent-blue)}}.is-live .time{animation:blink-blue 1s infinite;font-weight:800}.date-header{width:100%;box-sizing:border-box;text-align:center;margin:0 auto;padding:15px 20px;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--accent-blue);position:sticky;top:0;background:var(--bg-color);z-index:100;box-shadow:none;left:0;right:0;}.date-number{color:var(--text-main);font-weight:400;}.date-header::after,.date-header::before{content:"";flex:1;height:1px;background:var(--accent-blue);margin:0 10px;opacity:0.5}#events-container{width:95%;max-width:500px;display:flex;flex-direction:column;gap:18px;transition:max-width .3s ease, opacity 0.3s ease, transform 0.3s ease; scroll-snap-type: y proximity; scroll-padding-top: 50px; min-height: 100vh;}.tab-transitioning{opacity: 0; transform: translateY(10px);}@media (min-width:768px){#events-container{max-width:600px}.date-header{max-width:100%}}@media (min-width:1200px){#events-container{max-width:800px;display:flex;flex-direction:column;gap:18px}.date-header{width:100%;margin:0 auto}.event-card{border-bottom:1px solid #222;padding:10px 0}.event-card:last-child, .event-card:has(+ .date-header){border-bottom:none}}.event-card{display:flex;flex-direction:column;gap:8px;padding-bottom:8px;width:100%;border-bottom:1px solid #222;transition:opacity 0.3s, filter 0.3s; scroll-snap-align: start;}.event-finished{opacity:0.5;filter:grayscale(0.2) saturate(0.9);pointer-events:none}.competicion-title{color:var(--accent-blue);font-size:.65rem;font-weight:600;display:flex;align-items:center;gap:4px}.competicion-title::before{content: "";font-size:.55rem}.event-info{display:flex;align-items:center;font-size:.75rem;font-weight:500;margin-bottom:2px}.time{font-size:.6rem;color:#fff;margin-right:5px;white-space:nowrap}.time-separator{color:var(--accent-blue);margin-right:6px;font-weight:700}.vs-container{display:flex;align-items:center;gap:6px;flex-wrap:wrap;row-gap:4px;justify-content:space-between}.team-group{display:flex;align-items:center;gap:6px;white-space:nowrap}.team-group:last-child{margin-left:auto}.vs-text{color:var(--accent-blue);font-size:.55rem;font-weight:800;margin:0 1px}.team-logo{width:24px;height:24px;object-fit:contain;}.channels-wrapper{display:flex;flex-direction:row;overflow-x:auto;gap:12px;margin-top:6px;padding:4px 2px 12px 2px;scrollbar-width:none;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch}.channels-wrapper::-webkit-scrollbar{height:4px}.channels-wrapper::-webkit-scrollbar-thumb{background:var(--accent-blue);border-radius:10px}.channel-button{position:relative;background:var(--channel-bg);color:var(--text-main);border-radius:10px;text-align:center;font-size:.65rem;font-weight:600;border:1px solid var(--border-color);display:flex;align-items:center;justify-content:center;flex:0 0 140px;height:78.75px;scroll-snap-align:start;overflow:hidden;padding:8px;cursor:pointer;transition:all .2s cubic-bezier(.4,0,.2,1);box-shadow:0 4px 6px rgba(0,0,0,.3)}.channel-button:active{transform:scale(.95)}.channel-logo{width:80%;height:80%;object-fit:contain}.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center;z-index:2000}.modal-content{background:var(--card-bg);width:85%;max-width:280px;max-height:80vh;overflow-y:auto;border-radius:12px;padding:15px;border:1px solid var(--border-color)}.modal-title{margin-bottom:12px;font-size:.8rem;font-weight:700;text-align:center;color:var(--accent-blue)}.id-item{background:var(--channel-bg);padding:10px;margin-bottom:8px;border-radius:8px;font-size:.7rem;text-align:center;border:1px solid var(--border-color);cursor:pointer;display:flex;justify-content:space-between;align-items:center}.id-rating{color:var(--accent-blue);font-weight:700}.bottom-nav{position:fixed;bottom:0;left:0;right:0;height:48px;background:var(--nav-bg);border-top:1px solid var(--border-color);display:flex;justify-content:space-around;align-items:center;z-index:1000}.nav-item{display:flex;flex-direction:column;align-items:center;color:var(--text-muted);text-decoration:none;font-size:.55rem;font-weight:600;gap:2px;flex:1;cursor:pointer}.nav-item.active{color:var(--accent-blue)}.nav-icon{font-size:1rem}#status{position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);z-index:10000;display:flex;align-items:center;justify-content:center}.spinner{width:48px;height:48px;border:5px solid color-mix(in srgb, var(--accent-blue) 20%, transparent);border-top:5px solid var(--accent-blue);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}#events-container.search-mode-active {padding: 0 10px;}#events-container.search-mode-active .event-card {width: 100%;}
    </style>
</head>
<body>
    <div id="loader-container"><div class="loader-bar"></div></div>
    <div id="status"><div class="spinner"></div></div>
    
    <div id="searchContainer" style="display:none;width:95%;max-width:500px;margin:10px auto 0 auto;gap:8px;align-items:center;padding-bottom:10px;">
        <div style="position:relative;flex:1;display:flex;align-items:center">
            <input type="text" id="globalSearchInput" placeholder="Buscar canal, equipo o competici√≥n..." style="width:100%;padding:12px 40px 12px 16px;border-radius:12px;border:1px solid var(--border-color);background:var(--card-bg);color:#fff;font-size:.9rem;outline:0">
            <span id="clearSearch" style="position:absolute;right:12px;color:var(--text-muted);cursor:pointer;display:none;font-size:1.2rem;user-select:none">&times;</span>
        </div>
    </div>

    <div id="events-container"></div>
    <div id="noResultsContainer" style="display:none;text-align:center;padding:40px;color:var(--text-muted)">
        <div><div style="font-size:3rem;margin-bottom:10px">üì°</div><div style="font-weight:700;font-size:1.1rem;color:var(--text-main)">Sin resultados</div><div style="font-size:.85rem;margin-top:5px;opacity:.8">Intenta con otra b√∫squeda</div></div>
    </div>

    <div id="ids-modal" class="modal-overlay" onclick="UIManager.closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="modal-title" class="modal-title">Canales</div>
            <div id="ids-list" class="ids-list"></div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" id="nav-home" onclick='UIManager.switchTab("home")'><span class="nav-icon">üóìÔ∏è</span><span>EVENTOS</span></div>
        <div class="nav-item" id="nav-channels" onclick='UIManager.switchTab("channels")'><span class="nav-icon">üîç</span><span>BUSCAR</span></div>
    </nav>

    <script>
        // Registro del Service Worker para habilitar PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGV2ID0+IHsgZXZlbnQucmVzcG9uZFdpdGgoZmV0Y2goZXZlbnQucmVxdWVzdCkpOyB9KTs=')
                .catch(err => console.log('SW no registrado', err));
            });
        }

        const CONFIG = {
            BASE_URL: 'https://www.futbolenlatv.es',
            TARGET_URL: 'https://www.futbolenlatv.es/deporte',
            GIST_LOGOS: 'https://gist.githubusercontent.com/Ciento20/f7847e86d06e5011706fa76f2dab90be/raw/',
            PROXIES: [
                'https://api.allorigins.win/raw?url=',
                'https://api.codetabs.com/v1/proxy/?quest=',
                'https://corsproxy.io/?'
            ]
        };

        const STORAGE_CONFIG = {
            CACHE_KEY: 'ace_ids_cache',
            EXPIRATION_MS: 30 * 24 * 60 * 60 * 1000
        };

        const RatingEngine = {
            DB_KEY: 'ace_autorating_v1',
            SESSION_KEY: 'ace_current_session',
            PENDING_KEY: 'ace_pending_penalties_list',
            interval: null,

            getDB() { return JSON.parse(localStorage.getItem(this.DB_KEY)) || {}; },
            getScore(id) { return this.getDB()[id] || 3.0; },
            saveScore(id, delta) {
                if (delta < 0) return;
                const db = this.getDB();
                db[id] = Math.max(1.0, Math.min(5.0, (db[id] || 3.0) + delta));
                localStorage.setItem(this.DB_KEY, JSON.stringify(db));
            },
            trackStart(id, channelName, index = 0) {
                this.checkPreviousSession();
                const now = Date.now();
                this.stopRealTimeUpdate();
                const sessionData = { id, channelName, index, start: now, lastProcessedMin: 0 };
                localStorage.setItem(this.SESSION_KEY, JSON.stringify(sessionData));
                this.startRealTimeUpdate();
            },
            checkPreviousSession() {
                const session = JSON.parse(localStorage.getItem(this.SESSION_KEY));
                if (!session) return;
                const durationSec = (Date.now() - session.start) / 1000;
                if (durationSec < 90) {
                    const db = this.getDB();
                    db[session.id] = Math.max(1.0, (db[session.id] || 3.0) - 0.5);
                    localStorage.setItem(this.DB_KEY, JSON.stringify(db));
                    localStorage.setItem(this.PENDING_KEY, JSON.stringify({ id: session.id, timestamp: Date.now() }));
                } else {
                    localStorage.removeItem(this.PENDING_KEY);
                }
            },
            startRealTimeUpdate() {
                if (this.interval) clearInterval(this.interval);
                this.interval = setInterval(() => {
                    const session = JSON.parse(localStorage.getItem(this.SESSION_KEY));
                    if (!session) return this.stopRealTimeUpdate();
                    const min = (Date.now() - session.start) / 60000;
                    if (min >= 30 && (min - session.lastProcessedMin) >= 30) {
                        this.saveScore(session.id, 1.0);
                        session.lastProcessedMin = Math.floor(min / 30) * 30;
                        localStorage.setItem(this.SESSION_KEY, JSON.stringify(session));
                    }
                }, 30000);
            },
            stopRealTimeUpdate() { if (this.interval) clearInterval(this.interval); }
        };

        const cleanChannelName = (name) => {
            if (!name) return "";
            let rawUpper = name.toUpperCase();
            if (rawUpper.includes("ACB EVENTO 01")) name = "DAZN BALONCESTO";
            if (rawUpper.includes("ACB EVENTO 02")) name = "DAZN BALONCESTO 2";
            if (rawUpper.includes("M. DEPORTES")) name = "M+ DEPORTES";
            let cleaned = name.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            if (cleaned.includes("LIGA DE CAMPEONES") && !cleaned.includes("M+")) {
                cleaned = cleaned.replace("LIGA DE CAMPEONES", "M+ LIGA DE CAMPEONES");
            }
            cleaned = cleaned.replace(/PLUS\+/g, "PLUS").replace(/\bMOVISTAR\b/g, "M+").replace(/\bM\./g, "M+").replace(/\(ES\)/gi, "").replace(/\bLA LIGA\b/g, "LALIGA").replace(/\bHYPERMOTION\b/g, "LALIGA TV HYPERMOTION").replace(/\bBAR\b/gi, "").replace(/\b(HD|FHD|4K|1080P|720P)\b/gi, "").replace(/\*/g, "").replace(/\s+/g, " ").trim();
            if (cleaned.includes("CALCIO EVENTOS")) { cleaned = cleaned.replace("CALCIO EVENTOS", "SKY SPORTS CALCIO EVENTOS"); }
            if (cleaned.includes("(1RFEF) (SOLO EVENTOS)")) { cleaned = "PRIMERA FEDERACION"; }
            if (cleaned.includes("DAZN LALIGA")) { cleaned = cleaned.replace(/\b1\b/g, ""); }
            if (cleaned.includes("HYPERMOTION 2")) { cleaned = "LALIGA TV HYPERMOTION 2"; }
            else if (cleaned.includes("HYPERMOTION 3")) { cleaned = "LALIGA TV HYPERMOTION 3"; }
            else if (cleaned.includes("HYPERMOTION 4")) { cleaned = "LALIGA TV HYPERMOTION 4"; }
            else if (cleaned.includes("HYPERMOTION")) { cleaned = "LALIGA TV HYPERMOTION"; }
            return cleaned.replace(/\s+/g, " ").trim();
        };

        const ComparisonEngine = {
            isMatch(nameA, nameB) { return cleanChannelName(nameA) === cleanChannelName(nameB); },
            normalizeText(text) { return text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); }
        };

        let channelLogosMap = JSON.parse(localStorage.getItem('logo_cache')) || {};
        let globalData = JSON.parse(localStorage.getItem('event_data_cache')) || [];
        let aceStreamMap = []; 
        let currentTab = localStorage.getItem('active_tab') || 'home';
        const state = { tvSearchTerm: localStorage.getItem('search_query') || '' };

        const NetworkService = {
            async fetchHtml(targetUrl) {
                const fetchPromises = CONFIG.PROXIES.map(proxy => 
                    fetch(`${proxy}${encodeURIComponent(targetUrl)}`)
                        .then(res => { if (!res.ok) throw new Error(); return res.text(); })
                );
                try { return await Promise.any(fetchPromises); } 
                catch (e) { throw new Error("Error de conexi√≥n"); }
            },
            async fetchLogos() {
                try {
                    const response = await fetch(CONFIG.GIST_LOGOS);
                    const text = await response.text();
                    const map = {};
                    text.split('\n').forEach(line => {
                        if (line.includes(': http')) {
                            const parts = line.split(': http');
                            map[cleanChannelName(parts[0].trim())] = 'http' + parts[1].trim();
                        }
                    });
                    return map;
                } catch (e) { return {}; }
            }
        };

        const AceStreamEngine = {
            SOURCES: [
                { id: 'ERA', url: 'https://ipfs.io/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/listaplana.txt', parser: 'parseEra' },
                { id: 'ELCANO', url: 'https://acestream-ids.vercel.app/', parser: 'parseElcano' }
            ],
            generateHash(str){let hash=5381,i=str.length;while(i)hash=(hash*33)^str.charCodeAt(--i);return(hash>>>0).toString(16)},
            async init() {
                let masterMap = new Map();
                const cache = JSON.parse(localStorage.getItem(STORAGE_CONFIG.CACHE_KEY)) || { hashes: {}, data: [] };
                const currentHashes = cache.hashes || {};
                let hasChanges = false;
                cache.data.forEach(item => masterMap.set(item.id, item));
                for (const src of this.SOURCES) {
                    try {
                        const raw = await NetworkService.fetchHtml(src.url);
                        const newHash = this.generateHash(raw);
                        if (currentHashes[src.id] === newHash) continue;
                        hasChanges = true;
                        currentHashes[src.id] = newHash;
                        const parsed = src.parser === 'parseEra' ? this.parseEra(raw) : this.parseElcano(raw);
                        parsed.forEach(item => {
                            item.source = src.id === 'ELCANO' ? 'ELC' : 'ERA';
                            masterMap.set(item.id, item);
                        });
                    } catch (e) {}
                }
                const master = Array.from(masterMap.values());
                if (hasChanges && master.length > 0) { this.saveToCache(master, currentHashes); }
                return master.length > 0 ? master : this.loadFromCache();
            },
            saveToCache(data, hashes = {}) {
                localStorage.setItem(STORAGE_CONFIG.CACHE_KEY, JSON.stringify({ timestamp: Date.now(), data, hashes }));
            },
            loadFromCache() {
                const cached = localStorage.getItem(STORAGE_CONFIG.CACHE_KEY);
                if (!cached) return [];
                const cacheObj = JSON.parse(cached);
                return (Date.now() - cacheObj.timestamp) > STORAGE_CONFIG.EXPIRATION_MS ? [] : (cacheObj.data || []);
            },
            parseEra(text) {
                const results = [];
                const lines = text.split('\n').filter(l => l.trim());
                for (let i = 0; i < lines.length; i += 2) {
                    let name = lines[i].split('-->')[0].replace(/\b(HDP|SDP|FHDP)\b/gi, '').trim();
                    const id = lines[i+1]?.trim().replace(/p$/, '');
                    if (id && id.length === 40) results.push({ name, id });
                }
                return results;
            },
            parseElcano(html) {
                const jsonMatch = html.match(/const links\s*=\s*(\[[\s\S]*?\]);/);
                if (!jsonMatch) return [];
                try {
                    return JSON.parse(jsonMatch[1]).filter(l => l.url.includes('acestream://'))
                        .map(l => ({ name: l.name.trim(), id: l.url.split('://')[1] }));
                } catch (e) { return []; }
            }
        };

        const LiveEngine = {
            checkLive(event) {
                const fechaLimpia = event.fecha.toLowerCase();
                if (!fechaLimpia.includes("hoy") && !fechaLimpia.includes("directo")) return false;
                const now = new Date();
                const [hrs, mins] = event.hora.split(':').map(Number);
                const startTime = new Date(); startTime.setHours(hrs, mins, 0, 0);
                const searchPool = (event.competition + ' ' + event.infoHtml.replace(/<[^>]*>?/gm, '')).toUpperCase();
                const specificDurations = [
                    { key: 'F√ìRMULA 1', sub: 'LIBRES', duration: 75 }, { key: 'F√ìRMULA 1', sub: 'CLASIFICACI√ìN', duration: 85 },
                    { key: 'F√ìRMULA 1', sub: 'SPRINT', duration: 65 }, { key: 'F√ìRMULA 1', sub: 'CARRERA', duration: 145 },
                    { key: 'MOTOGP', sub: 'CARRERA', duration: 85 }, { key: 'LALIGA', duration: 115 }, { key: 'NBA', duration: 165 }
                ];
                let duration = 120;
                const match = specificDurations.find(d => searchPool.includes(d.key) && (!d.sub || searchPool.includes(d.sub)));
                if (match) duration = match.duration;
                const endTime = new Date(startTime.getTime() + duration * 60000);
                return now >= startTime && now <= endTime;
            }
        };

        const DataParser = {
            fixUrl(url) { return (!url || url.startsWith('http')) ? url : CONFIG.BASE_URL + (url.startsWith('/') ? '' : '/') + url; },
            parse(html) {
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const rows = doc.querySelectorAll('.tablaPrincipal tr');
                const results = [];
                let currentFecha = "";
                rows.forEach(row => {
                    if (row.classList.contains('cabeceraTabla')) {
                        currentFecha = row.textContent.trim().toUpperCase().replace(/PARTIDOS/gi, 'EVENTOS')
                            .replace(/,/g, ' &nbsp; ').replace(/(\d+)/g, '<span class="date-number">$1</span>')
                            .replace(/\b(EVENTOS|DE|HOY|MA√ëANA)\b/g, '<span style="color:var(--text-main); margin-right: 4px;">$1</span>');
                        return;
                    }
                    const hora = row.querySelector('.hora')?.textContent.trim();
                    if (!hora) return;
                    const compElem = row.querySelector('.detalles .ajusteDoslineas') || row.querySelector('.detalles label');
                    let competition = compElem?.title || compElem?.textContent || "Competici√≥n";
                    const sportImg = row.querySelector('.contenedorImgCompeticion img');
                    const sportName = (sportImg?.getAttribute('alt') || sportImg?.getAttribute('title') || '').toUpperCase();
                    const emojiMap = { 'F√öTBOL': '‚öΩ', 'BALONCESTO': 'üèÄ', 'TENIS': 'üéæ', 'AUTOMOVILISMO': 'üèÅ', 'F√ìRMULA 1': 'üèéÔ∏è', 'MOTOCICLISMO': 'üèçÔ∏è', 'UFC': 'üëä' };
                    let emoji = "üèÜ";
                    for (const [key, icon] of Object.entries(emojiMap)) { if (sportName.includes(key)) { emoji = icon; break; } }
                    const canales = Array.from(row.querySelectorAll('.listaCanales li')).map(ch => ch.textContent.trim().split('(')[0].trim());
                    const local = row.querySelector('.local span');
                    const visitante = row.querySelector('.visitante span');
                    const localImg = row.querySelector('.local img');
                    const visitanteImg = row.querySelector('.visitante img');
                    const eventoUnico = row.querySelector('.eventoUnico');
                    let infoHtml = local && visitante ? `<div class="vs-container"><div class="team-group"><img src="${this.fixUrl(localImg?.src)}" class="team-logo" onerror="this.style.display='none'"><span>${local.title || local.textContent}</span><span class="vs-text">VS</span></div><div class="team-group"><span>${visitante.title || visitante.textContent}</span><img src="${this.fixUrl(visitanteImg?.src)}" class="team-logo" onerror="this.style.display='none'"></div></div>` : `<div class="vs-container"><span>${eventoUnico?.innerText.trim() || ''}</span></div>`;
                    results.push({ fecha: currentFecha, hora, competition: emoji + " " + competition, infoHtml, canales });
                });
                return results;
            }
        };

        const UIManager = {
            container: document.getElementById('events-container'),
            status: document.getElementById('status'),
            modal: document.getElementById('ids-modal'),
            lastEventsHTML: '',

            switchTab(tab) {
                currentTab = tab;
                localStorage.setItem('active_tab', tab);
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.getElementById(`nav-${tab}`).classList.add('active');
                document.getElementById('searchContainer').style.display = (tab === 'channels') ? 'flex' : 'none';
                if (tab !== 'channels') { state.tvSearchTerm = ''; document.getElementById('globalSearchInput').value = ''; }
                this.refresh();
                window.scrollTo(0,0);
            },
            refresh() {
                globalData.forEach(item => item.isLive = LiveEngine.checkLive(item));
                const processed = [...globalData].sort((a, b) => (a.isLive === b.isLive) ? 0 : a.isLive ? -1 : 1);
                currentTab === 'home' && state.tvSearchTerm === '' && this.lastEventsHTML ? (this.container.innerHTML = this.lastEventsHTML) : (currentTab === 'home' ? this.renderEvents(processed) : this.renderUniqueChannels(processed));
            },
            renderEvents(data) {
                document.getElementById('noResultsContainer').style.display = 'none';
                const renderedList = data.map(item => ({ ...item, availableChannels: item.canales.filter(c => aceStreamMap.some(a => ComparisonEngine.isMatch(c, a.name))) })).filter(i => i.availableChannels.length > 0);
                let htmlBuffer = "", lastDate = "";
                renderedList.forEach((item, idx) => {
                    if (item.fecha !== lastDate) { htmlBuffer += `<div class="date-header">${item.fecha}</div>`; lastDate = item.fecha; }
                    const [h, m] = item.hora.split(':').map(Number);
                    const isPast = !item.isLive && (new Date() > new Date().setHours(h, m, 0, 0)) && item.fecha.toUpperCase().includes('HOY');
                    htmlBuffer += `<div class="event-card ${item.isLive ? 'is-live' : ''} ${isPast ? 'event-finished' : ''}"><div class="competicion-title">${item.competition}</div><div class="event-info"><span class="time">${item.hora}</span><span class="time-separator">|</span>${item.infoHtml}</div><div class="channels-wrapper">${item.availableChannels.map(c => this.getChannelHtml(c)).join('')}</div></div>`;
                });
                this.container.innerHTML = htmlBuffer;
                if (state.tvSearchTerm === '') this.lastEventsHTML = htmlBuffer;
            },
            renderUniqueChannels(data) {
                const searchTerm = state.tvSearchTerm;
                this.container.innerHTML = "";
                if (searchTerm) {
                    const matchedEvents = data.filter(e => ComparisonEngine.normalizeText(e.competition + e.infoHtml).includes(searchTerm));
                    if (matchedEvents.length > 0) { this.renderEvents(matchedEvents); this.container.innerHTML += '<hr style="border:0; border-top:1px solid #333; margin:20px 0; width:100%">'; }
                }
                const uniqueMap = new Map();
                aceStreamMap.filter(ace => !searchTerm || ComparisonEngine.normalizeText(ace.name).includes(searchTerm)).forEach(item => {
                    const clean = cleanChannelName(item.name); if (!uniqueMap.has(clean)) uniqueMap.set(clean, item.name);
                });
                if (uniqueMap.size === 0 && this.container.children.length === 0) { document.getElementById('noResultsContainer').style.display = 'block'; return; }
                document.getElementById('noResultsContainer').style.display = 'none';
                
                const sorted = Array.from(uniqueMap.values()).sort((a,b) => cleanChannelName(a).localeCompare(cleanChannelName(b)));
                this.container.innerHTML += `<div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; width:100%">${sorted.map(c => this.getChannelHtml(c)).join('')}</div>`;
            },
            getChannelHtml(name) {
                const clean = cleanChannelName(name);
                const logoUrl = channelLogosMap[clean];
                const matching = aceStreamMap.filter(a => ComparisonEngine.isMatch(name, a.name));
                if (matching.length === 0) return '';
                return `<div class="channel-button" onclick="UIManager.handleChannelClick(event, '${name.replace(/'/g, "\\'")}')" oncontextmenu="UIManager.openIdsModal(event, '${name.replace(/'/g, "\\'")}')">${logoUrl ? `<img src="${logoUrl}" class="channel-logo" onerror="this.outerHTML='<span>${clean}</span>'">` : `<span>${clean}</span>`}</div>`;
            },
            handleChannelClick(event, channelName) {
                const matching = aceStreamMap.filter(a => ComparisonEngine.isMatch(channelName, a.name)).sort((a, b) => RatingEngine.getScore(b.id) - RatingEngine.getScore(a.id));
                if (matching.length === 0) return;
                const lastIdxKey = 'last_idx_' + ComparisonEngine.normalizeText(channelName);
                const lastTimeKey = 'last_ts_' + ComparisonEngine.normalizeText(channelName);
                const lastIndex = parseInt(localStorage.getItem(lastIdxKey)) || 0;
                const nextIndex = (Date.now() - (parseInt(localStorage.getItem(lastTimeKey)) || 0) > 900000) ? 0 : (lastIndex + 1) % matching.length;
                localStorage.setItem(lastIdxKey, nextIndex);
                localStorage.setItem(lastTimeKey, Date.now());
                RatingEngine.trackStart(matching[nextIndex].id, channelName, nextIndex);
                window.location.href = 'acestream://' + matching[nextIndex].id;
            },
            openIdsModal(event, channelName) {
                event.preventDefault();
                const matching = aceStreamMap.filter(a => ComparisonEngine.isMatch(channelName, a.name)).sort((a, b) => RatingEngine.getScore(b.id) - RatingEngine.getScore(a.id));
                document.getElementById('modal-title').textContent = cleanChannelName(channelName);
                const list = document.getElementById('ids-list');
                list.innerHTML = "";
                matching.forEach((item, i) => {
                    const btn = document.createElement('div'); btn.className = 'id-item';
                    btn.innerHTML = `<small style="opacity:0.6">${item.source}</small><span>${item.id.substring(0, 10)}...</span><span class="id-rating">‚òÖ ${RatingEngine.getScore(item.id).toFixed(1)}</span>`;
                    btn.onclick = () => { RatingEngine.trackStart(item.id, channelName, i); window.location.href = `acestream://${item.id}`; };
                    list.appendChild(btn);
                });
                this.modal.style.display = 'flex';
            },
            closeModal() { this.modal.style.display = 'none'; }
        };

        async function init() {
            const gInput = document.getElementById('globalSearchInput');
            const cBtn = document.getElementById('clearSearch');
            UIManager.switchTab(currentTab);
            gInput.addEventListener('input', (e) => {
                cBtn.style.display = e.target.value ? 'block' : 'none';
                clearTimeout(window.sT);
                window.sT = setTimeout(() => { state.tvSearchTerm = ComparisonEngine.normalizeText(e.target.value); UIManager.refresh(); }, 150);
            });
            cBtn.addEventListener('click', () => { gInput.value = ''; state.tvSearchTerm = ''; cBtn.style.display = 'none'; UIManager.refresh(); });
            
            aceStreamMap = AceStreamEngine.loadFromCache();
            if (globalData.length > 0 || aceStreamMap.length > 0) { UIManager.refresh(); UIManager.status.style.display = 'none'; }
            
            try {
                const [logos, html] = await Promise.all([NetworkService.fetchLogos(), NetworkService.fetchHtml(CONFIG.TARGET_URL)]);
                if (logos) { channelLogosMap = logos; localStorage.setItem('logo_cache', JSON.stringify(logos)); }
                const freshData = DataParser.parse(html);
                if (freshData.length > 0) { globalData = freshData; localStorage.setItem('event_data_cache', JSON.stringify(freshData)); }
                aceStreamMap = await AceStreamEngine.init();
                UIManager.refresh();
                document.body.classList.add('loading-finished');
                UIManager.status.style.display = 'none';
            } catch (err) { document.body.classList.add('loading-finished'); }
        }
        init();
    </script>
</body>
</html>
